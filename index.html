<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Library Text-to-Speech</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 25px;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        select, textarea, button, input[type="range"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.3s;
        }
        select:focus, textarea:focus, input[type="range"]:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        textarea {
            height: 150px;
            resize: vertical;
            font-family: inherit;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
        }
        button:hover:not(:disabled) {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .audio-controls {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            display: none;
        }
        .audio-controls.active {
            display: block;
        }
        #audio-player {
            width: 100%;
            margin: 15px 0;
        }
        #download-link {
            display: inline-block;
            padding: 12px 25px;
            background-color: #2ecc71;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        #download-link:hover:not(.disabled) {
            background-color: #27ae60;
        }
        #download-link.disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            pointer-events: none;
        }
        .status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        .status.info {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        .status.success {
            background-color: #e8f5e9;
            color: #388e3c;
        }
        .status.error {
            background-color: #ffebee;
            color: #d32f2f;
        }
        .control-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .control-group label {
            flex: 0 0 100px;
            margin-bottom: 0;
        }
        .control-group input[type="range"] {
            flex: 1;
            margin-bottom: 0;
            padding: 0;
        }
        .control-group .value-display {
            flex: 0 0 50px;
            text-align: right;
            font-family: monospace;
            color: #7f8c8d;
        }
        .library-info {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Multi-Library Text-to-Speech</h1>
        
        <div class="section">
            <label for="library-select">Choose TTS Library:</label>
            <select id="library-select">
                <option value="speak-tts">speak-tts</option>
                <option value="responsive-voice">responsive-voice</option>
                <option value="web-speech">Web Speech API</option>
                <option value="web-speech-recorder">Web Speech API with Recording</option>
            </select>
            <p class="library-info" id="library-info">speak-tts: Wrapper around Web Speech API with additional features including direct audio export</p>
        </div>
        
        <div class="section">
            <label for="voice-select">Select Voice:</label>
            <select id="voice-select" disabled>
                <option value="">Loading voices...</option>
            </select>
            
            <div class="control-group">
                <label for="rate-slider">Speed:</label>
                <input type="range" id="rate-slider" min="0.5" max="2" step="0.1" value="1">
                <span class="value-display" id="rate-value">1.0</span>
            </div>
            
            <div class="control-group">
                <label for="pitch-slider">Pitch:</label>
                <input type="range" id="pitch-slider" min="0.5" max="2" step="0.1" value="1">
                <span class="value-display" id="pitch-value">1.0</span>
            </div>
        </div>
        
        <div class="section">
            <label for="text-input">Enter Text:</label>
            <textarea id="text-input" placeholder="Type or paste your text here..."></textarea>
            <button id="generate-btn" disabled>Generate Speech</button>
        </div>
        
        <div id="status-message" class="status info">Select a library and enter text to begin</div>
        
        <div id="audio-controls" class="audio-controls">
            <h3>Generated Audio</h3>
            <audio id="audio-player" controls></audio>
            <a id="download-link" href="#" class="disabled" download="speech.wav">Download Audio</a>
        </div>
    </div>

    <!-- Load external libraries -->
    <script src="https://cdn.jsdelivr.net/npm/speak-tts@3.0.0/dist/speak.min.js"></script>
    <script src="https://code.responsivevoice.org/responsivevoice.js"></script>
    
    <script>
        // DOM Elements
        const librarySelect = document.getElementById('library-select');
        const voiceSelect = document.getElementById('voice-select');
        const textInput = document.getElementById('text-input');
        const rateSlider = document.getElementById('rate-slider');
        const rateValue = document.getElementById('rate-value');
        const pitchSlider = document.getElementById('pitch-slider');
        const pitchValue = document.getElementById('pitch-value');
        const generateBtn = document.getElementById('generate-btn');
        const statusMessage = document.getElementById('status-message');
        const audioControls = document.getElementById('audio-controls');
        const audioPlayer = document.getElementById('audio-player');
        const downloadLink = document.getElementById('download-link');
        const libraryInfo = document.getElementById('library-info');

        // Library info texts
        const libraryInfoTexts = {
            'speak-tts': 'speak-tts: Wrapper around Web Speech API with additional features including direct audio export',
            'responsive-voice': 'responsive-voice: Provides more control over speech synthesis with multiple voice options',
            'web-speech': 'Web Speech API: Native browser implementation with basic functionality',
            'web-speech-recorder': 'Web Speech API with Recording: Extends native API with audio recording capability'
        };

        // TTS Instances
        const speakTTS = new SpeakTts();
        let currentLibrary = null;
        let audioContext;
        let mediaRecorder;
        let audioChunks = [];
        let currentUtterance = null;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Event listeners
            librarySelect.addEventListener('change', handleLibraryChange);
            rateSlider.addEventListener('input', updateRateValue);
            pitchSlider.addEventListener('input', updatePitchValue);
            generateBtn.addEventListener('click', generateSpeech);
            textInput.addEventListener('input', checkInputs);
            
            // Initialize values
            updateRateValue();
            updatePitchValue();
            
            // Initialize the first library
            handleLibraryChange();
        });

        function handleLibraryChange() {
            currentLibrary = librarySelect.value;
            libraryInfo.textContent = libraryInfoTexts[currentLibrary];
            
            // Reset UI
            voiceSelect.innerHTML = '<option value="">Loading voices...</option>';
            voiceSelect.disabled = true;
            generateBtn.disabled = true;
            audioControls.classList.remove('active');
            downloadLink.classList.add('disabled');
            downloadLink.removeAttribute('href');
            
            // Initialize the selected library
            switch(currentLibrary) {
                case 'speak-tts':
                    initSpeakTTS();
                    break;
                case 'responsive-voice':
                    initResponsiveVoice();
                    break;
                case 'web-speech':
                    initWebSpeech();
                    break;
                case 'web-speech-recorder':
                    initWebSpeechRecorder();
                    break;
            }
            
            checkInputs();
        }

        function updateRateValue() {
            rateValue.textContent = rateSlider.value;
        }

        function updatePitchValue() {
            pitchValue.textContent = pitchSlider.value;
        }

        function checkInputs() {
            const textValid = textInput.value.trim().length > 0;
            const voiceValid = voiceSelect.value || currentLibrary === 'responsive-voice';
            generateBtn.disabled = !(textValid && voiceValid);
        }

        // Library Initialization Functions
        function initSpeakTTS() {
            speakTTS.init({
                volume: 1,
                lang: 'en-US',
                rate: 1,
                pitch: 1,
                splitSentences: true,
                listeners: {
                    onvoiceschanged: (voices) => {
                        populateVoiceSelect(voices);
                    }
                }
            }).then(() => {
                updateStatus('speak-tts initialized successfully', 'success');
            }).catch(e => {
                updateStatus('Failed to initialize speak-tts: ' + e.message, 'error');
            });
        }

        function initResponsiveVoice() {
            // ResponsiveVoice auto-initializes
            updateStatus('responsive-voice ready', 'success');
            
            // Populate with responsive-voice voices
            const voices = [
                { name: 'US English Female', lang: 'en-US' },
                { name: 'UK English Female', lang: 'en-GB' },
                { name: 'US English Male', lang: 'en-US' },
                { name: 'Spanish Female', lang: 'es-ES' }
            ];
            
            populateVoiceSelect(voices);
        }

        function initWebSpeech() {
            if (!window.speechSynthesis) {
                updateStatus('Web Speech API not supported in this browser', 'error');
                return;
            }
            
            // Wait for voices to load
            speechSynthesis.onvoiceschanged = function() {
                populateVoiceSelect(speechSynthesis.getVoices());
            };
            
            // Try to get voices immediately
            const voices = speechSynthesis.getVoices();
            if (voices.length > 0) {
                populateVoiceSelect(voices);
            }
            
            updateStatus('Web Speech API ready', 'success');
        }

        function initWebSpeechRecorder() {
            if (!window.speechSynthesis || !window.MediaRecorder) {
                updateStatus('Web Speech API or MediaRecorder not supported', 'error');
                return;
            }
            
            // Wait for voices to load
            speechSynthesis.onvoiceschanged = function() {
                populateVoiceSelect(speechSynthesis.getVoices());
            };
            
            // Try to get voices immediately
            const voices = speechSynthesis.getVoices();
            if (voices.length > 0) {
                populateVoiceSelect(voices);
            }
            
            updateStatus('Web Speech API with Recording ready', 'success');
        }

        function populateVoiceSelect(voices) {
            voiceSelect.innerHTML = '';
            
            if (!voices || voices.length === 0) {
                voiceSelect.innerHTML = '<option value="">No voices available</option>';
                voiceSelect.disabled = true;
                return;
            }
            
            // Group voices by language
            const voiceGroups = {};
            voices.forEach(voice => {
                const lang = voice.lang || 'unknown';
                if (!voiceGroups[lang]) {
                    voiceGroups[lang] = [];
                }
                voiceGroups[lang].push(voice);
            });
            
            // Add options grouped by language
            for (const lang in voiceGroups) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = lang;
                
                voiceGroups[lang].forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name || voice.voiceName || voice.voiceURI;
                    option.textContent = voice.name || voice.voiceName || voice.voiceURI;
                    optgroup.appendChild(option);
                });
                
                voiceSelect.appendChild(optgroup);
            }
            
            voiceSelect.disabled = false;
            checkInputs();
        }

        // Speech Generation Functions
        async function generateSpeech() {
            const text = textInput.value.trim();
            const voice = voiceSelect.value;
            const rate = parseFloat(rateSlider.value);
            const pitch = parseFloat(pitchSlider.value);
            
            // Reset UI
            audioControls.classList.remove('active');
            downloadLink.classList.add('disabled');
            downloadLink.removeAttribute('href');
            generateBtn.disabled = true;
            updateStatus('Generating speech...', 'info');
            
            try {
                switch(currentLibrary) {
                    case 'speak-tts':
                        await generateWithSpeakTTS(text, voice, rate, pitch);
                        break;
                    case 'responsive-voice':
                        await generateWithResponsiveVoice(text, voice, rate, pitch);
                        break;
                    case 'web-speech':
                        await generateWithWebSpeech(text, voice, rate, pitch);
                        break;
                    case 'web-speech-recorder':
                        await generateWithWebSpeechRecorder(text, voice, rate, pitch);
                        break;
                }
            } catch (e) {
                updateStatus('Error: ' + e.message, 'error');
                generateBtn.disabled = false;
                console.error(e);
            }
        }

        async function generateWithSpeakTTS(text, voice, rate, pitch) {
            speakTTS.setVoice(voice);
            speakTTS.setRate(rate);
            speakTTS.setPitch(pitch);
            
            const audioBlob = await speakTTS.synthesize({
                text: text,
                exportAudio: true
            });
            
            const audioUrl = URL.createObjectURL(audioBlob);
            setupAudioPlayer(audioUrl);
            updateStatus('Speech generated successfully', 'success');
        }

        async function generateWithResponsiveVoice(text, voice, rate, pitch) {
            return new Promise((resolve, reject) => {
                // ResponsiveVoice doesn't support direct audio export, so we'll use the player
                responsiveVoice.speak(text, voice, {
                    rate: rate,
                    pitch: pitch,
                    onstart: function() {
                        updateStatus('Speaking...', 'info');
                    },
                    onend: function() {
                        // Since we can't get the audio blob directly, we'll enable the player
                        // but disable download for this library
                        audioPlayer.src = '';
                        audioControls.classList.add('active');
                        downloadLink.classList.add('disabled');
                        updateStatus('Speech complete (download not supported with responsive-voice)', 'info');
                        resolve();
                    },
                    onerror: function(error) {
                        reject(new Error('ResponsiveVoice error: ' + error));
                    }
                });
            });
        }

        async function generateWithWebSpeech(text, voice, rate, pitch) {
            return new Promise((resolve, reject) => {
                const utterance = new SpeechSynthesisUtterance(text);
                const selectedVoice = speechSynthesis.getVoices().find(v => v.name === voice);
                
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                }
                
                utterance.rate = rate;
                utterance.pitch = pitch;
                
                utterance.onstart = function() {
                    updateStatus('Speaking...', 'info');
                };
                
                utterance.onend = function() {
                    // Web Speech API doesn't provide audio data directly
                    audioPlayer.src = '';
                    audioControls.classList.add('active');
                    downloadLink.classList.add('disabled');
                    updateStatus('Speech complete (download not supported with basic Web Speech API)', 'info');
                    resolve();
                };
                
                utterance.onerror = function(event) {
                    reject(new Error('Speech synthesis error: ' + event.error));
                };
                
                speechSynthesis.speak(utterance);
            });
        }

        async function generateWithWebSpeechRecorder(text, voice, rate, pitch) {
            // First, set up audio recording
            await setupAudioRecording();
            
            return new Promise((resolve, reject) => {
                const utterance = new SpeechSynthesisUtterance(text);
                const selectedVoice = speechSynthesis.getVoices().find(v => v.name === voice);
                
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                }
                
                utterance.rate = rate;
                utterance.pitch = pitch;
                
                utterance.onstart = function() {
                    updateStatus('Speaking and recording...', 'info');
                };
                
                utterance.onend = function() {
                    setTimeout(() => {
                        stopRecording();
                        updateStatus('Speech recorded successfully', 'success');
                        resolve();
                    }, 500); // Small delay to capture all audio
                };
                
                utterance.onerror = function(event) {
                    stopRecording();
                    reject(new Error('Speech synthesis error: ' + event.error));
                };
                
                speechSynthesis.speak(utterance);
            });
        }

        // Audio Recording Functions (for Web Speech Recorder)
        async function setupAudioRecording() {
            try {
                audioChunks = [];
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const dest = audioContext.createMediaStreamDestination();
                mediaRecorder = new MediaRecorder(dest.stream);
                
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        audioChunks.push(e.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    setupAudioPlayer(audioUrl);
                };
                
                mediaRecorder.start();
                
                // Create a silent source to keep the stream active
                const oscillator = audioContext.createOscillator();
                oscillator.frequency.value = 0.1;
                const gainNode = audioContext.createGain();
                gainNode.gain.value = 0;
                
                oscillator.connect(gainNode);
                gainNode.connect(dest);
                oscillator.start();
                
                return true;
            } catch (e) {
                console.error('Recording setup failed:', e);
                updateStatus('Recording setup failed', 'error');
                return false;
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            if (audioContext) {
                audioContext.close();
            }
        }

        function setupAudioPlayer(audioUrl) {
            audioPlayer.src = audioUrl;
            downloadLink.href = audioUrl;
            downloadLink.classList.remove('disabled');
            audioControls.classList.add('active');
            generateBtn.disabled = false;
        }

        function updateStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = 'status ' + type;
        }
    </script>
</body>
</html>
