<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Course Creator Fun Zone!</title> <!-- Kid-friendly Title -->

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">

<!-- Font Awesome for Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
    /* --- Base Styles - K12 Redesign --- */
    :root {
        /* Playful Color Palette */
        --primary: #29B6F6;    /* Light Blue */
        --secondary: #FFCA28;  /* Amber/Yellow */
        --accent: #FF7043;     /* Deep Orange */
        --light: #F4F8FB;      /* Very Light Blue/Gray */
        --dark: #455A64;       /* Blue Gray */
        --success: #66BB6A;    /* Green */
        --danger: #EF5350;     /* Red */
        --white: #FFFFFF;
        --medium-gray: #B0BEC5; /* For borders/disabled state */

        /* Fonts */
        --base-font-family: 'Quicksand', sans-serif; /* Friendly sans-serif */
        --heading-font-family: 'Nunito', sans-serif; /* Slightly bolder, rounded */
        --base-font-size: 17px; /* Slightly larger default */

        /* Shapes & Transitions */
        --border-radius-small: 8px;
        --border-radius-medium: 15px;
        --border-radius-large: 25px;
        --border-radius-round: 50%;
        --transition-speed: 0.3s;
        --transition-ease: ease-in-out;

        /* Shadows (Softer) */
        --shadow-soft: 0 4px 10px rgba(0, 0, 0, 0.06);
        --shadow-medium: 0 6px 15px rgba(0, 0, 0, 0.1);
        --shadow-large: 0 8px 25px rgba(0, 0, 0, 0.12);
    }
    html { scroll-behavior: smooth; box-sizing: border-box; font-size: var(--base-font-size); }
    *, *:before, *:after { box-sizing: inherit; }
    body {
        font-family: var(--base-font-family);
        margin: 0;
        padding: 0;
        background-color: var(--light);
        color: var(--dark);
        line-height: 1.7; /* Increased line height */
        transition: background-color var(--transition-speed) var(--transition-ease), color var(--transition-speed) var(--transition-ease);
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 25px 15px; } /* Slightly less max-width, more padding */
    h1, h2, h3, h4, h5, h6 { font-family: var(--heading-font-family); font-weight: 700; margin-top: 0; }
    h2 { color: var(--primary); border-bottom: 4px solid var(--secondary); padding-bottom: 10px; display: inline-block; font-size: 1.6rem; margin-bottom: 30px; transition: color var(--transition-speed) var(--transition-ease), border-color var(--transition-speed) var(--transition-ease); font-weight: 800; letter-spacing: 0.5px;}
    h3 { color: var(--dark); margin-top: 35px; margin-bottom: 18px; font-size: 1.3rem; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

    /* --- Header Styles (Generic for Course/Project) - Kid Redesign --- */
    .page-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        margin-bottom: 40px; /* More space */
        background: linear-gradient(135deg, var(--primary), var(--accent)); /* New gradient */
        color: var(--white);
        padding: 30px 25px;
        border-radius: var(--border-radius-large);
        box-shadow: var(--shadow-medium);
        text-align: center;
        position: relative;
        transition: background var(--transition-speed) var(--transition-ease);
    }
    .page-header img.header-image { /* Common class for header images */
        width: 130px; /* Default size */
        height: 130px;
        object-fit: cover;
        border-radius: var(--border-radius-round); /* Circular image */
        border: 5px solid var(--white);
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    .page-header .header-title-container { flex-grow: 1; }
    .page-header .header-title { color: var(--white); margin: 0 0 5px 0; font-size: 2.2rem; font-weight: 800; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
    .page-header .header-subtitle { color: rgba(255, 255, 255, 0.9); font-size: 1.1rem; margin: 0; font-family: var(--base-font-family); font-weight: 500; }

    /* --- Edit/Export/Back Buttons - Kid Redesign --- */
    .edit-btn, .export-btn, .back-btn {
        position: absolute;
        top: 20px;
        background-color: rgba(255, 255, 255, 0.2);
        color: var(--white);
        border: 2px solid rgba(255, 255, 255, 0.5);
        width: 48px; /* Larger */
        height: 48px;
        border-radius: var(--border-radius-round); /* Round */
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px; /* Icon size */
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
        z-index: 10;
        text-decoration: none;
    }
    .edit-btn:hover, .export-btn:hover, .back-btn:hover { background-color: rgba(255, 255, 255, 0.4); transform: scale(1.1) rotate(5deg); box-shadow: 0 6px 12px rgba(0,0,0,0.2); }
    /* Positions */
    #course-view .page-header .edit-btn { right: 25px; }
    #course-view .page-header .export-btn { right: 85px; } /* ONLY on course header */
    #project-view .page-header .edit-btn { right: 25px; }
    #project-view .page-header .back-btn { right: 85px; font-size: 22px; /* Keep arrow size reasonable */}

    /* --- Course View Specific Styles - Kid Redesign --- */
    #course-view { animation: fadeIn 0.6s var(--transition-ease); }
    #course-description-container {
        background-color: var(--white);
        padding: 30px 35px; /* Generous padding */
        border-radius: var(--border-radius-medium);
        box-shadow: var(--shadow-soft);
        margin-bottom: 40px;
        font-size: 1.1rem; /* Slightly larger text */
        line-height: 1.8;
    }
     #course-description-container h2 { margin-bottom: 20px; font-size: 1.5rem;} /* H2 inside description */

    #projectGrid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); /* Slightly larger min */
        gap: 30px; /* Increased gap */
        margin-top: 25px;
    }
    .project-tab {
        background-color: var(--white);
        border-radius: var(--border-radius-medium);
        box-shadow: var(--shadow-medium);
        overflow: hidden;
        cursor: pointer;
        transition: transform var(--transition-speed) var(--transition-ease), box-shadow var(--transition-speed) var(--transition-ease);
        display: flex;
        flex-direction: column;
        text-decoration: none;
        color: inherit;
        position: relative; /* For completion tick */
        border: 3px solid transparent; /* For hover effect */
    }
    .project-tab:hover {
        transform: translateY(-8px) rotate(1deg); /* More playful lift */
        box-shadow: var(--shadow-large);
        border-color: var(--secondary); /* Highlight with secondary color */
    }
    .project-tab img {
        width: 100%;
        height: 220px; /* Taller image */
        object-fit: cover;
        display: block;
        border-bottom: 3px solid var(--light); /* Subtle separator */
    }
    .project-tab-info {
        padding: 25px 20px; /* Increased padding */
        text-align: center;
        background-color: var(--white); /* Ensure solid background */
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 70px; /* Ensure space for text */
    }
    .project-tab-info span {
        font-family: var(--heading-font-family);
        font-weight: 700; /* Bolder */
        color: var(--primary);
        font-size: 1.2rem; /* Larger */
        transition: color var(--transition-speed) var(--transition-ease);
    }
    .completion-tick {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 36px; /* Larger */
        height: 36px;
        background-color: var(--success);
        color: white;
        border-radius: var(--border-radius-round); /* Round */
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px; /* Icon size */
        font-weight: bold;
        line-height: 1;
        box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        z-index: 5;
        border: 2px solid white;
    }
     .completion-tick i { line-height: 1; } /* Ensure font awesome icon centers */

    /* --- Project View Specific Styles - Kid Redesign --- */
    #project-view {
        /* Project specific font/size applied here via JS */
        animation: fadeIn 0.6s var(--transition-ease);
    }
    /* Slightly smaller image for project header, keep round */
    #project-view .page-header .header-image { width: 110px; height: 110px; border-radius: var(--border-radius-round); }
    #project-view .page-header .header-title { font-size: 2rem; }
    #project-view .page-header .header-subtitle { font-size: 1.05rem; }

    /* --- Styling for project content - Kid Redesign --- */
    .progress-container{width:100%;background-color:#e0e4e7;border-radius:var(--border-radius-large);margin:35px 0;height:18px;overflow:hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);} /* Thicker, inset shadow */
    .progress-bar{height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));border-radius:var(--border-radius-large);width:0%;transition:width .5s ease-in-out, background var(--transition-speed) var(--transition-ease)} /* Gradient progress */
    #projectTabs { /* Target specifically */
        display:flex;gap:15px;margin-bottom:25px;overflow-x:auto;padding-bottom:10px;-webkit-overflow-scrolling:touch; border-bottom: 2px solid var(--medium-gray); /* Add separator line */
    }
    #projectTabs::-webkit-scrollbar{height:6px;background-color:#e0e4e7;border-radius:3px;} /* Slightly thicker scrollbar */
    #projectTabs::-webkit-scrollbar-thumb{background-color:var(--secondary);border-radius:3px;}
    #projectTabs .tab{ /* Target specifically */
        padding:12px 28px; /* More padding */
        background-color:var(--white);
        border-radius:var(--border-radius-medium) var(--border-radius-medium) 0 0; /* Rounded top corners */
        cursor:pointer;
        font-weight:700;
        font-family: var(--heading-font-family);
        box-shadow: var(--shadow-soft);
        white-space:nowrap;
        font-size:1.05rem; /* Larger text */
        flex-shrink:0;
        transition:background-color .3s,color .3s,transform .2s, box-shadow .3s, border-color .3s;
        border: 2px solid var(--medium-gray);
        border-bottom: none; /* Remove bottom border */
        color: var(--dark);
        transform: translateY(2px); /* Sit slightly below line */
        position: relative;
        z-index: 1;
    }
    #projectTabs .tab.active{
        background-color:var(--primary);
        color:var(--white);
        transform:translateY(0px); /* Align with top */
        box-shadow: var(--shadow-medium);
        border-color: var(--primary);
        z-index: 2; /* Bring active tab forward */
    }
    #projectTabs .tab:hover:not(.active){
        background-color:#E3F2FD; /* Light blue hover */
        transform:translateY(0px);
        border-color: var(--primary);
        box-shadow: var(--shadow-medium);
         color: var(--primary);
    }
    #projectTabContentContainer .tab-content{ /* Target specifically */
        display:none;background-color:var(--white);padding:35px 30px;border-radius:0 var(--border-radius-medium) var(--border-radius-medium) var(--border-radius-medium); /* Match tab rounding */ box-shadow:var(--shadow-medium);animation:fadeIn .5s ease-out;margin-bottom:30px; border: 2px solid var(--medium-gray); border-top: none; /* Border connects to tabs */ margin-top: -2px; /* Overlap border */
    }
     #projectTabContentContainer .tab-content h2 { font-size: 1.5rem; margin-bottom: 25px; font-weight: 800;} /* H2 inside tab content */
    #projectTabContentContainer .tab-content.active{display:block}

    .video-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;margin:25px 0;border-radius:var(--border-radius-medium);box-shadow:var(--shadow-medium)}
    .video-container iframe{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:var(--border-radius-medium);border:none}

    /* Slideshow - Kid Redesign */
    .slide{display:none;text-align:center}
    .slideshow{position:relative;margin:25px 0;background-color: var(--light); /* Lighter bg */ padding:25px;border-radius:var(--border-radius-medium); border: 2px dashed var(--medium-gray);}
    .slide-content-wrapper{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;margin:0 auto 20px;max-width:100%;background-color:var(--white);border-radius:var(--border-radius-medium); box-shadow: var(--shadow-soft)}
    .slide iframe,.slide img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;border-radius:var(--border-radius-medium);background-color:transparent; border: none;}
    .slide p{margin:20px 0 0;font-size:1rem;color:var(--dark); font-weight: 600;} /* Bolder caption */
    .slide.active{display:block;animation:fadeIn .5s}
    .slide-nav { text-align: center; margin-top: 25px; display: flex; justify-content: center; gap: 25px; } /* Centered nav */
    .slide-nav button{background-color:var(--secondary);color:var(--dark);border:none;padding:12px 25px;border-radius:var(--border-radius-large);cursor:pointer;font-size:1.1rem;transition:background-color .3s,transform .2s, box-shadow .3s; box-shadow: var(--shadow-soft); font-weight: 700; font-family: var(--heading-font-family);}
    .slide-nav button:hover{background-color:#FFB74D; /* Lighter orange */ transform:scale(1.08) rotate(-3deg); box-shadow: var(--shadow-medium);}
    .slide-nav button i { margin: 0 8px; } /* Space icons */

    /* Steps (Learn, Challenges) - Kid Redesign */
    .step{display:flex;gap:25px;margin-bottom:30px;padding:25px;background-color:var(--white);border-radius:var(--border-radius-medium);align-items:flex-start;border-left:8px solid var(--secondary);box-shadow:var(--shadow-soft); transition: border-color var(--transition-speed) var(--transition-ease); }
    #challengesContainer .step { border-left-color: var(--accent); } /* Different border for challenges */

    .step-number{background-color:var(--secondary);color:var(--white);min-width:45px;height:45px;border-radius:var(--border-radius-round);display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;font-size:1.2rem;margin-top:5px; transition: background-color var(--transition-speed) var(--transition-ease); box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
    #challengesContainer .step-number { background-color: var(--accent); } /* Match challenge border */
    .step-number i { line-height: 1; } /* Center Font Awesome icon if used */

    .step-content{flex:1;display:flex;flex-direction:column}
    .step-content strong{font-size:1.2rem;color:var(--primary);display:block;margin-bottom:10px; transition: color var(--transition-speed) var(--transition-ease); font-weight: 700;}
    .step-content p.description{margin:0 0 18px;font-size:1.05rem;color:var(--dark);line-height:1.7}
    .step-content p.description:last-child{margin-bottom:0}
    .step-content .step-media{margin-top:18px;max-width:100%;width:100%;overflow:hidden;border-radius:var(--border-radius-medium);background-color:#f0f0f0}
    .step-content .step-media img, .step-content .step-media iframe {display:block;max-width:100%;height:auto;border-radius:var(--border-radius-medium);box-shadow:var(--shadow-soft); border: none; aspect-ratio: 16/9;}


    /* Quiz Styling - Kid Redesign */
    .quiz-question{background-color:var(--light);padding:30px;margin-bottom:25px;border-radius:var(--border-radius-medium);box-shadow:none;border:2px dashed var(--medium-gray)} /* Dashed border box */
    .quiz-question p.question-text{margin:0 0 25px;font-size:1.15rem;font-weight:700;color:var(--dark); line-height: 1.5;}
    .quiz-options{margin-top:20px;display:grid; grid-template-columns: 1fr; gap:15px;} /* Single column grid */
    .quiz-option{display:flex; align-items: center; gap: 12px; padding:18px 22px;margin-bottom:0;background-color:var(--white);border:2px solid var(--medium-gray);border-radius:var(--border-radius-medium);cursor:pointer;transition:all .3s ease;font-size:1.05rem;position:relative;text-align:left;opacity:1; font-weight: 600; box-shadow: var(--shadow-soft);}
    .quiz-option:hover{background-color:#E3F2FD;border-color:var(--primary);transform:translateX(5px); box-shadow: var(--shadow-medium);}
    .quiz-option.selected{border-color:var(--primary);background-color:#BBDEFB; /* Lighter blue selected */ box-shadow: var(--shadow-medium); transform: translateX(5px);}
    /* Add icons for feedback */
    .quiz-option::before { font-family: "Font Awesome 6 Free"; font-weight: 900; font-size: 1.2em; width: 20px; text-align: center; display: inline-block; transition: opacity 0.3s; opacity: 0; margin-right: 8px;}
    .quiz-question.answered .quiz-option.correct::before { content: '\f00c'; color: var(--success); opacity: 1;} /* Check */
    .quiz-question.answered .quiz-option.incorrect.selected::before { content: '\f00d'; color: var(--danger); opacity: 1;} /* Times */

    .quiz-option.correct{background-color:var(--success);color:var(--white);border-color:var(--success);font-weight:700}
    .quiz-option.correct.selected{background-color:var(--success);color:var(--white);border-color:#4CAF50;} /* Slightly darker green border */
    .quiz-option.incorrect.selected{background-color:var(--danger);color:var(--white);border-color:var(--danger);font-weight:700;text-decoration: line-through wavy rgba(255,255,255,0.7) 2px; border-color:#D32F2F !important} /* Wavy line-through */
    .quiz-question.answered .quiz-option { cursor:default; }
    .quiz-question.answered .quiz-option:not(.selected):not(.correct){opacity:.7; background-color:var(--white); border-color:var(--medium-gray); text-decoration:none; transform: none; box-shadow: var(--shadow-soft);}
    .quiz-question.answered .quiz-option.correct:not(.selected){opacity:1} /* Ensure correct answer is fully visible */
    .quiz-question.answered .quiz-option:hover { transform: none; box-shadow: var(--shadow-soft); } /* Disable hover effect when answered */


    .quiz-feedback{margin-top:20px;padding:15px 20px;border-radius:var(--border-radius-medium);display:none;font-size:1rem;border-width:2px;border-style:solid; font-weight: 700; display: flex; align-items: center; gap: 10px;}
    .quiz-feedback i { font-size: 1.3em; } /* Larger feedback icons */
    .quiz-feedback.correct{background-color:#E8F5E9;color:#2E7D32;border-color:var(--success)}
    .quiz-feedback.incorrect{background-color:#FFEBEE;color:#C62828;border-color:var(--danger)}
    /* Add icons to feedback text */
    .quiz-feedback.correct::before { content: '\f058'; font-family: "Font Awesome 6 Free"; font-weight: 900; margin-right: 10px; font-size: 1.3em;} /* Check circle */
    .quiz-feedback.incorrect::before { content: '\f071'; font-family: "Font Awesome 6 Free"; font-weight: 900; margin-right: 10px; font-size: 1.3em;} /* Exclamation triangle */

    .final-quiz-result{margin-top:30px;padding:25px;border-radius:var(--border-radius-medium);text-align:center;font-weight:700;font-size:1.25rem; border: 3px solid; display: flex; flex-direction: column; align-items: center; gap: 15px;}
    .final-quiz-result .result-icon { font-size: 3rem; }
    .final-quiz-result.success{background-color:#E8F5E9;color:#2E7D32;border-color:var(--success)}
    .final-quiz-result.fail{background-color:#FFEBEE;color:#C62828;border-color:var(--danger)}

    .submit-btn{background-color:var(--accent);color:var(--white);border:none;padding:18px 40px;border-radius:var(--border-radius-large);font-weight:700;cursor:pointer;margin-top:35px;font-size:1.2rem;transition:all .3s;display:block;width:100%;max-width:320px;margin-left:auto;margin-right:auto;box-shadow:var(--shadow-medium); font-family: var(--heading-font-family); letter-spacing: 1px; text-transform: uppercase;}
    .submit-btn:hover:not(:disabled){background-color:#FF8A65; /* Lighter accent */ box-shadow:var(--shadow-large);transform:translateY(-4px) scale(1.03);}
    .submit-btn:disabled{background-color:var(--medium-gray);color:#78909C;cursor:not-allowed;box-shadow:none;transform:none;opacity:.8}

    /* --- Modal Styles - Kid Redesign --- */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(69, 90, 100, 0.8); /* Darker backdrop using dark color */ z-index:1000;overflow-y:auto;padding:50px 15px} /* More padding */
    .modal-content{background-color:var(--white);margin:50px auto;padding:40px 45px;border-radius:var(--border-radius-large);width:90%;max-width:800px;box-shadow:var(--shadow-large);position:relative}
    .close-modal{position:absolute;top:15px;right:15px; width: 40px; height: 40px; border-radius: var(--border-radius-round); background-color: var(--medium-gray); color: var(--white); display: flex; align-items: center; justify-content: center; font-size:20px;font-weight:700;cursor:pointer;line-height:1;z-index:1001;padding:0;transition: background-color 0.3s, transform 0.2s;}
    .close-modal:hover{background-color:var(--danger); transform: scale(1.1) rotate(90deg);}
     .modal h2 { margin-bottom: 30px; text-align: center; font-size: 1.8rem; color: var(--primary); font-weight: 800;}
    .edit-form{margin-top:30px}
    .edit-form label{display:block;margin-bottom:8px;font-weight:700;color:var(--primary);font-size:1rem}
    .edit-form input[type=text],.edit-form input[type=url],.edit-form textarea,.edit-form select{width:100%;padding:15px;margin-bottom:20px;border:2px solid var(--medium-gray);border-radius:var(--border-radius-medium);font-size:1rem;box-sizing:border-box; transition: border-color 0.3s, box-shadow 0.3s; font-family: var(--base-font-family);}
    .edit-form input:focus, .edit-form textarea:focus, .edit-form select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(var(--primary-rgb, 41, 182, 246), 0.3); }
    .edit-form textarea{resize:vertical;min-height:100px}

    /* Buttons inside modals - Kid Redesign */
    .edit-form button, button.remove-item-btn, button.add-item-btn{
         background-color: var(--primary); color: var(--white); border: none; padding: 12px 22px; border-radius: var(--border-radius-medium);
         cursor: pointer; margin-right: 12px; margin-top: 10px; font-size: 1rem; font-weight: 700; transition: background-color .3s, transform 0.2s, box-shadow 0.3s; box-shadow: var(--shadow-soft); font-family: var(--heading-font-family);
    }
    .edit-form button:hover, button.remove-item-btn:hover, button.add-item-btn:hover{ background-color: #039BE5; /* Darker Primary */ transform: translateY(-2px); box-shadow: var(--shadow-medium); }
    /* Save/Cancel specifically */
    .modal-actions { margin-top: 35px; text-align: right; border-top: 2px solid var(--light); padding-top: 25px; }
    .modal-actions button { display: inline-block; min-width: 120px; /* Ensure decent button size */ }
    .modal-actions button[type=submit], .modal-actions button[onclick^="save"] { background-color: var(--success); } /* Target save buttons */
    .modal-actions button[type=submit]:hover, .modal-actions button[onclick^="save"]:hover { background-color: #4CAF50; /* Darker Success */ }
    .modal-actions button[onclick^="closeModal"] { background-color: var(--medium-gray); margin-right: 0; color: var(--dark);}
    .modal-actions button[onclick^="closeModal"]:hover { background-color: #90A4AE; /* Darker medium gray */ }

    button.remove-item-btn{background-color:var(--danger);margin-left:10px;font-weight:700;line-height:1;padding:0; width: 36px; height: 36px; font-size: 1rem; display: flex; align-items: center; justify-content: center; box-shadow: none; border-radius: var(--border-radius-round); color: var(--white);}
    button.remove-item-btn:hover{background-color:#E53935; /* Darker Danger */ transform: scale(1.15) rotate(10deg);}
    button.add-item-btn{background-color:var(--success);display:inline-flex; /* Use flex */ align-items: center; gap: 8px; margin-top:20px;margin-left:0;margin-right:0;width:fit-content; padding: 12px 25px; border-radius: var(--border-radius-large);}
    button.add-item-btn:hover{background-color:#4CAF50; /* Darker Success */}
    button.add-item-btn i { font-size: 1.1em; }

    .edit-section{margin-top:30px;padding-top:25px;border-top:2px dashed var(--medium-gray)}
    .edit-item-group{margin-bottom:30px;padding:25px;border:2px solid var(--light);border-radius:var(--border-radius-medium);background-color:var(--white);position:relative; box-shadow: var(--shadow-soft);}
    .edit-item-group .remove-item-btn{position:absolute;top:10px;right:10px;}
    .edit-item-group>label {font-weight:700;color:var(--dark);font-size:1.1rem;margin-top:5px; display: block; margin-bottom: 15px;} /* Bold top-level label */
    .edit-item-group label{font-weight:600;color:#546E7A;font-size:.95rem} /* Default labels inside group */
    .edit-item-group input[type=text],.edit-item-group input[type=url],.edit-item-group textarea,.edit-item-group select{margin-bottom:15px; padding: 12px;} /* Adjust padding inside group */
    .media-controls{margin-top:15px;padding-top:15px;border-top:1px solid var(--light)}
    .media-controls label{font-weight:600;color:#546E7A;font-size:.95rem}
    .media-url-input-container { margin-top: 10px; } /* Container for URL input */
    .incorrect-answer-label{font-size:.95rem;color:#78909C;margin-top:12px;font-weight:600}

    /* Style Editor Sections (Color, Font, Size) - Kid Redesign */
    .color-picker { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .color-option { width: 38px; height: 38px; border-radius: var(--border-radius-round); cursor: pointer; border: 3px solid var(--medium-gray); transition: transform .2s, border-color .2s, box-shadow .2s; box-shadow: var(--shadow-soft); }
    .color-option.selected { border: 4px solid var(--dark); transform: scale(1.2); box-shadow: var(--shadow-medium); }
    input[type=color] { width: 42px; height: 42px; border: 2px solid var(--medium-gray); padding: 3px; border-radius: var(--border-radius-round); overflow: hidden; cursor: pointer; vertical-align: middle; background-color: white; box-shadow: var(--shadow-soft);}
    input[type=color]::-webkit-color-swatch-wrapper { padding: 0; }
    input[type=color]::-webkit-color-swatch { border: none; border-radius: 50%; }
    input[type=color].inherited-style { border: 3px dashed var(--accent) !important; } /* Style for inherited color */

    .font-selector{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap}
    .font-option{padding:8px 18px;border:2px solid var(--medium-gray);border-radius:var(--border-radius-large);cursor:pointer;transition:background-color .3s,color .3s, border-color .3s, transform .2s; font-size: 1rem; font-weight: 600; box-shadow: var(--shadow-soft);}
    .font-option.selected{background-color:var(--primary);color:var(--white);border-color:var(--primary); font-weight: 700; box-shadow: var(--shadow-medium);}
    .font-option:hover:not(.selected) { background-color: #E3F2FD; border-color: var(--primary); transform: translateY(-2px);}
    .size-selector{display:flex;gap:12px;align-items:center;margin-bottom:20px}
    .size-option{padding:8px 18px;border:2px solid var(--medium-gray);border-radius:var(--border-radius-large);cursor:pointer;transition:background-color .3s,color .3s, border-color .3s, transform .2s; font-size: 1rem; font-weight: 600; box-shadow: var(--shadow-soft);}
    .size-option.selected{background-color:var(--primary);color:var(--white);border-color:var(--primary); font-weight: 700; box-shadow: var(--shadow-medium);}
    .size-option:hover:not(.selected) { background-color: #E3F2FD; border-color: var(--primary); transform: translateY(-2px);}

    /* --- Course Editor Specific Styles - Kid Redesign --- */
    #courseEditModal #projectTabsEditor { margin-top: 30px; padding-top: 25px; border-top: 2px dashed var(--medium-gray); }
    #projectTabsEditor h4 { margin-bottom: 20px; color: var(--primary); display: inline-block; border-bottom: 3px solid var(--secondary); padding-bottom: 8px; font-size: 1.3rem; font-weight: 700; }
    #projectTabsList { max-height: 400px; overflow-y: auto; padding-right: 15px;}
    .project-tab-edit-item { display: grid; grid-template-columns: auto 1fr auto; gap: 20px; align-items: center; padding: 20px; border: 2px solid var(--light); border-radius: var(--border-radius-medium); margin-bottom: 15px; background-color: #fff; box-shadow: var(--shadow-soft);}
    .project-tab-edit-item .index { font-weight: bold; font-size: 1.1rem; color: var(--secondary); background-color: var(--light); width: 35px; height: 35px; border-radius: var(--border-radius-round); display: flex; align-items: center; justify-content: center; }
    .project-tab-edit-item .inputs { display: flex; flex-direction: column; gap: 10px;}
    .project-tab-edit-item label { font-size: 0.9rem; margin-bottom: 4px; color: #546E7A; font-weight: 600;}
    .project-tab-edit-item input { padding: 10px; font-size: 0.95rem;}

    /* Project Editor Specific Styling - Kid Redesign */
    #projectEditModal .edit-section h4, #courseEditModal .edit-section h4{ /* Specific h4 style inside modal sections */
        color: var(--primary); margin-bottom: 20px; padding-bottom: 8px; border-bottom: 3px solid var(--secondary); display: inline-block; font-size: 1.4rem; font-weight: 700;
    }
     #projectEditModal .edit-section h5{ /* Specific h5 style inside modal sections */
        color: var(--dark); margin-top: 30px; margin-bottom: 15px; font-size: 1.2rem; font-weight: 700;
     }
     #projectEditModal #editingProjectNameLabel { color: var(--accent); font-weight: bold; font-size: 1.1rem; background-color: var(--light); padding: 5px 10px; border-radius: var(--border-radius-small); display: inline-block;}
     #projectEditModal .form-hint { font-size: 0.9rem; color: #78909C; margin-top: -12px; margin-bottom: 18px; font-style: italic; } /* Helper text style */


    /* --- Media Queries - Adjustments for Kid Redesign --- */
    @media (min-width:768px){
        .container { padding: 35px 25px; }
        .page-header{flex-direction:row;text-align:left;align-items:center;padding:35px 40px;gap:35px}
        #course-view .page-header img.header-image{width:150px;height:150px; border-radius: var(--border-radius-round);} /* Course header image */
        .page-header .header-title{font-size:2.5rem}
        .page-header .header-subtitle{font-size:1.2rem}
        .step{align-items:center}
        .step-number{margin-top:0;width:50px;height:50px;font-size:1.3rem}
        .step-content .step-media{max-width:70%;margin-left:auto;margin-right:auto}
        #project-view .page-header img.header-image{width:120px;height:120px} /* Project header image */
        #project-view .page-header .header-title{font-size:2.3rem}
        #project-view .page-header .header-subtitle{font-size:1.15rem}
        #projectTabs .tab { padding: 14px 30px; font-size: 1.1rem; } /* Larger project tabs on desktop */
        .quiz-options { grid-template-columns: repeat(2, 1fr); gap: 20px;} /* 2 columns for quiz options */
     }
    @media (max-width:600px){
        body { font-size: 16px; /* Adjust base size slightly smaller for small screens */ }
        .container{padding:20px 10px}
        .page-header{padding:25px 15px; gap: 15px;}
        .page-header img.header-image { width: 100px; height: 100px; }
        #projectTabContentContainer .tab-content{padding:25px 15px}
        /* Button positioning on small screens */
        .edit-btn, .export-btn, .back-btn { width: 42px; height: 42px; font-size: 18px; top: 15px; }
        #course-view .page-header .edit-btn { right: 15px; }
        #course-view .page-header .export-btn { right: 68px; }
        #project-view .page-header .edit-btn { right: 15px; }
        #project-view .page-header .back-btn { right: 68px; font-size: 20px; }
        h2{font-size:1.4rem; padding-bottom: 8px; margin-bottom: 25px;}
        .page-header .header-title{font-size:1.8rem}
        .page-header .header-subtitle{font-size:1rem}
        .modal-content{padding:30px 20px}
        .modal h2 { font-size: 1.6rem;}
        .step { flex-direction: column; align-items: flex-start; gap: 15px; padding: 20px;}
        .step-number { margin-top: 0; margin-bottom: 10px; width: 40px; height: 40px; font-size: 1.1rem;}
        .step-content .step-media{max-width:100%}
        #project-view .page-header .header-title{font-size:1.7rem}
        #project-view .page-header .header-subtitle{font-size:1rem}
        .modal-actions { text-align: center; }
        .modal-actions button { width: 48%; margin: 8px 1%; min-width: 0;} /* Adjust button width */
        .modal-actions button[onclick^="closeModal"] { margin-right: 1%; }
        .quiz-options { grid-template-columns: 1fr; } /* Force single column quiz on small screens */
        #projectTabs .tab { padding: 10px 20px; font-size: 1rem; }
        .submit-btn { padding: 15px 30px; font-size: 1.1rem;}
    }

</style>
</head>
<body>

<!-- Container for the whole application -->
<div class="container">

    <!-- == COURSE VIEW (Visible by default) == -->
    <div id="course-view">
        <header class="page-header" id="course-header">
             <!-- Replaced text icons with Font Awesome -->
             <button class="edit-btn" onclick="openCourseEditModal()" aria-label="Edit Course Details" title="Edit Course"><i class="fas fa-pencil-alt"></i></button>
             <button class="export-btn" onclick="exportCourseHTML()" aria-label="Export Course HTML" title="Export Course"><i class="fas fa-download"></i></button>
             <img src="https://images.unsplash.com/photo-1619410283995-43d9134e7656?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NXx8cHJvZ3JhbW1pbmd8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60" alt="Course Image" class="header-image" id="courseImage">
             <div class="header-title-container">
                 <h1 class="header-title" id="courseTitle">Course Title</h1>
                 <!-- Course subtitle/short desc could go here if needed -->
                 <p class="header-subtitle" id="courseSubtitle">Let's start learning!</p> <!-- Added generic subtitle -->
             </div>
        </header>

        <section id="course-description-container">
            <h2><i class="fas fa-info-circle" style="margin-right: 10px; color: var(--secondary);"></i>About This Course</h2>
            <p id="courseDescription">Loading course description...</p>
        </section>

        <section>
            <h2><i class="fas fa-rocket" style="margin-right: 10px; color: var(--accent);"></i>Projects</h2>
            <div id="projectGrid">
                <!-- Project tabs will be dynamically inserted here -->
                <p style="text-align: center; font-style: italic; color: var(--medium-gray);">Loading projects...</p>
            </div>
        </section>
    </div>

    <!-- == PROJECT VIEW (Hidden by default) == -->
    <div id="project-view" style="display: none;">
        <!-- Project Header (Populated Dynamically) -->
        <header class="page-header" id="project-header">
             <!-- Replaced text icons with Font Awesome -->
            <button class="back-btn" id="backToCourseBtn" onclick="showCourseView()" aria-label="Back to Course" title="Back to Course"><i class="fas fa-arrow-left"></i></button>
            <button class="edit-btn" onclick="openProjectEditModal()" aria-label="Edit Project" title="Edit Project"><i class="fas fa-pencil-alt"></i></button>
            <img src="" alt="Project Image" class="header-image" id="projectImage">
            <div class="header-title-container">
                <h1 class="header-title" id="projectTitle">Project Title</h1>
                <p class="header-subtitle" id="projectSubtitle">Project Subtitle</p>
            </div>
        </header>

        <!-- Existing Project Content Structure (Merged from Project Code) -->
        <div class="progress-container" title="Your Progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <nav class="tabs" id="projectTabs">
            <!-- Tabs are dynamically generated -->
            <!-- Example structure remains the same, JS populates it -->
            <div class="tab active" onclick="openProjectTab('overview', this)"><i class="fas fa-info"></i> Overview</div>
            <div class="tab" onclick="openProjectTab('video', this)"><i class="fas fa-video"></i> Video</div>
            <div class="tab" onclick="openProjectTab('slides', this)"><i class="fas fa-chalkboard-teacher"></i> Steps</div>
            <div class="tab" onclick="openProjectTab('challenges', this)"><i class="fas fa-star"></i> Challenges</div>
            <div class="tab" onclick="openProjectTab('quiz', this)"><i class="fas fa-question-circle"></i> Quiz</div>
        </nav>
        <main id="projectTabContentContainer">
            <!-- Project Tab Content Templates -->
             <section id="overview" class="tab-content active">
                 <h2><i class="fas fa-binoculars" style="margin-right: 10px; color: var(--secondary);"></i>About This Project</h2>
                 <p id="overviewText">Loading overview...</p>
                 <h3><i class="fas fa-graduation-cap" style="margin-right: 8px; color: var(--secondary);"></i>What You'll Learn</h3>
                 <div id="learnContainer"><p>Loading learning objectives...</p></div>
             </section>
             <section id="video" class="tab-content">
                 <h2><i class="fas fa-film" style="margin-right: 10px; color: var(--secondary);"></i>Video Lesson</h2>
                 <p id="videoIntroText"></p>
                 <h3 id="videoTitle" style="text-align: center;"></h3>
                 <div class="video-container">
                     <iframe src="" frameborder="0" loading="lazy" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen id="mainVideo" title="Project Video"></iframe>
                 </div>
                 <h3><i class="fas fa-lightbulb" style="margin-right: 8px; color: var(--secondary);"></i>Key Points</h3>
                 <ul id="videoKeyPoints" style="font-size: 1rem; padding-left: 30px; list-style: none;"><p>Loading key points...</p></ul> <!-- Changed list style -->
             </section>
             <section id="slides" class="tab-content">
                 <h2><i class="fas fa-shoe-prints" style="margin-right: 10px; color: var(--secondary);"></i>Step-by-Step Guide</h2>
                 <div class="slideshow" id="slideshowContainer"><p>Loading slides...</p></div>
                 <nav class="slide-nav">
                     <button onclick="prevSlide()"><i class="fas fa-chevron-left"></i> Previous</button>
                     <button onclick="nextSlide()">Next <i class="fas fa-chevron-right"></i></button>
                 </nav>
             </section>
             <section id="challenges" class="tab-content">
                 <h2><i class="fas fa-puzzle-piece" style="margin-right: 10px; color: var(--secondary);"></i>Project Challenges</h2>
                 <p>Try these challenges to test your awesome skills:</p>
                 <div id="challengesContainer"><p>Loading challenges...</p></div>
             </section>
             <section id="quiz" class="tab-content">
                 <h2><i class="fas fa-brain" style="margin-right: 10px; color: var(--secondary);"></i>Project Quiz</h2>
                 <p>Let's see what you've learned! Choose the best answer:</p>
                 <div id="quizContainer"><p>Loading quiz...</p></div>
                 <!-- Final result area added by script -->
                 <button class="submit-btn" id="submitQuizBtn" onclick="submitQuiz()">Check My Answers!</button>
             </section>
        </main>
    </div>

</div><!-- End .container -->


<!-- ==== MODALS ==== -->

<!-- == COURSE Editor Modal == -->
<div id="courseEditModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('courseEditModal')" title="Close Editor" aria-label="Close Course Editor"><i class="fas fa-times"></i></span>
        <h2><i class="fas fa-book-open" style="margin-right: 10px;"></i>Edit Course Details</h2>
        <form class="edit-form" onsubmit="event.preventDefault(); saveCourseChanges();">
            <section class="edit-section" style="border-top: none; padding-top: 0;">
                <h4><i class="fas fa-info-circle" style="margin-right: 8px;"></i>Course Info</h4>
                <label for="editCourseTitle">Course Title:</label>
                <input type="text" id="editCourseTitle" required>

                <label for="editCourseImage">Course Header Image URL:</label>
                <input type="url" id="editCourseImage" placeholder="Paste image link here! e.g., https://...">

                <label for="editCourseDescription">Course Description:</label>
                <textarea id="editCourseDescription" rows="6" placeholder="Tell everyone what this cool course is about!"></textarea>
            </section>

            <!-- Course Theme Color Editor -->
            <section id="courseStyleEditor" class="edit-section">
                 <h4><i class="fas fa-palette" style="margin-right: 8px;"></i>Course Theme Colors</h4>
                 <p class="form-hint">Pick the main colors for the whole course!</p>
                 <label>Main Color (Primary):</label>
                 <div class="color-picker">
                     <!-- Options + Custom Picker -->
                     <div class="color-option" style="background-color: #29B6F6;" onclick="selectCourseColor('primary', '#29B6F6')" title="Sky Blue"></div>
                     <div class="color-option" style="background-color: #9CCC65;" onclick="selectCourseColor('primary', '#9CCC65')" title="Lime Green"></div>
                     <div class="color-option" style="background-color: #FF7043;" onclick="selectCourseColor('primary', '#FF7043')" title="Orange"></div>
                     <div class="color-option" style="background-color: #AB47BC;" onclick="selectCourseColor('primary', '#AB47BC')" title="Purple"></div>
                     <div class="color-option" style="background-color: #FFCA28;" onclick="selectCourseColor('primary', '#FFCA28')" title="Yellow"></div>
                     <input type="color" id="coursePrimaryColorPicker" oninput="customCourseColorSelected('primary', this.value)" aria-label="Custom Primary Color" title="Choose Custom Color">
                 </div>
                 <label>Second Color (Secondary):</label>
                 <div class="color-picker">
                     <!-- Options + Custom Picker -->
                     <div class="color-option" style="background-color: #FFCA28;" onclick="selectCourseColor('secondary', '#FFCA28')" title="Yellow"></div>
                     <div class="color-option" style="background-color: #FF7043;" onclick="selectCourseColor('secondary', '#FF7043')" title="Orange"></div>
                     <div class="color-option" style="background-color: #66BB6A;" onclick="selectCourseColor('secondary', '#66BB6A')" title="Green"></div>
                     <div class="color-option" style="background-color: #EC407A;" onclick="selectCourseColor('secondary', '#EC407A')" title="Pink"></div>
                     <div class="color-option" style="background-color: #26A69A;" onclick="selectCourseColor('secondary', '#26A69A')" title="Teal"></div>
                     <input type="color" id="courseSecondaryColorPicker" oninput="customCourseColorSelected('secondary', this.value)" aria-label="Custom Secondary Color" title="Choose Custom Color">
                 </div>
                 <label>Highlight Color (Accent):</label>
                 <div class="color-picker">
                      <!-- Options + Custom Picker -->
                      <div class="color-option" style="background-color: #FF7043;" onclick="selectCourseColor('accent', '#FF7043')" title="Orange"></div>
                      <div class="color-option" style="background-color: #FFCA28;" onclick="selectCourseColor('accent', '#FFCA28')" title="Yellow"></div>
                      <div class="color-option" style="background-color: #EC407A;" onclick="selectCourseColor('accent', '#EC407A')" title="Pink"></div>
                      <div class="color-option" style="background-color: #29B6F6;" onclick="selectCourseColor('accent', '#29B6F6')" title="Sky Blue"></div>
                      <div class="color-option" style="background-color: #AB47BC;" onclick="selectCourseColor('accent', '#AB47BC')" title="Purple"></div>
                     <input type="color" id="courseAccentColorPicker" oninput="customCourseColorSelected('accent', this.value)" aria-label="Custom Accent Color" title="Choose Custom Color">
                 </div>
            </section>

            <!-- Project Tabs Editor -->
            <section id="projectTabsEditor" class="edit-section">
                 <h4><i class="fas fa-list-ol" style="margin-right: 8px;"></i>Manage Project Tabs</h4>
                 <div id="projectTabsList">
                     <!-- Project tab edit items will be listed here -->
                 </div>
                 <button type="button" class="add-item-btn" onclick="addProjectTabEditField()"><i class="fas fa-plus"></i> Add New Project</button>
            </section>

            <div class="modal-actions">
                 <button type="button" onclick="closeModal('courseEditModal')">Cancel</button>
                 <button type="submit">Save Course</button>
            </div>
        </form>
    </div>
</div>


<!-- == PROJECT Editor Modal (Merged) == -->
<div id="projectEditModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('projectEditModal')" title="Close Editor" aria-label="Close Project Editor"><i class="fas fa-times"></i></span>
        <h2><i class="fas fa-tools" style="margin-right: 10px;"></i>Edit Project Details</h2>
         <p style="font-size: 1rem; color: #555; margin-bottom: 25px; text-align: center;">Editing Project: <strong id="editingProjectNameLabel"></strong></p>
        <form class="edit-form" onsubmit="event.preventDefault(); saveProjectChanges();">
             <input type="hidden" id="editingProjectId"> <!-- Store ID of project being edited -->

            <label for="editSectionProject">What part do you want to edit?</label>
            <select id="editSectionProject" onchange="showProjectEditSection()">
                <option value="projMeta">Project Header & Tab</option>
                <option value="overview">Overview & Learning Goals</option>
                <option value="video">Video Lesson</option>
                <option value="slides">Step-by-Step Slides</option>
                <option value="challenges">Challenges</option>
                <option value="quiz">Quiz Questions</option>
                <option value="projStyle">Project Look (Font, Size, Colors)</option>
            </select>

            <!-- === Project Metadata Edit === -->
            <section id="projMetaEdit" class="edit-section" style="border-top: none; padding-top: 10px;">
                 <h4><i class="fas fa-heading" style="margin-right: 8px;"></i>Project Header & Course Tab</h4>
                <label for="editProject_Title">Project Title:</label>
                <input type="text" id="editProject_Title" required placeholder="Give your project a cool name!">
                <label for="editProject_Subtitle">Subtitle:</label>
                <input type="text" id="editProject_Subtitle" placeholder="Short description for the project page top">
                <label for="editProject_HeaderImage">Project Header Image URL:</label>
                <input type="url" id="editProject_HeaderImage" placeholder="Link to image for the project page top">
                <p class="form-hint">Shows up big on the project page! (Maybe 120x120 size?)</p>
                 <hr style="margin: 25px 0; border-top: 1px solid var(--light);">
                 <label for="editProject_TabName">Tab Name (on Course Page):</label>
                 <input type="text" id="editProject_TabName" required placeholder="Short name for the course grid">
                 <label for="editProject_TabImage">Tab Image URL (on Course Page):</label>
                 <input type="url" id="editProject_TabImage" placeholder="Link to image for the course grid">
                 <p class="form-hint">This is the picture on the main course page grid. (Square works best!)</p>
            </section>

            <!-- === Overview & Learn Edit === -->
            <section id="overviewEdit" class="edit-section" style="display:none;">
                 <h4><i class="fas fa-file-alt" style="margin-right: 8px;"></i>Overview Content</h4>
                <label for="editProject_OverviewText">Overview Text:</label>
                <textarea id="editProject_OverviewText" rows="5" placeholder="Tell everyone what this project is about..."></textarea>
                 <hr style="margin: 25px 0; border-top: 1px solid var(--light);">
                  <h4><i class="fas fa-graduation-cap" style="margin-right: 8px;"></i>"What You'll Learn" Items</h4>
                  <div id="learnEditContainer"> <!-- Populated by JS --> </div>
                  <button type="button" class="add-item-btn" onclick="addLearnEditField()"><i class="fas fa-plus"></i> Add Learning Goal</button>
            </section>

            <!-- === Video Edit === -->
            <section id="videoEdit" class="edit-section" style="display:none;">
                 <h4><i class="fas fa-video" style="margin-right: 8px;"></i>Video Lesson Content</h4>
                 <label for="editProject_VideoIntroText">Intro Text (Above Video):</label>
                 <input type="text" id="editProject_VideoIntroText" placeholder="e.g., Watch this video to see how it's done!">
                 <label for="editProject_VideoTitle">Video Section Title (Above Video):</label>
                 <input type="text" id="editProject_VideoTitle" placeholder="e.g., Making the Character Jump">
                 <label for="editProject_VideoUrl">Video Embed URL:</label>
                 <input type="url" id="editProject_VideoUrl" placeholder="Paste YouTube/Vimeo embed link here...">
                 <label for="editProject_VideoKeyPoints">Key Points (one per line, below video):</label>
                 <textarea id="editProject_VideoKeyPoints" rows="5" placeholder="Important point 1&#10;Another important thing&#10;Don't forget this..."></textarea>
            </section>

            <!-- === Slides Edit === -->
            <section id="slidesEdit" class="edit-section" style="display:none;">
                <h4><i class="fas fa-shoe-prints" style="margin-right: 8px;"></i>Step-by-Step Slides</h4>
                <div id="slidesEditContainer"> <!-- Populated by JS --> </div>
                <button type="button" class="add-item-btn" onclick="addSlideEditField()"><i class="fas fa-plus"></i> Add Slide</button>
            </section>

            <!-- === Challenges Edit === -->
            <section id="challengesEdit" class="edit-section" style="display:none;">
                <h4><i class="fas fa-puzzle-piece" style="margin-right: 8px;"></i>Project Challenges</h4>
                <div id="challengesEditContainer"> <!-- Populated by JS --> </div>
                <button type="button" class="add-item-btn" onclick="addChallengeEditField()"><i class="fas fa-plus"></i> Add Challenge</button>
            </section>

            <!-- === Quiz Edit === -->
            <section id="quizEdit" class="edit-section" style="display:none;">
                <h4><i class="fas fa-brain" style="margin-right: 8px;"></i>Quiz Questions</h4>
                 <div id="quizEditContainer"> <!-- Populated by JS --> </div>
                 <button type="button" class="add-item-btn" onclick="addQuizEditField()"><i class="fas fa-plus"></i> Add Question</button>
            </section>

            <!-- === Project Style Edit === -->
            <section id="projStyleEdit" class="edit-section" style="display:none;">
                 <h4><i class="fas fa-paint-brush" style="margin-right: 8px;"></i>Project Specific Look</h4>
                 <p class="form-hint">Make this project look different from the main course theme!</p>

                 <h5><i class="fas fa-palette" style="margin-right: 8px;"></i>Color Overrides</h5>
                 <p class="form-hint" style="margin-bottom: 10px;">Pick colors just for this project. (Dashed border means it's using the course color).</p>
                  <button type="button" onclick="clearProjectColorOverrides()" style="font-size: 0.9rem; padding: 6px 12px; margin-bottom: 20px; background-color: var(--medium-gray); color: var(--dark); font-weight: normal; box-shadow: none; border-radius: var(--border-radius-small);"><i class="fas fa-undo" style="margin-right: 5px;"></i>Use Course Colors</button>

                 <label>Project Main Color Override:</label>
                 <div class="color-picker" id="projectPrimaryColorPickerContainer">
                    <!-- Options populated similar to course -->
                     <div class="color-option" style="background-color: #29B6F6;" onclick="selectProjectColor('primary', '#29B6F6')" title="Sky Blue"></div>
                     <div class="color-option" style="background-color: #9CCC65;" onclick="selectProjectColor('primary', '#9CCC65')" title="Lime Green"></div>
                     <div class="color-option" style="background-color: #FF7043;" onclick="selectProjectColor('primary', '#FF7043')" title="Orange"></div>
                     <div class="color-option" style="background-color: #AB47BC;" onclick="selectProjectColor('primary', '#AB47BC')" title="Purple"></div>
                     <div class="color-option" style="background-color: #FFCA28;" onclick="selectProjectColor('primary', '#FFCA28')" title="Yellow"></div>
                     <input type="color" id="projectPrimaryColorPicker" oninput="customProjectColorSelected('primary', this.value)" aria-label="Custom Project Primary Color" title="Choose Custom Color">
                 </div>
                 <label>Project Second Color Override:</label>
                 <div class="color-picker" id="projectSecondaryColorPickerContainer">
                     <!-- Options populated similar to course -->
                     <div class="color-option" style="background-color: #FFCA28;" onclick="selectProjectColor('secondary', '#FFCA28')" title="Yellow"></div>
                     <div class="color-option" style="background-color: #FF7043;" onclick="selectProjectColor('secondary', '#FF7043')" title="Orange"></div>
                     <div class="color-option" style="background-color: #66BB6A;" onclick="selectProjectColor('secondary', '#66BB6A')" title="Green"></div>
                     <div class="color-option" style="background-color: #EC407A;" onclick="selectProjectColor('secondary', '#EC407A')" title="Pink"></div>
                     <div class="color-option" style="background-color: #26A69A;" onclick="selectProjectColor('secondary', '#26A69A')" title="Teal"></div>
                     <input type="color" id="projectSecondaryColorPicker" oninput="customProjectColorSelected('secondary', this.value)" aria-label="Custom Project Secondary Color" title="Choose Custom Color">
                 </div>
                 <label>Project Highlight Color Override:</label>
                 <div class="color-picker" id="projectAccentColorPickerContainer">
                     <!-- Options populated similar to course -->
                      <div class="color-option" style="background-color: #FF7043;" onclick="selectProjectColor('accent', '#FF7043')" title="Orange"></div>
                      <div class="color-option" style="background-color: #FFCA28;" onclick="selectProjectColor('accent', '#FFCA28')" title="Yellow"></div>
                      <div class="color-option" style="background-color: #EC407A;" onclick="selectProjectColor('accent', '#EC407A')" title="Pink"></div>
                      <div class="color-option" style="background-color: #29B6F6;" onclick="selectProjectColor('accent', '#29B6F6')" title="Sky Blue"></div>
                      <div class="color-option" style="background-color: #AB47BC;" onclick="selectProjectColor('accent', '#AB47BC')" title="Purple"></div>
                     <input type="color" id="projectAccentColorPicker" oninput="customProjectColorSelected('accent', this.value)" aria-label="Custom Project Accent Color" title="Choose Custom Color">
                 </div>

                 <h5 style="margin-top: 30px;"><i class="fas fa-font" style="margin-right: 8px;"></i>Font & Size Override</h5>
                 <label>Font Family Override:</label>
                 <div class="font-selector" id="projectFontSelector">
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', null)" >Use Course Default Font</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Quicksand', sans-serif`)" style="font-family: 'Quicksand', sans-serif;">Quicksand</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Nunito', sans-serif`)" style="font-family: 'Nunito', sans-serif;">Nunito</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Comic Neue', cursive`)" style="font-family: 'Comic Neue', cursive;">Comic Neue</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Patrick Hand', cursive`)" style="font-family: 'Patrick Hand', cursive;">Patrick Hand</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Arial', sans-serif`)" style="font-family: Arial, sans-serif;">Arial (System)</div>
                 </div>

                 <label>Base Text Size Override:</label>
                 <div class="size-selector" id="projectSizeSelector">
                      <div class="size-option" onclick="selectProjectStyle('baseSize', null)">Use Course Default Size</div>
                     <div class="size-option" onclick="selectProjectStyle('baseSize', 'small')">Small Text</div>
                     <div class="size-option" onclick="selectProjectStyle('baseSize', 'medium')">Medium Text</div>
                     <div class="size-option" onclick="selectProjectStyle('baseSize', 'large')">Large Text</div>
                 </div>
            </section>

            <div class="modal-actions">
                <button type="button" onclick="closeModal('projectEditModal')">Cancel</button>
                <button type="submit">Save Project</button>
            </div>
        </form>
    </div>
</div>


<script>
    // --- Global Data Storage ---
    // [SAME courseData object as before - NO CHANGES HERE]
    let courseData = {
        title: "Micro:bit Adventures",
        description: "Explore the exciting world of physical computing with the BBC micro:bit! This course contains several projects designed to introduce you to coding concepts and hardware interaction in a fun, hands-on way.",
        imageUrl: "https://images.unsplash.com/photo-1619410283995-43d9134e7656?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NXx8cHJvZ3JhbW1pbmd8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60",
        // Course-level theme colors (Now using the defaults from the new :root)
        style: {
            primaryColor: '#29B6F6',   // Light Blue
            secondaryColor: '#FFCA28', // Amber/Yellow
            accentColor: '#FF7043',    // Deep Orange
        },
        projects: [
            // Project 1: Beating Heart (Data merged from project page)
            {
                id: 'proj_heart',
                tabName: "Beating Heart",
                tabImage: "https://makecode.microbit.org/v0/beta-sim.html?nohw=1#pub:_7cvWKT73g7Pv", // MakeCode Share Image
                projectTitle: "Beating Heart Animation",
                projectSubtitle: "Make your Micro:bit display a classic beating heart!",
                projectHeaderImage: "https://makecode.microbit.org/v0/beta-sim.html?nohw=1#pub:_7cvWKT73g7Pv",
                overviewText: "Welcome to your first Micro:bit project! You'll learn the basics of block coding by creating a simple but effective animation on the Micro:bit's LED display  a beating heart. This is a fantastic way to understand loops and timing in programming.",
                videoIntroText: "Watch this short video guide to see exactly how to build the code blocks for the beating heart animation in the MakeCode editor:",
                videoTitle: "Coding the Beating Heart",
                videoUrl: "https://www.youtube.com/embed/2yzT7_QGLLc", // Example Video
                videoKeyPoints: [ // Modified for icon list style
                    { icon: 'fa-regular fa-lightbulb', text: "The LED matrix is a 5x5 grid of lights." },
                    { icon: 'fa-solid fa-code', text: "Code in the 'on start' block runs only once." },
                    { icon: 'fa-solid fa-repeat', text: "Code in the 'forever' block repeats continuously." },
                    { icon: 'fa-solid fa-draw-polygon', text: "'show leds' block lets you draw custom patterns." },
                    { icon: 'fa-solid fa-icons', text: "'show icon' block provides pre-made images." },
                    { icon: 'fa-solid fa-stopwatch', text: "'pause (ms)' block creates delays for animation timing (ms = milliseconds)." }
                ],
                learnData: [
                    { title: "Micro:bit LEDs", description: "Understand the 5x5 LED grid and how each LED can be turned on or off.", mediaType: 'image', mediaUrl: 'https://os.mbed.com/docs/mbed-os/v6.16/apis/assets/images/Glossary_MB_LEDMatrix.png' },
                    { title: "'Forever' Loop", description: "Learn how the 'forever' block continuously runs the code inside it, essential for animations.", mediaType: 'none', mediaUrl: '' },
                    { title: "Displaying Images", description: "Explore using 'show leds' to draw custom shapes and 'show icon' for built-in images like hearts.", mediaType: 'image', mediaUrl: 'https://microbit.org/images/lessons/flashing-heart/animated-step-3.gif' },
                    { title: "Timing with 'Pause'", description: "Understand how the 'pause (ms)' block controls the speed of the animation by creating delays.", mediaType: 'none', mediaUrl: '' },
                    { title: "Sequencing", description: "Recognize that the order of code blocks determines the sequence of the animation steps.", mediaType: 'none', mediaUrl: '' }
                ],
                slidesData: [
                    { url: "https://makecode.microbit.org/v0/beta-sim.html?nohw=1#pub:_7cvWKT73g7Pv", description: "1. Final Code: This is what the completed code blocks look like.", type: "iframe" },
                    { url: "https://microbit.org/images/lessons/flashing-heart/animated-step-2.gif", description: "2. Drag out a 'show leds' block into the 'forever' loop.", type: "image" },
                    { url: "https://microbit.org/images/lessons/flashing-heart/animated-step-3.gif", description: "3. Draw the large heart shape by clicking the squares.", type: "image" },
                    { url: "https://microbit.org/images/lessons/flashing-heart/animated-step-4.gif", description: "4. Add a 'pause (ms)' block and set it to 500ms (half a second).", type: "image" },
                    { url: "https://microbit.org/images/lessons/flashing-heart/animated-step-5.gif", description: "5. Add another 'show leds' block and draw the small heart.", type: "image" },
                    { url: "https://microbit.org/images/lessons/flashing-heart/animated-step-6.gif", description: "6. Add a final 'pause (ms)' block, also set to 500ms.", type: "image" },
                ],
                challengesData: [
                    { title: "Speed Control", description: "Experiment by changing the numbers in the 'pause (ms)' blocks. What happens if you use 1000? What about 100?", mediaType: 'none', mediaUrl: '' },
                    { title: "Different Icon", description: "Instead of 'show leds', try using the 'show icon' block with different heart sizes (Heart, SmallHeart). Does it look different?", mediaType: 'none', mediaUrl: '' },
                    { title: "Your Own Animation", description: "Create a completely different two-frame animation. Maybe a blinking eye or a simple shape that grows and shrinks?", mediaType: 'image', mediaUrl: 'https://lancaster-university.github.io/microbit-docs/assets/images/microbit-smiley.png' },
                ],
                quizData: [
                    { questionText: "Which block makes code run over and over again?", correctAnswer: "'forever'", incorrectAnswers: ["'on start'", "'pause (ms)'", "'show icon'"] },
                    { questionText: "How many LEDs are in the Micro:bit's display grid?", correctAnswer: "25 (5x5)", incorrectAnswers: ["10 (2x5)", "5 (1x5)", "50 (5x10)"] },
                    { questionText: "What unit does the 'pause (ms)' block use?", correctAnswer: "Milliseconds", incorrectAnswers: ["Seconds", "Minutes", "Microseconds"] },
                    { questionText: "To make an animation, you show an image, then _______, then show another image.", correctAnswer: "Pause", incorrectAnswers: ["Stop", "Repeat", "Shake"] }
                ],
                // Project specific style overrides (Example with new colors)
                style: {
                    fontFamily: `'Comic Neue', cursive`, // Example specific font
                    baseSize: 'large', // Example specific size
                    primaryColor: '#E53935', // Red Primary for this project only
                    secondaryColor: '#FFFDE7', // Cream Secondary
                    accentColor: '#FFB300', // Amber Accent
                 },
                 isCompleted: false // Completion flag
            },
            // Project 2: Smiley Buttons (Basic data for structure)
            {
                 id: 'proj_smiley',
                 tabName: "Smiley Buttons",
                 tabImage: "https://makecode.microbit.org/v0/beta-sim.html?nohw=1#pub:_LL1gP83dhL7K", // MakeCode Share Image
                 projectTitle: "Smiley Buttons Interaction",
                 projectSubtitle: "Show different faces when buttons A and B are pressed.",
                 projectHeaderImage: "https://makecode.microbit.org/v0/beta-sim.html?nohw=1#pub:_LL1gP83dhL7K",
                 overviewText: "Learn how to make your Micro:bit react to input! In this project, pressing button A will show a happy face, and pressing button B will show a sad face. This introduces event handling and basic input.",
                 videoIntroText: "This video demonstrates how to use the 'on button pressed' blocks:",
                 videoTitle: "Handling Button Inputs",
                 videoUrl: "https://www.youtube.com/embed/Gk_Q8Rv9AlU", // Example Video
                 videoKeyPoints: [ // Modified for icon list style
                     { icon: 'fa-solid fa-a', text: "Use 'on button A pressed' block to detect button A clicks." },
                     { icon: 'fa-solid fa-b', text: "Use 'on button B pressed' block for button B." },
                     { icon: 'fa-solid fa-computer-mouse', text: "Code inside these blocks only runs when the corresponding button is pressed." },
                     { icon: 'fa-regular fa-face-smile', text: "'show icon' is useful for displaying standard faces." }
                    ],
                 learnData: [
                     {title:"Input Events", description:"Understand that 'on button pressed' blocks trigger code based on an external event (a button click).", mediaType:'none', mediaUrl:''},
                     {title:"Event Handlers", description:"Learn that these specific blocks handle specific events.", mediaType:'none', mediaUrl:''},
                     {title:"Button Identification", description:"Distinguish between button A and button B on the Micro:bit.", mediaType:'image', mediaUrl:'https://teach.microbit.org/images/buttons.png'}
                  ],
                 slidesData: [
                    { url: "https://makecode.microbit.org/v0/beta-sim.html?nohw=1#pub:_LL1gP83dhL7K", description: "1. Final Code: Separate blocks for Button A and Button B presses.", type: "iframe" },
                    { url: "https://microbit.org/images/lessons/smiley-buttons/animated-step-2.gif", description: "2. Drag out an 'on button A pressed' block.", type: "image" },
                    { url: "https://microbit.org/images/lessons/smiley-buttons/animated-step-3.gif", description: "3. Place a 'show icon' block inside and select the Happy face.", type: "image" },
                    { url: "https://microbit.org/images/lessons/smiley-buttons/animated-step-4.gif", description: "4. Drag out another 'on button pressed' block and change 'A' to 'B'.", type: "image" },
                    { url: "https://microbit.org/images/lessons/smiley-buttons/animated-step-5.gif", description: "5. Place a 'show icon' block inside the 'B' block and select the Sad face.", type: "image" },
                 ],
                 challengesData: [
                     {title: "Surprise Face!", description: "Can you add an 'on button A+B pressed' block to show a 'Surprised' face when both buttons are pressed together?", mediaType:'none', mediaUrl:''},
                     {title: "Clear the Screen", description: "Add a 'clear screen' block inside each button press event *before* showing the icon. What changes?", mediaType:'none', mediaUrl:''},
                     {title: "Different Icons", description: "Choose completely different icons for button A and button B.", mediaType:'none', mediaUrl:''}
                 ],
                 quizData: [
                     {questionText: "Which block runs code ONLY when Button A is clicked?", correctAnswer:"'on button A pressed'", incorrectAnswers:["'forever'", "'on start'", "'show leds'"]},
                     {questionText: "What is the term for something that happens outside the normal code flow, like a button press?", correctAnswer:"Event", incorrectAnswers:["Loop", "Variable", "Sequence"]},
                     {questionText: "If you want to show a pre-drawn image, which block is often easiest?", correctAnswer:"'show icon'", incorrectAnswers:["'show leds'", "'pause (ms)'", "'clear screen'"]}
                 ],
                 // Default style (inherits all from course)
                 style: { fontFamily: null, baseSize: null, primaryColor: null, secondaryColor: null, accentColor: null },
                 isCompleted: false
             }
            // Add more project objects here...
        ]
    };

    // State variables
    let currentProjectId = null;
    let currentProjectDataCache = null;
    let currentSlideIndex = 0;

    // --- Constants for limits ---
    const MAX_PROJECTS = 24;
    const MAX_SLIDES = 10;
    const MAX_CHALLENGES = 10;
    const MAX_LEARN_ITEMS = 8;
    const MAX_QUIZ_QUESTIONS = 10;
    const MAX_INCORRECT_ANSWERS = 3;

    // --- THEME APPLICATION ---
    // [SAME hexToRgb function as before - NO CHANGES HERE]
    function hexToRgb(hex) { /* ... */ }
    // [SAME applyThemeColors function as before - NO CHANGES HERE]
    function applyThemeColors(primary, secondary, accent) { /* ... */ }
    // [SAME applyCourseTheme function as before, but uses new default vars]
    function applyCourseTheme() {
        console.log("Applying COURSE theme");
        const courseStyle = courseData.style || {};
        applyThemeColors(courseStyle.primaryColor, courseStyle.secondaryColor, courseStyle.accentColor);

        const root = document.documentElement;
        // Use the defaults set in :root as the base course font/size
        root.style.setProperty('--base-font-family', `var(--base-font-family)`); // Reference CSS var
        root.style.setProperty('--base-font-size', `var(--base-font-size)`);   // Reference CSS var

        const projectViewEl = document.getElementById('project-view');
         if (projectViewEl) {
             projectViewEl.style.fontFamily = '';
             projectViewEl.style.fontSize = '';
        }
    }
    // [SAME applyProjectSpecificStyles function as before - LOGIC UNCHANGED]
    function applyProjectSpecificStyles(project) { /* ... */ }

    // --- VIEW NAVIGATION ---
    // [SAME showCourseView function as before - LOGIC UNCHANGED]
    function showCourseView() { /* ... */ }
    // [SAME showProjectView function as before - LOGIC UNCHANGED]
    function showProjectView(projectId) { /* ... */ }
    // [SAME window.onpopstate handler as before - LOGIC UNCHANGED]
     window.onpopstate = function(event) { /* ... */ };

    // --- COURSE PAGE RENDERING ---
    function renderCoursePage() {
        console.log("Rendering Course Page");
        const course = courseData;

        // Update Course Header
        document.getElementById('courseTitle').textContent = course.title;
        // Optionally update generic subtitle if needed
        // document.getElementById('courseSubtitle').textContent = "Some dynamic subtitle";
        const courseImg = document.getElementById('courseImage');
        if(courseImg) { courseImg.src = course.imageUrl || ''; courseImg.alt = course.title + " Image"; }
        document.getElementById('courseDescription').textContent = course.description;

        const grid = document.getElementById('projectGrid');
        grid.innerHTML = ''; // Clear existing

        if (!course.projects || course.projects.length === 0) {
            grid.innerHTML = '<p style="text-align: center; color: var(--medium-gray); font-style: italic; padding: 40px 0;">No projects have been added yet. Use the <i class="fas fa-pencil-alt"></i> button to add some!</p>';
            return;
        }

        course.projects.forEach(project => {
            if (!project || !project.id) return;

            const tab = document.createElement('a');
            tab.className = 'project-tab';
            tab.href = `#project-${project.id}`;
            tab.onclick = (event) => { event.preventDefault(); showProjectView(project.id); };

            const img = document.createElement('img');
            img.src = project.tabImage || 'https://via.placeholder.com/300x220/eeeeee/cccccc?text=Project+Image'; // Default placeholder
            img.alt = project.tabName || 'Project Tab';
            img.loading = 'lazy';

            const infoDiv = document.createElement('div');
            infoDiv.className = 'project-tab-info';
            const nameSpan = document.createElement('span');
            nameSpan.textContent = project.tabName || 'Unnamed Project';
            infoDiv.appendChild(nameSpan);

            tab.appendChild(img);
            tab.appendChild(infoDiv);

            // Add completion tick if project is completed (using Font Awesome)
            if (project.isCompleted) {
                const tick = document.createElement('span');
                tick.className = 'completion-tick';
                tick.innerHTML = '<i class="fas fa-check"></i>'; // Checkmark icon
                tick.setAttribute('aria-label', 'Project Completed');
                tick.title = 'Project Completed!';
                tab.appendChild(tick);
            }

            grid.appendChild(tab);
        });
    }

    // --- PROJECT PAGE RENDERING ---
    function renderProjectPage(project) {
        console.log("Rendering Project:", project?.projectTitle);
        if (!project) return;
        const projectView = document.getElementById('project-view');
        if (!projectView) return;

        // Populate Project Header
        const projectHeader = projectView.querySelector('#project-header');
        if (projectHeader) {
            projectHeader.querySelector('#projectImage').src = project.projectHeaderImage || project.tabImage || 'https://via.placeholder.com/120x120/eeeeee/cccccc?text=Project';
            projectHeader.querySelector('#projectImage').alt = project.projectTitle + " Header Image";
            projectHeader.querySelector('#projectTitle').textContent = project.projectTitle || 'Project Title';
            projectHeader.querySelector('#projectSubtitle').textContent = project.projectSubtitle || 'Let\'s get started!'; // Generic subtitle
        }

        // -- Populate Project Tab Content --
        const contentContainer = projectView.querySelector('#projectTabContentContainer');
        if (!contentContainer) return;

        // Overview Tab
        const overviewContent = contentContainer.querySelector('#overview');
        if (overviewContent) {
            overviewContent.querySelector('#overviewText').textContent = project.overviewText || 'No overview provided.';
            renderLearnItemsForProject(project.learnData || [], overviewContent.querySelector('#learnContainer'));
        }

        // Video Tab
        const videoContent = contentContainer.querySelector('#video');
        if (videoContent) {
             const videoIframe = videoContent.querySelector('#mainVideo');
             const keyPointsUL = videoContent.querySelector('#videoKeyPoints');
             videoContent.querySelector('#videoIntroText').textContent = project.videoIntroText || '';
             videoContent.querySelector('#videoTitle').textContent = project.videoTitle || '';
             if(videoIframe) videoIframe.src = project.videoUrl || '';
             if(keyPointsUL) {
                 keyPointsUL.innerHTML = ''; // Clear old points
                 // Render key points with icons if available
                 if (project.videoKeyPoints && project.videoKeyPoints.length > 0) {
                     project.videoKeyPoints.forEach(p => {
                          if (p && (p.text || typeof p === 'string')) { // Handle both object and string formats
                               const li = document.createElement('li');
                               if (typeof p === 'object' && p.icon) {
                                   li.innerHTML = `<i class="${p.icon}" style="color: var(--secondary); margin-right: 10px; width: 20px; text-align: center;"></i> ${p.text}`;
                               } else {
                                   // Default icon if just text
                                   li.innerHTML = `<i class="fas fa-check" style="color: var(--secondary); margin-right: 10px;"></i> ${p}`;
                               }
                               keyPointsUL.appendChild(li);
                          }
                     });
                 }
                 if (keyPointsUL.innerHTML === '') keyPointsUL.innerHTML = '<li style="color: #888; font-style: italic;"><i class="fas fa-times-circle" style="margin-right: 10px;"></i>No key points provided.</li>';
             }
        }

        // Slides Tab
        const slidesContent = contentContainer.querySelector('#slides');
        if (slidesContent) {
            renderSlideshowForProject(project.slidesData || [], slidesContent.querySelector('#slideshowContainer'));
        }

        // Challenges Tab
        const challengesContent = contentContainer.querySelector('#challenges');
        if (challengesContent) {
            renderChallengesForProject(project.challengesData || [], challengesContent.querySelector('#challengesContainer'));
        }

        // Quiz Tab
        const quizContent = contentContainer.querySelector('#quiz');
        if (quizContent) {
             renderQuizForProject(project.quizData || [], quizContent.querySelector('#quizContainer'), quizContent.querySelector('#submitQuizBtn'));
        }

        // Activate the first project tab ('Overview') and update progress
        const projectTabsBar = projectView.querySelector('#projectTabs');
        if (projectTabsBar) {
             const firstProjectTabButton = projectTabsBar.querySelector('.tab');
             if (firstProjectTabButton) {
                  const clickAttr = firstProjectTabButton.getAttribute('onclick') || '';
                  const match = clickAttr.match(/openProjectTab\('([^']+)'/);
                  const firstTabName = match ? match[1] : 'overview';
                  openProjectTab(firstTabName, firstProjectTabButton);
             } else {
                  updateProjectProgressBar('');
             }
        }
    }

    // --- Project Specific Content Rendering Helpers ---
    // [SAME renderLearnItemsForProject function as before - LOGIC UNCHANGED, styling handled by CSS]
    function renderLearnItemsForProject(learnItemsData, container) { /* ... */ }
    // [SAME renderChallengesForProject function as before - LOGIC UNCHANGED, step-number styling handled by CSS]
    function renderChallengesForProject(challengesItemsData, container) { /* ... */ }
    // [SAME renderSlideshowForProject function as before - LOGIC UNCHANGED, styling handled by CSS]
     function renderSlideshowForProject(slidesItemsData, container) { /* ... */ }
    // [SAME renderQuizForProject function as before - LOGIC UNCHANGED, styling handled by CSS]
      function renderQuizForProject(quizItemsData, container, submitBtn) { /* ... */ }

    // --- Project-Specific Tab/Progress/Slides/Quiz Interaction ---
    // [SAME openProjectTab function as before - LOGIC UNCHANGED]
    function openProjectTab(tabName, element) { /* ... */ }
    // [SAME updateProjectProgressBar function as before - LOGIC UNCHANGED]
    function updateProjectProgressBar(tabName) { /* ... */ }
    // [SAME showSlide, nextSlide, prevSlide functions as before - LOGIC UNCHANGED]
    function showSlide(n) { /* ... */ }
    function nextSlide() { showSlide(currentSlideIndex + 1); }
    function prevSlide() { showSlide(currentSlideIndex - 1); }
    // [SAME selectQuizOption function as before - LOGIC UNCHANGED]
    function selectQuizOption(optionElement) { /* ... */ }

    function submitQuiz() {
         const questions = document.querySelectorAll('#project-view #quizContainer .quiz-question');
         let answeredCount = 0, score = 0;
         const totalQuestions = questions.length;
         if (totalQuestions === 0) return;
         let firstUnanswered = null;

         // 1. Check answers and reset styles
         questions.forEach((qDiv) => {
              const selectedOption = qDiv.querySelector('.quiz-option.selected');
              qDiv.classList.remove('answered');
              qDiv.querySelectorAll('.quiz-feedback').forEach(fb => fb.style.display = 'none');
              qDiv.querySelectorAll('.quiz-option').forEach(opt => {
                   opt.classList.remove('correct', 'incorrect');
                   // Reset styles affected by answered state
                   opt.style.opacity = '';
                   opt.style.cursor = 'pointer';
                   opt.onclick = () => selectQuizOption(opt);
                   opt.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectQuizOption(opt); }};
              });
              qDiv.style.outline = ''; // Reset potential error outline
              if (selectedOption) {
                   answeredCount++;
              } else if (!firstUnanswered) {
                   firstUnanswered = qDiv;
              }
         });

         // 2. Stop if not all answered
         if (answeredCount < totalQuestions) {
             alert(`Oops! Please answer all ${totalQuestions} questions before checking!`);
             if(firstUnanswered) {
                 firstUnanswered.scrollIntoView({behavior:'smooth',block:'center'});
                 firstUnanswered.style.outline='3px solid var(--danger)'; // Use danger color outline
                 setTimeout(()=> { if(firstUnanswered) firstUnanswered.style.outline=''; }, 3000);
             }
             return;
         }

         // 3. Grade the Quiz
         questions.forEach((qDiv) => {
              const selectedOption = qDiv.querySelector('.quiz-option.selected');
              const feedbackCorrect = qDiv.querySelector('.quiz-feedback.correct');
              const feedbackIncorrect = qDiv.querySelector('.quiz-feedback.incorrect');
              const allOptions = qDiv.querySelectorAll('.quiz-option');
              qDiv.classList.add('answered');
              const isSelectedCorrect = selectedOption.getAttribute('data-is-correct') === 'true';

              allOptions.forEach(opt => {
                   const optIsCorrect = opt.getAttribute('data-is-correct') === 'true';
                   if (optIsCorrect) opt.classList.add('correct');
                   if (opt === selectedOption && !isSelectedCorrect) opt.classList.add('incorrect');
                   // Styles for answered state (opacity etc.) are now handled by CSS :not rules
                   opt.style.cursor = "default";
                   opt.onclick = null; opt.onkeydown = null;
              });

              // Provide feedback text
              if (isSelectedCorrect) {
                    score++;
                    if(feedbackCorrect) feedbackCorrect.style.display='flex'; // Use flex for icons
              } else {
                  if(feedbackIncorrect) {
                      const correctOptionElement = qDiv.querySelector('.quiz-option.correct');
                      feedbackIncorrect.innerHTML = `<i class="fas fa-times-circle"></i> Not quite. The correct answer was: "${correctOptionElement ? correctOptionElement.textContent : 'N/A'}".`; // Add icon
                      feedbackIncorrect.style.display='flex'; // Use flex for icons
                  }
              }
         });

         // 4. Show Final Result & Mark Complete
         const submitBtn = document.querySelector('#project-view #submitQuizBtn');
         if(submitBtn) submitBtn.disabled = true;

         const quizTabContent = document.querySelector('#project-view #quiz');
         let resultDiv = quizTabContent?.querySelector('.final-quiz-result');
         if (!resultDiv && quizTabContent) {
              resultDiv = document.createElement('div');
              quizTabContent.appendChild(resultDiv);
          }

          if (resultDiv) {
              const scorePercent = totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0;
              const passThreshold = 70;
              const passed = scorePercent >= passThreshold;

              // Add icons and clearer message
              const iconClass = passed ? 'fas fa-star' : 'fas fa-redo-alt';
              const iconColor = passed ? 'var(--success)' : 'var(--danger)';
              const message = passed ? 'Awesome Job!' : 'Good Try!';

              resultDiv.innerHTML = `
                  <i class="${iconClass} result-icon" style="color: ${iconColor};"></i>
                  <span>${message} You scored ${score} out of ${totalQuestions} (${scorePercent}%).</span>
                  ${!passed ? '<span style="font-size: 0.9em; margin-top: 5px;">Review the answers and try again if you like!</span>' : ''}
              `;
              resultDiv.className = 'final-quiz-result ' + (passed ? 'success' : 'fail');
              resultDiv.style.display = 'flex';
              resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

              if (passed && currentProjectId) {
                  markProjectAsCompleted(currentProjectId);
              }
              // Optionally re-enable submit button if !passed for retry?
              // if (!passed && submitBtn) submitBtn.disabled = false;
          }
    }
    // [SAME markProjectAsCompleted function as before - LOGIC UNCHANGED]
     function markProjectAsCompleted(projectId) { /* ... */ }
    // [SAME checkProjectCompletionStatus function as before - LOGIC UNCHANGED]
     function checkProjectCompletionStatus() { /* ... */ }

    // --- MODAL & EDITING LOGIC ---
    // [SAME closeModal function as before - LOGIC UNCHANGED]
    function closeModal(modalId) { /* ... */ }

    // --- Course Editor ---
    // [SAME openCourseEditModal function as before - LOGIC UNCHANGED]
    function openCourseEditModal() { /* ... */ }
    // [SAME renderProjectTabsEditor function as before - LOGIC UNCHANGED, styling handled by CSS]
     function renderProjectTabsEditor() { /* ... */ }
    // [SAME addProjectTabEditField function as before - LOGIC UNCHANGED, styling handled by CSS]
     function addProjectTabEditField() { /* ... */ }
    // [SAME removeProjectTab function as before - LOGIC UNCHANGED]
     function removeProjectTab(projectIdToRemove, buttonElement) { /* ... */ }
    // [SAME selectCourseColor, customCourseColorSelected, loadCourseColorSelections functions as before - LOGIC UNCHANGED]
    function selectCourseColor(type, color) { /* ... */ }
    function customCourseColorSelected(type, color) { /* ... */ }
    function loadCourseColorSelections() { /* ... */ }
    // [SAME saveCourseChanges function as before - LOGIC UNCHANGED]
    function saveCourseChanges() { /* ... */ }

    // --- Project Editor ---
    // [SAME openProjectEditModal function as before - LOGIC UNCHANGED]
    function openProjectEditModal() { /* ... */ }
    // [SAME createEditItemGroup function as before - LOGIC UNCHANGED]
     function createEditItemGroup(index, typePrefix, contentGenerator, removeHandler) { /* ... */ }
    // [SAME handleMediaTypeChange function as before - LOGIC UNCHANGED]
     function handleMediaTypeChange(selectElement) { /* ... */ }
    // [SAME loadLearnEditFieldsForProject function as before - LOGIC UNCHANGED]
     function loadLearnEditFieldsForProject(data, container) { /* ... */ }
    // [SAME loadSlidesEditFieldsForProject function as before - LOGIC UNCHANGED]
     function loadSlidesEditFieldsForProject(data, container) { /* ... */ }
    // [SAME loadChallengesEditFieldsForProject function as before - LOGIC UNCHANGED]
      function loadChallengesEditFieldsForProject(data, container) { /* ... */ }
    // [SAME loadQuizEditFieldsForProject function as before - LOGIC UNCHANGED]
      function loadQuizEditFieldsForProject(data, container) { /* ... */ }
    // [SAME loadProjectStyleSelections function as before - LOGIC UNCHANGED]
     function loadProjectStyleSelections(projectStyleData) { /* ... */ }
    // [SAME loadProjectColorSelections function as before - LOGIC UNCHANGED]
     function loadProjectColorSelections(projectStyleData) { /* ... */ }
    // [SAME selectProjectStyle function as before - LOGIC UNCHANGED]
     function selectProjectStyle(styleProperty, value) { /* ... */ }
    // [SAME selectProjectColor, customProjectColorSelected, clearProjectColorOverrides functions as before - LOGIC UNCHANGED]
     function selectProjectColor(type, color, applyLive = true) { /* ... */ }
     function customProjectColorSelected(type, color) { /* ... */ }
     function clearProjectColorOverrides() { /* ... */ }
    // [SAME findIndexAndRemove function as before - LOGIC UNCHANGED]
     function findIndexAndRemove(element, dataArrayName, reloadFunctionName) { /* ... */ }
    // [SAME handleRemoveLearnItem, handleRemoveSlideItem, handleRemoveChallengeItem, handleRemoveQuizItem functions as before - LOGIC UNCHANGED]
     function handleRemoveLearnItem(elementToRemove) { /* ... */ }
     function handleRemoveSlideItem(elementToRemove) { /* ... */ }
     function handleRemoveChallengeItem(elementToRemove) { /* ... */ }
     function handleRemoveQuizItem(elementToRemove) { /* ... */ }
    // [SAME addItemToProjectData function as before - LOGIC UNCHANGED]
     function addItemToProjectData(dataArrayName, maxItems, newItemObject, reloadFunctionName, containerSelector, focusSelector = null) { /* ... */ }
    // [SAME addLearnEditField, addSlideEditField, addChallengeEditField, addQuizEditField functions as before - LOGIC UNCHANGED]
     function addLearnEditField() { /* ... */ }
     function addSlideEditField() { /* ... */ }
     function addChallengeEditField() { /* ... */ }
     function addQuizEditField() { /* ... */ }
    // [SAME showProjectEditSection function as before - LOGIC UNCHANGED]
     function showProjectEditSection() { /* ... */ }
    // [SAME saveProjectChanges function as before - LOGIC UNCHANGED, includes validation]
    function saveProjectChanges() { /* ... */ }

    // --- Utility Functions ---
    // [SAME shuffleArray function as before - LOGIC UNCHANGED]
    function shuffleArray(array){/* ... */}
    // [SAME areColorsEqual function as before - LOGIC UNCHANGED]
    function areColorsEqual(color1, color2){/* ... */}

    // --- EXPORT COURSE ---
    // [SAME exportCourseHTML function as before - LOGIC UNCHANGED, relies on updated CSS and embedded JS]
    function exportCourseHTML() {
        console.log("Starting COURSE export...");
        try {
            applyCourseTheme(); // Ensure base theme applied for export styles
            const exportDocElement = document.documentElement.cloneNode(true);

            // Clean up editor UI
            exportDocElement.querySelector('#courseEditModal')?.remove();
            exportDocElement.querySelector('#projectEditModal')?.remove();
            exportDocElement.querySelectorAll('.edit-btn').forEach(btn => btn.remove());
            exportDocElement.querySelectorAll('.export-btn').forEach(btn => btn.remove());
            // KEEP .back-btn for navigation in exported file

            // Prepare viewer state
            exportDocElement.querySelector('#course-view').style.display = 'block';
            exportDocElement.querySelector('#project-view').style.display = 'none';
            const exportProjectViewEl = exportDocElement.querySelector('#project-view');
            if(exportProjectViewEl) { exportProjectViewEl.style.fontFamily = ''; exportProjectViewEl.style.fontSize = ''; }

            // Reset quiz state
            exportDocElement.querySelectorAll('.quiz-question').forEach(q => {
                q.classList.remove('answered');
                q.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected', 'correct', 'incorrect'));
                q.querySelectorAll('.quiz-feedback').forEach(f => f.style.display = 'none');
            });
            exportDocElement.querySelector('.final-quiz-result')?.remove();
            const exportSubmitBtn = exportDocElement.querySelector('#project-view #submitQuizBtn');
            if (exportSubmitBtn) exportSubmitBtn.disabled = false;

            // Embed Data and Viewer Script
            exportDocElement.querySelectorAll('script').forEach(script => script.remove()); // Remove original scripts
            const viewerScript = document.createElement('script');
            const courseDataString = JSON.stringify(courseData).replace(/</g, '\\u003c').replace(/>/g, '\\u003e');

            // MINIFIED Viewer Logic (Should be functionally identical to the editor's viewer parts)
            // NOTE: This minified script reflects the *original* functionality. It uses the *exported* HTML/CSS which now has the new design.
            viewerScript.textContent = `
// --- EXPORTED VIEWER SCRIPT (SELF-CONTAINED) ---
const courseDataForView = ${courseDataString};
let currentSlideIndex = 0; let currentProjectIdForView = null;
function shuffleArray(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}}
function hexToRgb(h){let r=/^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(h);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null}
function areColorsEqual(c1,c2){if(!c1||!c2)return c1===c2;if(c1.toLowerCase()===c2.toLowerCase())return!0;const cvt=c=>{const x=document.createElement('canvas').getContext('2d');if(!x)return null;x.fillStyle=c;const cc=x.fillStyle;if(cc.startsWith('rgba'))return cc;if(cc.startsWith('#')){const r=hexToRgb(cc);return r?\`rgba(\${r.r}, \${r.g}, \${r.b}, 1)\`:null}if(cc.startsWith('rgb('))return cc.replace('rgb(','rgba(').replace(')',', 1)');return cc};try{const r1=cvt(c1),r2=cvt(c2);return r1&&r2&&r1===r2}catch(e){console.warn("Color compare failed:",e);return String(c1).trim().toLowerCase()===String(c2).trim().toLowerCase()}}
function applyThemeClrs(p,s,a){const r=document.documentElement;r.style.setProperty('--primary',p||'#29B6F6');r.style.setProperty('--secondary',s||'#FFCA28');r.style.setProperty('--accent',a||'#FF7043');const pr=hexToRgb(p||'#29B6F6');if(pr)r.style.setProperty('--primary-rgb',\`\${pr.r}, \${pr.g}, \${pr.b}\`);const sr=hexToRgb(s||'#FFCA28');if(sr)r.style.setProperty('--secondary-rgb',\`\${sr.r}, \${sr.g}, \${sr.b}\`)}
function applyCourseThemeForView(){const cs=courseDataForView.style||{};applyThemeClrs(cs.primaryColor,cs.secondaryColor,cs.accentColor);const r=document.documentElement;r.style.setProperty('--base-font-family',"var(--base-font-family)");r.style.setProperty('--base-font-size',"var(--base-font-size)");const pv=document.getElementById('project-view');if(pv){pv.style.fontFamily='';pv.style.fontSize=''}}
function applyProjectStylesForView(p){if(!p)return;const ps=p.style||{};const cs=courseDataForView.style||{};applyThemeClrs(ps.primaryColor||cs.primaryColor,ps.secondaryColor||cs.secondaryColor,ps.accentColor||cs.accentColor);const pv=document.getElementById('project-view');if(!pv)return;pv.style.fontFamily=ps.fontFamily||'var(--base-font-family)';let ef='var(--base-font-size)';if(ps.baseSize==='small')ef='14px';else if(ps.baseSize==='large')ef='18px';else if(ps.baseSize==='medium')ef='17px';pv.style.fontSize=ef}
function showCourseView(){document.getElementById('course-view').style.display='block';document.getElementById('project-view').style.display='none';currentProjectIdForView=null;document.title=courseDataForView.title||"Course Creator Fun Zone!";applyCourseThemeForView();renderCoursePageForView();window.scrollTo(0,0)}
function showProjectView(pid){const p=courseDataForView.projects.find(pr=>pr.id===pid);if(!p){showCourseView();return}currentProjectIdForView=pid;renderProjectPageForView(p);document.getElementById('course-view').style.display='none';document.getElementById('project-view').style.display='block';document.title=p.projectTitle||"Project Fun";applyCourseThemeForView();applyProjectStylesForView(p);window.scrollTo(0,0);try{history.pushState({projectId:pid},p.projectTitle||'',\`#project-\${pid}\`)}catch(e){}}
window.onpopstate=function(e){if(e.state&&e.state.projectId){showProjectView(e.state.projectId)}else{showCourseView()}};
function renderCoursePageForView(){const c=courseDataForView;document.getElementById('courseTitle').textContent=c.title;const i=document.getElementById('courseImage');if(i){i.src=c.imageUrl||'';i.alt=c.title+" Image"}document.getElementById('courseDescription').textContent=c.description;const g=document.getElementById('projectGrid');g.innerHTML='';if(!c.projects||c.projects.length===0){g.innerHTML='<p style="text-align:center;color:var(--medium-gray);font-style:italic;padding:40px 0;">No projects here yet!</p>';return}c.projects.forEach(p=>{if(!p||!p.id)return;const t=document.createElement('a');t.className='project-tab';t.href=\`#project-\${p.id}\`;t.onclick=e=>{e.preventDefault();showProjectView(p.id)};t.innerHTML=\`<img src="\${p.tabImage||'https://via.placeholder.com/300x220/eeeeee/cccccc?text=Project+Image'}" alt="\${p.tabName||'Project'}" loading="lazy"><div class="project-tab-info"><span>\${p.tabName||'Unnamed Project'}</span></div>\`;if(p.isCompleted){const k=document.createElement('span');k.className='completion-tick';k.innerHTML='<i class="fas fa-check"></i>';k.setAttribute('aria-label','Completed');k.title='Completed!';t.appendChild(k)}g.appendChild(t)})}
function renderProjectPageForView(p){if(!p)return;const pv=document.getElementById('project-view');if(!pv)return;const h=pv.querySelector('#project-header');if(h){h.querySelector('#projectImage').src=p.projectHeaderImage||p.tabImage||'https://via.placeholder.com/120x120/eeeeee/cccccc?text=Project';h.querySelector('#projectImage').alt=p.projectTitle+" Header";h.querySelector('#projectTitle').textContent=p.projectTitle;h.querySelector('#projectSubtitle').textContent=p.projectSubtitle||'Lets get started!'}const ct=pv.querySelector('#projectTabContentContainer');if(!ct)return;const ov=ct.querySelector('#overview');if(ov){ov.querySelector('#overviewText').textContent=p.overviewText||'';renderLearnItemsForProjectView(p.learnData||[],ov.querySelector('#learnContainer'))}const vd=ct.querySelector('#video');if(vd){vd.querySelector('#videoIntroText').textContent=p.videoIntroText||'';vd.querySelector('#videoTitle').textContent=p.videoTitle||'';vd.querySelector('#mainVideo').src=p.videoUrl||'';const ul=vd.querySelector('#videoKeyPoints');ul.innerHTML='';if(p.videoKeyPoints&&p.videoKeyPoints.length>0){p.videoKeyPoints.forEach(pt=>{if(pt&&(pt.text||typeof pt==='string')){const li=document.createElement('li');if(typeof pt==='object'&&pt.icon){li.innerHTML=\`<i class="\${pt.icon}" style="color: var(--secondary); margin-right: 10px; width: 20px; text-align: center;"></i> \${pt.text}\`}else{li.innerHTML=\`<i class="fas fa-check" style="color: var(--secondary); margin-right: 10px;"></i> \${pt}\`}ul.appendChild(li)}})}if(ul.innerHTML==='')ul.innerHTML='<li style="color: #888; font-style: italic;"><i class="fas fa-times-circle" style="margin-right: 10px;"></i>No key points provided.</li>'}const sl=ct.querySelector('#slides');if(sl)renderSlideshowForProjectView(p.slidesData||[],sl.querySelector('#slideshowContainer'));const ch=ct.querySelector('#challenges');if(ch)renderChallengesForProjectView(p.challengesData||[],ch.querySelector('#challengesContainer'));const qz=ct.querySelector('#quiz');if(qz)renderQuizForProjectView(p.quizData||[],qz.querySelector('#quizContainer'),qz.querySelector('#submitQuizBtn'));const tb=pv.querySelector('#projectTabs');const ftb=tb?.querySelector('.tab');if(ftb){const ca=ftb.getAttribute('onclick')||'';const m=ca.match(/openProjectTab\\('([^']+)'/);openProjectTab(m?m[1]:'overview',ftb)}else{updateProjectProgressBar('')}}
function renderMedia(typ,url,tit){if(!url)return'';const safeTitle=tit.replace(/"/g,'&quot;');if(typ==='image')return\`<img src="\${url}" loading="lazy" alt="\${safeTitle}">\`;if(typ==='video'||typ==='iframe')return\`<iframe src="\${url}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="\${safeTitle}"></iframe>\`;return''}
function renderLearnItemsForProjectView(d,c){if(!c)return;c.innerHTML='';const v=(d||[]).filter(i=>i.title&&i.title.trim());if(v.length===0){c.innerHTML='<p style="color: #888; font-style: italic;">No learning objectives.</p>';return}v.forEach((i,x)=>{const e=document.createElement('div');e.className='step';e.innerHTML=\`<div class="step-number">\${x+1}</div><div class="step-content"><strong>\${i.title}</strong>\${i.description?\`<p class="description">\${i.description}</p>\`:''}<div class="step-media" style="display: none;"></div></div>\`;const md=e.querySelector('.step-media');const mu=renderMedia(i.mediaType,i.mediaUrl,i.title||'Media');if(mu){md.style.display='block';md.innerHTML=mu}c.appendChild(e)})}
function renderChallengesForProjectView(d,c){if(!c)return;c.innerHTML='';const v=(d||[]).filter(i=>i.title&&i.title.trim());if(v.length===0){c.innerHTML='<p style="color: #888; font-style: italic;">No challenges specified.</p>';return}v.forEach(i=>{const e=document.createElement('div');e.className='step';e.innerHTML=\`<div class="step-number" style="background-color: var(--accent); color: var(--white);"><i class="fas fa-star"></i></div><div class="step-content"><strong>\${i.title}</strong>\${i.description?\`<p class="description">\${i.description}</p>\`:''}<div class="step-media" style="display: none;"></div></div>\`;const md=e.querySelector('.step-media');const mu=renderMedia(i.mediaType,i.mediaUrl,i.title||'Media');if(mu){md.style.display='block';md.innerHTML=mu}c.appendChild(e)})}
function renderSlideshowForProjectView(d,c){const n=c?.closest('.tab-content#slides')?.querySelector('.slide-nav');if(!c||!n){return}c.innerHTML='';const v=(d||[]).filter(s=>s.url&&s.url.trim());if(v.length===0){c.innerHTML='<p style="color: #888; font-style: italic;">No slides available.</p>';n.style.display='none';return}n.style.display='flex';v.forEach((s,x)=>{const dv=document.createElement('div');dv.className='slide';const u=s.url.trim();const t=s.type==='image'?'image':'iframe';const ds=s.description||'';const ti=ds||'Slide '+(x+1);dv.innerHTML=\`<div class="slide-content-wrapper"></div>\${ds?\`<p>\${ds}</p>\`:''}\`;const w=dv.querySelector('.slide-content-wrapper');w.innerHTML=renderMedia(t,u,ti);c.appendChild(dv)});currentSlideIndex=0;showSlide(0)}
function renderQuizForProjectView(d,c,b){if(!c||!b)return;c.innerHTML='';c.closest('.tab-content#quiz')?.querySelector('.final-quiz-result')?.remove();b.disabled=!1;b.style.display='none';const v=(d||[]).filter(q=>q.questionText&&q.questionText.trim()&&q.correctAnswer&&q.correctAnswer.trim());if(v.length===0){c.innerHTML='<p style="color: #888; font-style: italic;">No quiz questions here.</p>';return}b.style.display='block';v.forEach((q,x)=>{const dv=document.createElement('div');dv.className='quiz-question';dv.innerHTML=\`<p class="question-text">\${x+1}. \${q.questionText}</p><div class="quiz-options"></div><div class="quiz-feedback correct" style="display:none;">Correct!</div><div class="quiz-feedback incorrect" style="display:none;"></div>\`;const od=dv.querySelector('.quiz-options');let os=[q.correctAnswer.trim()];(q.incorrectAnswers||[]).forEach(a=>{if(a&&a.trim())os.push(a.trim())});shuffleArray(os);os.forEach(ot=>{const cr=ot===q.correctAnswer.trim();const oe=document.createElement('div');oe.className='quiz-option';oe.textContent=ot;oe.setAttribute('role','button');oe.setAttribute('tabindex','0');oe.onclick=()=>selectQuizOption(oe);oe.onkeydown=e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();selectQuizOption(oe)}};oe.setAttribute('data-is-correct',cr.toString());od.appendChild(oe)});c.appendChild(dv)})}
function openProjectTab(tn,el){const c=document.getElementById('projectTabContentContainer');if(!c)return;c.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));const bs=document.getElementById('projectTabs');if(bs)bs.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));const t=c.querySelector('#'+tn);if(t)t.classList.add('active');el?.classList.add('active');updateProjectProgressBar(tn)}
function updateProjectProgressBar(tn){const p=document.getElementById('progressBar');if(!p)return;let r=0;const o=['overview','video','slides','challenges','quiz'];const i=o.indexOf(tn);if(i>=0)r=((i+1)/o.length)*100;p.style.width=r+'%'}
function showSlide(n){const s=document.querySelectorAll('#project-view #slideshowContainer .slide');const c=s.length;if(c===0)return;s.forEach(sl=>sl.classList.remove('active'));currentSlideIndex=(n%c+c)%c;if(s[currentSlideIndex])s[currentSlideIndex].classList.add('active')}
function nextSlide(){showSlide(currentSlideIndex+1)}function prevSlide(){showSlide(currentSlideIndex-1)}
function selectQuizOption(oe){const qd=oe.closest('.quiz-question');if(!qd||qd.classList.contains('answered'))return;qd.querySelectorAll('.quiz-option').forEach(o=>o.classList.remove('selected'));oe.classList.add('selected')}
function markProjectAsCompletedInView(pid){const p=courseDataForView.projects.find(pr=>pr.id===pid);if(p&&!p.isCompleted)p.isCompleted=!0}
function submitQuiz(){const qs=document.querySelectorAll('#project-view #quizContainer .quiz-question');let an=0,sc=0;const tt=qs.length;if(tt===0)return;let fu=null;qs.forEach(q=>{const s=q.querySelector('.quiz-option.selected');q.classList.remove('answered');q.querySelectorAll('.quiz-feedback').forEach(f=>f.style.display='none');q.querySelectorAll('.quiz-option').forEach(o=>{o.classList.remove('correct','incorrect');o.style.opacity='';o.style.cursor='pointer';o.onclick=()=>selectQuizOption(o);o.onkeydown=e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();selectQuizOption(o)}}});q.style.outline='';if(s)an++;else if(!fu)fu=q});if(an<tt){alert('Oops! Please answer all '+tt+' questions first!');if(fu){fu.scrollIntoView({behavior:'smooth',block:'center'});fu.style.outline='3px solid var(--danger)';setTimeout(()=>fu.style.outline='',3000)}return}qs.forEach(q=>{const s=q.querySelector('.quiz-option.selected');const fc=q.querySelector('.quiz-feedback.correct');const fi=q.querySelector('.quiz-feedback.incorrect');const ao=q.querySelectorAll('.quiz-option');q.classList.add('answered');const isc=s.getAttribute('data-is-correct')==='true';ao.forEach(o=>{const oc=o.getAttribute('data-is-correct')==='true';if(oc)o.classList.add('correct');if(o===s&&!isc)o.classList.add('incorrect');o.style.cursor="default";o.onclick=null;o.onkeydown=null});if(isc){sc++;if(fc)fc.style.display='flex'}else{if(fi){const co=q.querySelector('.quiz-option.correct');fi.innerHTML=\`<i class="fas fa-times-circle"></i> Not quite. The correct answer was: "\${co?co.textContent:'N/A'}"\`;fi.style.display='flex'}}});const b=document.querySelector('#project-view #submitQuizBtn');if(b)b.disabled=!0;const qc=document.querySelector('#project-view #quiz');let rd=qc?.querySelector('.final-quiz-result');if(!rd&&qc){rd=document.createElement('div');qc.appendChild(rd)}if(rd){const pc=tt>0?Math.round((sc/tt)*100):0;const ps=pc>=70;const ic=ps?'fas fa-star':'fas fa-redo-alt';const iCol=ps?'var(--success)':'var(--danger)';const msg=ps?'Awesome Job!':'Good Try!';rd.innerHTML=\`<i class="\${ic} result-icon" style="color: \${iCol};"></i><span>\${msg} You scored \${sc} out of \${tt} (\${pc}%).</span>\${!ps?'<span style="font-size: 0.9em; margin-top: 5px;">Review the answers and try again if you like!</span>':''}\`;rd.className='final-quiz-result '+(ps?'success':'fail');rd.style.display='flex';rd.scrollIntoView({behavior:'smooth',block:'center'});if(ps&&currentProjectIdForView)markProjectAsCompletedInView(currentProjectIdForView)}}
document.addEventListener('DOMContentLoaded', function() {
    applyCourseThemeForView();
    renderCoursePageForView();
    let dsp=!1;
    if (window.location.hash && window.location.hash.startsWith('#project-')) {
        const pid = window.location.hash.substring(9);
        if (courseDataForView.projects.some(p => p.id === pid)) { showProjectView(pid); dsp=!0; }
    }
    if (!dsp) showCourseView();
    console.log("Exported Course Viewer Initialized.");
});
            `;
            exportDocElement.querySelector('body').appendChild(viewerScript);

            // Generate HTML and trigger download
            const htmlContent = '<!DOCTYPE html>\n' + exportDocElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const downloadUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            const filename = (courseData.title || "course_export").replace(/[^\w\s.-]/gi, '').replace(/\s+/g, '_').toLowerCase() + '_fun_version.html'; // New filename
            a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(downloadUrl);
            console.log("Course export completed (Fun Version).");

        } catch (error) {
            console.error("Error during COURSE export:", error);
            alert("Oh no! Something went wrong while exporting the course. Check the browser console for clues.");
        }
    }

    // --- INITIAL PAGE LOAD (Editor Mode) ---
    // [SAME document.addEventListener('DOMContentLoaded') function as before - LOGIC UNCHANGED]
    document.addEventListener('DOMContentLoaded', function() { /* ... */ });

    // Add missing JS functions from original that might be needed (ensure completeness)
    // Placeholder for hexToRgb if it wasn't included above
     if (typeof hexToRgb !== 'function') {
        function hexToRgb(hex) {
          let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
          return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
        }
     }
     // Placeholder for areColorsEqual if it wasn't included above
     if (typeof areColorsEqual !== 'function') {
        function areColorsEqual(color1, color2){
            if (!color1 || !color2) return color1 === color2;
            if (color1.toLowerCase() === color2.toLowerCase()) return true;
            const convertToRgba = (color) => {
                const ctx = document.createElement('canvas').getContext('2d');
                if (!ctx) return null;
                ctx.fillStyle = color;
                const computedColor = ctx.fillStyle;
                if (computedColor.startsWith('rgba')) return computedColor;
                if (computedColor.startsWith('#')) {
                    const rgb = hexToRgb(computedColor);
                    return rgb ? `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 1)` : null;
                }
                if (computedColor.startsWith('rgb(')) {
                     return computedColor.replace('rgb(', 'rgba(').replace(')', ', 1)');
                }
                return computedColor;
            };
            try {
                const rgba1 = convertToRgba(color1);
                const rgba2 = convertToRgba(color2);
                return rgba1 && rgba2 && rgba1 === rgba2;
            } catch (e) {
                console.warn("Color comparison failed, falling back to string comparison:", e);
                return String(color1).trim().toLowerCase() === String(color2).trim().toLowerCase();
            }
        }
     }


</script>

</body>
</html>
