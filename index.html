<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Course Platform - Redesigned</title> <!-- Updated Title -->
<style>
    /* --- Base Styles & Theme --- */
    :root {
        /* Default Theme Colors */
        --primary: #4A90E2;    /* Softer Blue */
        --secondary: #F5A623; /* Orange */
        --accent: #7ED321;    /* Lime Green */
        --light: #F8F9FA;     /* Very Light Grey */
        --dark: #343A40;      /* Dark Grey */
        --text-light: #6C757D; /* Medium Grey Text */
        --white: #FFFFFF;
        --success: #28A745;    /* Standard Success Green */
        --danger: #DC3545;     /* Standard Danger Red */
        --border-color: #DEE2E6; /* Light border */

        /* Base Font Settings */
        --base-font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        --base-font-size: 16px;
        --line-height: 1.6;

        /* Layout */
        --container-max-width: 1280px;
        --sidebar-width: 240px; /* New variable for project sidebar */
        --header-height: 70px; /* Example if needed */

        /* Transitions & Effects */
        --transition-speed: 0.25s;
        --transition-ease: ease-in-out;
        --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        --card-hover-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        --border-radius: 8px; /* Consistent border radius */
    }
    html { scroll-behavior: smooth; box-sizing: border-box; font-size: var(--base-font-size); }
    *, *:before, *:after { box-sizing: inherit; }
    body {
        font-family: var(--base-font-family);
        margin: 0;
        padding: 0;
        background-color: var(--light);
        color: var(--dark);
        line-height: var(--line-height);
        transition: background-color var(--transition-speed) var(--transition-ease), color var(--transition-speed) var(--transition-ease);
    }
    .main-container { /* Renamed from .container to avoid conflict */
        max-width: var(--container-max-width);
        margin: 0 auto;
        padding: 30px 20px;
    }
    h1, h2, h3, h4, h5, h6 { margin-top: 0; margin-bottom: 0.75em; font-weight: 600; }
    h1 { font-size: 2rem; color: var(--primary); }
    h2 { font-size: 1.6rem; color: var(--primary); border-bottom: 2px solid var(--secondary); padding-bottom: 8px; margin-bottom: 25px; display: inline-block; }
    h3 { font-size: 1.3rem; color: var(--dark); margin-top: 30px; margin-bottom: 15px;}
    p { margin-bottom: 1em; }
    a { color: var(--primary); text-decoration: none; transition: color var(--transition-speed) var(--transition-ease); }
    a:hover { color: var(--secondary); text-decoration: underline; }
    button, input, select, textarea { font-family: inherit; font-size: inherit; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

    /* --- Common Header Styles --- */
    .page-header {
        background-color: var(--primary); /* Solid background */
        color: var(--white);
        padding: 30px;
        border-radius: var(--border-radius);
        margin-bottom: 35px;
        box-shadow: var(--card-shadow);
        display: flex;
        flex-direction: column; /* Stack elements vertically initially */
        align-items: center; /* Center items for mobile */
        text-align: center;
        position: relative; /* For button container */
        transition: background-color var(--transition-speed) var(--transition-ease);
    }
    .header-main-content {
        display: flex;
        flex-direction: column; /* Stack image and text on mobile */
        align-items: center;
        gap: 20px;
        width: 100%;
        margin-bottom: 20px; /* Space before buttons */
    }
     .page-header .header-image {
        width: 100px; /* Standardized size initially */
        height: 100px;
        object-fit: cover;
        border-radius: 50%; /* Circular images */
        border: 3px solid var(--white);
        flex-shrink: 0;
    }
    .page-header .header-text {
        flex-grow: 1;
    }
    .page-header .header-title {
        color: var(--white);
        margin: 0 0 5px 0;
        font-size: 1.8rem; /* Adjusted size */
        font-weight: 700;
    }
    .page-header .header-subtitle {
        color: rgba(255, 255, 255, 0.85);
        font-size: 1rem;
        margin: 0;
        font-weight: 400;
    }
    /* Edit/Export/Back Buttons Container */
    .header-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px; /* Space above buttons */
        justify-content: center; /* Center on mobile */
        flex-wrap: wrap;
        width: 100%; /* Take full width for centering */
        padding-top: 15px;
        border-top: 1px solid rgba(255,255,255,0.2);
    }
    .header-actions .icon-btn {
        background-color: rgba(255, 255, 255, 0.15);
        color: var(--white);
        border: 1px solid rgba(255, 255, 255, 0.5);
        width: 38px;
        height: 38px;
        border-radius: 50%;
        cursor: pointer;
        display: inline-flex; /* Changed from flex */
        align-items: center;
        justify-content: center;
        font-size: 18px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: background-color var(--transition-speed), transform var(--transition-speed), box-shadow var(--transition-speed);
        text-decoration: none;
        line-height: 1; /* Ensure icon is centered */
    }
    .header-actions .icon-btn:hover {
        background-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .header-actions .back-btn { font-size: 22px; } /* Make back arrow slightly larger */


    /* --- Course View Specific Styles --- */
    #course-view { animation: fadeIn 0.5s; }
    #course-info-section { /* Replaces course-description-container */
        background-color: var(--white);
        padding: 25px;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin-bottom: 30px;
        border: 1px solid var(--border-color);
    }
    #course-info-section h2 { margin-bottom: 15px; font-size: 1.4rem; border-bottom: none; padding-bottom: 0; display: block; }
    #course-info-section p { color: var(--text-light); font-size: 1rem; }

    #projectGrid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* Slightly wider cards */
        gap: 25px;
    }
    .project-card { /* Renamed from project-tab */
        background-color: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        overflow: hidden;
        cursor: pointer;
        transition: transform var(--transition-speed) var(--transition-ease), box-shadow var(--transition-speed) var(--transition-ease);
        display: flex;
        flex-direction: column;
        text-decoration: none;
        color: inherit;
        position: relative; /* For completion tick */
        border: 1px solid var(--border-color);
    }
    .project-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--card-hover-shadow);
    }
    .project-card img {
        width: 100%;
        height: 180px; /* Slightly shorter image */
        object-fit: cover;
        display: block;
        border-bottom: 1px solid var(--border-color);
    }
    .project-card-info {
        padding: 20px;
        flex-grow: 1;
        display: flex; /* To push completion tick if needed, or center text */
        flex-direction: column; /* Stack title and potentially other info */
        justify-content: center; /* Center content vertically */
        text-align: center; /* Center text horizontally */
    }
    .project-card-info span {
        font-weight: 600;
        color: var(--primary);
        font-size: 1.1rem;
        line-height: 1.4; /* Ensure good line spacing */
        transition: color var(--transition-speed) var(--transition-ease);
    }
    .completion-tick { /* Style remains similar */
        position: absolute;
        top: 10px;
        right: 10px;
        width: 28px;
        height: 28px;
        background-color: var(--accent); /* Use accent color */
        color: var(--white);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: bold;
        line-height: 1;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 5;
        border: 1px solid var(--white); /* Add border for contrast */
    }

    /* --- Project View Specific Styles --- */
    #project-view {
        display: flex; /* Changed from block to flex for sidebar layout */
        gap: 25px; /* Gap between sidebar and content */
        animation: fadeIn 0.5s;
        /* Project specific font/size applied here via JS */
    }
    /* Project Sidebar Navigation */
    #project-nav {
        width: var(--sidebar-width);
        flex-shrink: 0;
        background-color: var(--white);
        padding: 20px 0; /* Padding top/bottom, no side padding */
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        border: 1px solid var(--border-color);
        align-self: flex-start; /* Stick to top */
        position: sticky; /* Make sidebar sticky */
        top: 20px; /* Adjust top spacing as needed */
        max-height: calc(100vh - 40px); /* Limit height */
        overflow-y: auto; /* Allow scrolling if needed */
    }
    #project-nav .nav-link { /* Replaces .tab */
        display: block;
        padding: 12px 20px;
        color: var(--text-light);
        font-weight: 500;
        border-left: 4px solid transparent; /* Indicator for active state */
        margin-bottom: 4px; /* Spacing between links */
        transition: background-color var(--transition-speed), color var(--transition-speed), border-left-color var(--transition-speed);
        cursor: pointer;
        font-size: 0.95rem;
    }
    #project-nav .nav-link:hover {
        background-color: var(--light);
        color: var(--primary);
    }
    #project-nav .nav-link.active {
        background-color: #e9ecef; /* Light active background */
        color: var(--primary);
        font-weight: 600;
        border-left-color: var(--secondary); /* Use secondary for active indicator */
    }

    /* Project Main Content Area */
    #project-main-content {
        flex-grow: 1;
        min-width: 0; /* Prevent content overflow issues in flexbox */
    }
    /* Project Progress Bar - Moved Above Header */
    .progress-container {
        width: 100%;
        background-color: var(--border-color);
        border-radius: 20px; /* More rounded */
        margin-bottom: 20px; /* Space below progress bar */
        height: 10px;
        overflow: hidden;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        border-radius: 20px;
        width: 0%;
        transition: width 0.5s ease-in-out, background var(--transition-speed) var(--transition-ease);
    }
     /* Project Header Adjustments */
     #project-view .page-header {
        margin-bottom: 25px; /* Standard margin */
     }
     #project-view .page-header .header-image { width: 90px; height: 90px; } /* Slightly smaller project image */
     #project-view .page-header .header-title { font-size: 1.7rem; }
     #project-view .page-header .header-subtitle { font-size: 0.95rem; }


    /* Project Content Sections Styling */
    .content-section { /* Replaces .tab-content */
        display: none; /* Hidden by default */
        background-color: var(--white);
        padding: 30px; /* More padding */
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        animation: fadeIn 0.4s ease-out;
        margin-bottom: 25px; /* Space between sections if multiple were visible */
        border: 1px solid var(--border-color);
    }
    .content-section.active { display: block; }
    .content-section h2 { font-size: 1.5rem; margin-bottom: 20px; border-bottom-color: var(--primary); } /* Section title style */
    .content-section h3 { font-size: 1.2rem; margin-top: 25px; margin-bottom: 15px; color: var(--primary); }


    /* --- Component Styling (Mostly similar, minor tweaks) --- */

    /* Video */
    .video-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;margin:20px 0;border-radius:var(--border-radius);box-shadow:var(--card-shadow)}
    .video-container iframe{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:var(--border-radius);border:none}

    /* Slideshow */
    .slide{display:none;text-align:center}
    .slideshow{position:relative;margin:20px 0;background-color:var(--light);padding:20px;border-radius:var(--border-radius); border: 1px solid var(--border-color);}
    .slide-content-wrapper{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;margin:0 auto 20px;max-width:100%;background-color:#e9ecef;border-radius:var(--border-radius)}
    .slide iframe,.slide img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;border-radius:var(--border-radius);box-shadow:0 4px 12px rgba(0,0,0,.1);background-color:transparent; border: none;}
    .slide p{margin:15px 0 0;font-size:.95rem;color:var(--text-light)}
    .slide.active{display:block;animation:fadeIn .5s}
    .slide-nav { text-align: center; margin-top: 20px; display: flex; justify-content: space-between; gap: 15px; }
    .slide-nav button{background-color:var(--primary);color:var(--white);border:none;padding:10px 20px;border-radius:25px;cursor:pointer;font-size:1rem;transition:background-color .3s,transform .2s, box-shadow .3s; box-shadow: 0 2px 5px rgba(0,0,0,.1);}
    .slide-nav button:hover{background-color: var(--secondary); transform:scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,.15);}

    /* Step-by-Step (Used for Learn & Challenges) */
    .step{display:flex;gap:20px;margin-bottom:25px;padding:20px;background-color: #fdfdff; border-radius:var(--border-radius);align-items:flex-start;border-left:5px solid var(--secondary);box-shadow: 0 2px 6px rgba(0,0,0,.05); transition: border-color var(--transition-speed) var(--transition-ease); border: 1px solid var(--border-color);}
    .step-number{background-color:var(--secondary);color:var(--white);min-width:35px;height:35px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;font-size:1rem;margin-top:4px; transition: background-color var(--transition-speed) var(--transition-ease);}
    .step-content{flex:1;display:flex;flex-direction:column}
    .step-content strong{font-size:1.1rem;color:var(--primary);display:block;margin-bottom:8px; transition: color var(--transition-speed) var(--transition-ease); font-weight: 600;}
    .step-content p.description{margin:0 0 15px;font-size:1rem;color: var(--text-light);line-height:1.6}
    .step-content p.description:last-child{margin-bottom:0}
    .step-content .step-media{margin-top:15px;max-width:100%;width:100%;overflow:hidden;border-radius:var(--border-radius);background-color:#f0f0f0}
    .step-content .step-media img, .step-content .step-media iframe{display:block;max-width:100%;height:auto;border-radius:var(--border-radius);box-shadow:0 3px 8px rgba(0,0,0,.1); border: none;}
    .step-content .step-media iframe{aspect-ratio:16/9;}

    /* Quiz Styling */
    .quiz-question{background-color:#fdfdff;padding:25px;margin-bottom:20px;border-radius:var(--border-radius);box-shadow:0 3px 8px rgba(0,0,0,0.05);border:1px solid var(--border-color)}
    .quiz-question p.question-text{margin:0 0 20px;font-size:1.1rem;font-weight:600;color:var(--dark)}
    .quiz-options{margin-top:15px;display:flex;flex-direction:column;gap:10px}
    .quiz-option{display:block;padding:14px 18px;margin-bottom:0;background-color:var(--light);border:1px solid var(--border-color);border-radius:var(--border-radius);cursor:pointer;transition:all .3s ease;font-size:1rem;position:relative;text-align:left;opacity:1}
    .quiz-option:hover{background-color:#e9ecef;border-color:#adb5bd;transform:translateX(3px);}
    .quiz-option.selected{border-color:var(--primary);background-color: #ddeafd; font-weight: 500;}
    .quiz-option.correct{background-color:var(--success);color:var(--white);border-color:#1f7a36;font-weight:700}
    .quiz-option.correct.selected{background-color:var(--success);color:var(--white);border-color:#1f7a36}
    .quiz-option.incorrect.selected{background-color:var(--danger);color:var(--white);border-color:#a52834;font-weight:700;text-decoration:line-through;text-decoration-thickness:2px;border-color:#a52834!important}
    .quiz-question.answered .quiz-option:not(.selected):not(.correct){opacity:.6;cursor:default;background-color:var(--light);border-color:var(--border-color);text-decoration:none; transform: none;}
    .quiz-question.answered .quiz-option.correct:not(.selected){opacity:1} /* Show correct even if not selected */
    .quiz-feedback{margin-top:15px;padding:12px 18px;border-radius:var(--border-radius);display:none;font-size:.9rem;border-width:1px;border-style:solid; font-weight: 500;}
    .quiz-feedback.correct{background-color:#d4edda;color:#155724;border-color:#c3e6cb}
    .quiz-feedback.incorrect{background-color:#f8d7da;color:#721c24;border-color:#f5c6cb}
    .final-quiz-result{margin-top:25px;padding:18px;border-radius:var(--border-radius);text-align:center;font-weight:700;font-size:1.15rem}
    .final-quiz-result.success{background-color:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .final-quiz-result.fail{background-color:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .submit-btn{background-color:var(--secondary);color:var(--dark);border:none;padding:14px 30px;border-radius:30px;font-weight:700;cursor:pointer;margin-top:30px;font-size:1.05rem;transition:all .3s;display:block;width:100%;max-width:280px;margin-left:auto;margin-right:auto;box-shadow:0 3px 8px rgba(0,0,0,.15); transition: background-color var(--transition-speed) var(--transition-ease), color var(--transition-speed) var(--transition-ease), box-shadow var(--transition-speed) var(--transition-ease), transform var(--transition-speed) var(--transition-ease);}
    .submit-btn:hover:not(:disabled){background-color: #e0910e; /* Darker orange */ box-shadow:0 5px 12px rgba(0,0,0,.2);transform:translateY(-2px)}
    .submit-btn:disabled{background-color:#adb5bd;color:#6c757d;cursor:not-allowed;box-shadow:none;transform:none;opacity:.7}

    /* --- Modal Styles --- */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.6); z-index:1000;overflow-y:auto;padding:30px 15px}
    .modal-content{background-color:var(--white);margin:5vh auto;padding:30px;border-radius:var(--border-radius);width:90%;max-width:900px; /* Slightly wider */ box-shadow:0 10px 30px rgba(0,0,0,.2);position:relative}
    .close-modal{position:absolute;top:15px;right:20px;font-size:30px;font-weight:700;color:#adb5bd;cursor:pointer;line-height:1;z-index:1001;padding:0px 5px;transition: color 0.3s;}
    .close-modal:hover{color:var(--danger)}
    .modal h2 { margin-bottom: 25px; color: var(--primary); border-bottom: 2px solid var(--secondary); padding-bottom: 10px;}
    .edit-form{margin-top:20px}
    .edit-form label{display:block;margin-bottom:6px;font-weight:600;color:var(--primary);font-size:.9rem}
    .edit-form input[type=text],.edit-form input[type=url],.edit-form textarea,.edit-form select{width:100%;padding:10px 12px;margin-bottom:15px;border:1px solid var(--border-color);border-radius:var(--border-radius);font-size:1rem;box-sizing:border-box; transition: border-color 0.3s, box-shadow 0.3s;}
    .edit-form input:focus, .edit-form textarea:focus, .edit-form select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(var(--primary-rgb, 74, 144, 226), 0.2); }
    .edit-form textarea{resize:vertical;min-height:100px}

    /* Buttons inside modals */
    .edit-form button, button.remove-item-btn, button.add-item-btn{
         background-color: var(--primary); color: var(--white); border: none; padding: 9px 16px; border-radius:var(--border-radius);
         cursor: pointer; margin-right: 10px; margin-top: 10px; font-size: .9rem; font-weight: 500; transition: background-color .3s, transform 0.2s, box-shadow 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .edit-form button:hover:not([disabled]), button.remove-item-btn:hover:not([disabled]), button.add-item-btn:hover:not([disabled]){ background-color: var(--secondary); color: var(--dark); transform: translateY(-1px); box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
    /* Save/Cancel specifically */
    .modal-actions { margin-top: 30px; text-align: right; border-top: 1px solid var(--border-color); padding-top: 20px; }
    .modal-actions button { display: inline-block; }
    .modal-actions button[type="submit"] { background-color: var(--success); } /* Target submit button */
    .modal-actions button[type="submit"]:hover { background-color: #218838; }
    .modal-actions button[onclick^="closeModal"] { background-color: #6c757d; margin-right: 0; }
    .modal-actions button[onclick^="closeModal"]:hover { background-color: #5a6268; }

    button.remove-item-btn{background-color:var(--danger);margin-left:10px;font-weight:700;line-height:1;padding:6px 10px; width: 32px; height: 32px; font-size: 1rem; display: flex; align-items: center; justify-content: center; box-shadow: none;}
    button.remove-item-btn:hover{background-color:#c82333; transform: scale(1.05);}
    button.add-item-btn{background-color:var(--accent); color: var(--dark); display:inline-block; margin-top:15px;margin-left:0;margin-right:0;width:fit-content}
    button.add-item-btn:hover{background-color:#69b01a} /* Darker green */
    .edit-section{margin-top:25px;padding-top:20px;border-top:1px solid var(--border-color)}
    .edit-item-group{margin-bottom:25px;padding:20px;border:1px solid var(--border-color);border-radius:var(--border-radius);background-color:#fdfdff;position:relative; box-shadow: 0 1px 3px rgba(0,0,0,0.04);}
    .edit-item-group .remove-item-btn{position:absolute;top:15px;right:15px;}
    .edit-item-group>label[for$="-title"], .edit-item-group>label[for$="-url"], .edit-item-group>label[for$="-question"] {font-weight:700;color:var(--dark);font-size:1rem;margin-top:5px; display: block; margin-bottom: 10px;} /* Bold key labels */
    .edit-item-group label{font-weight:500;color:#555;font-size:.9rem} /* Default labels inside group */
    .edit-item-group input[type=text],.edit-item-group input[type=url],.edit-item-group textarea,.edit-item-group select{margin-bottom:12px}
    .media-controls{margin-top:15px;padding-top:15px;border-top:1px dashed var(--border-color)}
    .media-controls label{font-weight:500;color:#555;font-size:.9rem}
    .media-url-input-container { margin-top: 8px; }
    .incorrect-answer-label{font-size:.9rem;color:#777;margin-top:10px;font-weight:500}

    /* Style Editor Sections */
    .color-picker { display: flex; gap: 12px; margin-bottom: 18px; flex-wrap: wrap; align-items: center; }
    .color-option { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid #ddd; transition: transform .2s, border-color .2s, box-shadow .2s; }
    .color-option.selected { border: 3px solid var(--dark); transform: scale(1.15); box-shadow: 0 0 8px rgba(0,0,0,0.2); }
    input[type=color] { width: 38px; height: 38px; border: 1px solid #ccc; padding: 2px; border-radius: 50%; overflow: hidden; cursor: pointer; vertical-align: middle; background-color: white;}
    input[type=color]::-webkit-color-swatch-wrapper { padding: 0; }
    input[type=color]::-webkit-color-swatch { border: none; border-radius: 50%; }
    input[type=color].inherited-style { border: 2px dashed #aaa !important; }

    .font-selector, .size-selector{display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap}
    .font-option, .size-option{padding:6px 14px;border:1px solid var(--border-color);border-radius:var(--border-radius);cursor:pointer;transition:background-color .3s,color .3s, border-color .3s; font-size: 0.9rem; background-color: var(--light); }
    .font-option.selected, .size-option.selected{background-color:var(--primary);color:var(--white);border-color:var(--primary); font-weight: 500;}
    .font-option:hover:not(.selected), .size-option:hover:not(.selected) { background-color: #e9ecef; border-color: #adb5bd;}

    /* --- Course Editor Specific Styles --- */
    #courseEditModal #projectTabsEditor { margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border-color); }
    #projectTabsEditor h4 { margin-bottom: 18px; color: var(--primary); display: block; border-bottom: none; padding-bottom: 0; font-size: 1.2rem; font-weight: 600; }
    #projectTabsList { max-height: 400px; overflow-y: auto; padding-right: 10px; margin-top: 15px; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 10px; background-color: #f8f9fa;}
    .project-tab-edit-item { display: grid; grid-template-columns: auto 1fr auto; gap: 15px; align-items: center; padding: 15px; border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 12px; background-color: var(--white); box-shadow: 0 1px 3px rgba(0,0,0,0.04);}
    .project-tab-edit-item .index { font-weight: bold; font-size: 1rem; color: var(--secondary); }
    .project-tab-edit-item .inputs { display: flex; flex-direction: column; gap: 8px;}
    .project-tab-edit-item label { font-size: 0.85rem; margin-bottom: 3px; color: #555; font-weight: 500;}
    .project-tab-edit-item input { padding: 8px; font-size: 0.9rem;}

    /* Project Editor Specific Styling */
    #projectEditModal .edit-section h4, #courseEditModal .edit-section h4{
        color: var(--primary); margin-bottom: 15px; padding-bottom: 6px; border-bottom: 2px solid var(--secondary); display: inline-block; font-size: 1.15rem; font-weight: 600;
    }
     #projectEditModal .edit-section h5{
        color: var(--dark); margin-top: 25px; margin-bottom: 12px; font-size: 1.05rem; font-weight: 600;
     }
     #projectEditModal #editingProjectNameLabel { color: var(--secondary); font-weight: bold; }
     #projectEditModal .form-hint { font-size: 0.85rem; color: var(--text-light); margin-top: -10px; margin-bottom: 15px; font-style: italic; }


    /* --- Media Queries --- */
    @media (min-width: 768px){
        .page-header {
            flex-direction: row; /* Side-by-side on desktop */
            text-align: left;
            align-items: center; /* Align items vertically */
        }
         .header-main-content {
             flex-direction: row; /* Image and text side-by-side */
             align-items: center;
             margin-bottom: 0; /* Remove bottom margin */
             gap: 30px;
         }
         .page-header .header-image { width: 120px; height: 120px; } /* Larger header image on desktop */
         #course-view .page-header .header-image { width: 140px; height: 140px; } /* Even larger for course */
         .page-header .header-title{font-size:2rem}
         .page-header .header-subtitle{font-size:1.1rem}
         .header-actions {
             margin-top: 0; /* Remove top margin */
             justify-content: flex-end; /* Align buttons to the right */
             border-top: none;
             padding-top: 0;
             width: auto; /* Allow it to shrink */
             position: absolute; /* Position absolutely */
             top: 30px; /* Adjust as needed */
             right: 30px;
         }

         .step{align-items:center}
         .step-number{margin-top:0;}
         .step-content .step-media{max-width:70%} /* Limit media width in steps */
    }

    @media (max-width: 992px) { /* Tablet breakpoint */
        #project-view {
            flex-direction: column; /* Stack sidebar and content */
        }
        #project-nav {
            width: 100%; /* Full width */
            position: relative; /* No longer sticky */
            top: auto;
            max-height: none; /* Remove height limit */
            display: flex; /* Arrange items horizontally */
            overflow-x: auto; /* Allow horizontal scroll */
            padding: 10px;
             box-shadow: none;
             border-bottom: 2px solid var(--border-color); /* Add bottom border */
             border-left: none; border-right: none; border-top: none; /* Remove other borders */
             border-radius: 0; /* Remove border radius */
        }
        #project-nav .nav-link {
             flex-shrink: 0; /* Prevent shrinking */
             border-left: none; /* Remove left border indicator */
             border-bottom: 4px solid transparent; /* Use bottom border indicator */
             margin-bottom: 0;
             margin-right: 5px; /* Spacing between horizontal tabs */
             border-radius: var(--border-radius) var(--border-radius) 0 0; /* Top corners rounded */
             padding: 10px 15px; /* Adjust padding */
        }
        #project-nav .nav-link.active {
            border-bottom-color: var(--secondary); /* Active indicator */
            background-color: var(--white); /* Make active stand out more */
        }
         /* Add scrollbar styling for horizontal tabs */
        #project-nav::-webkit-scrollbar{height:5px;background-color:#eee;}
        #project-nav::-webkit-scrollbar-thumb{background-color:var(--secondary);border-radius:3px;}
    }

    @media (max-width: 767px) { /* Mobile breakpoint */
        .main-container { padding: 20px 15px; }
        .page-header { padding: 20px; }
        .header-main-content { gap: 15px; }
        .page-header .header-image { width: 80px; height: 80px; }
        .page-header .header-title { font-size: 1.5rem; }
        .page-header .header-subtitle { font-size: 0.9rem; }
        .header-actions { justify-content: center; position: static; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;} /* Center buttons below */
         h2 { font-size: 1.4rem; }
         h3 { font-size: 1.15rem; }

        .content-section { padding: 20px; }
        .step { flex-direction: column; align-items: flex-start; gap: 10px; }
        .step-number { margin-top: 0; margin-bottom: 10px; }
        .step-content .step-media{max-width:100%}

        .modal-content{padding:20px}
        .modal-actions { text-align: center; }
        .modal-actions button { width: 48%; margin: 5px 1%; } /* Stack buttons */
        .modal-actions button[onclick^="closeModal"] { margin-right: 1%; }

        /* Ensure horizontal tabs on mobile */
        #project-nav { display: flex; overflow-x: auto; width: 100%; padding: 8px 5px; justify-content: flex-start;}
        #project-nav .nav-link { flex-shrink: 0; font-size: 0.9rem; padding: 8px 12px;}

        .project-card img { height: 150px; }
    }

</style>
</head>
<body>

<!-- Container for the whole application -->
<div class="main-container">

    <!-- == COURSE VIEW (Visible by default) == -->
    <div id="course-view">
        <header class="page-header" id="course-header">
            <!-- Main Info (Image & Text) -->
            <div class="header-main-content">
                <img src="https://images.unsplash.com/photo-1619410283995-43d9134e7656?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NXx8cHJvZ3JhbW1pbmd8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60" alt="Course Image" class="header-image" id="courseImage">
                <div class="header-text">
                    <h1 class="header-title" id="courseTitle">Course Title</h1>
                    <!-- Subtitle could go here if needed -->
                </div>
            </div>
            <!-- Action Buttons -->
            <div class="header-actions">
                 <button class="icon-btn edit-btn" onclick="openCourseEditModal()" aria-label="Edit Course Details" title="Edit Course">✏️</button>
                 <button class="icon-btn export-btn" onclick="exportCourseHTML()" aria-label="Export Course HTML" title="Export Course">⬇️</button>
            </div>
        </header>

        <!-- Course Description Section -->
        <section id="course-info-section">
            <h2>About This Course</h2>
            <p id="courseDescription">Loading course description...</p>
        </section>

        <!-- Projects Section -->
        <section>
            <h2>Projects</h2>
            <div id="projectGrid">
                <!-- Project cards will be dynamically inserted here -->
                <p>Loading projects...</p>
            </div>
        </section>
    </div>

    <!-- == PROJECT VIEW (Hidden by default, uses flex layout) == -->
    <div id="project-view" style="display: none;">

        <!-- Project Sidebar Navigation -->
        <nav id="project-nav">
            <!-- Navigation links are dynamically generated or hardcoded -->
            <!-- Example structure (content loaded dynamically) -->
            <a class="nav-link active" onclick="openProjectTab('overview', this)">Overview</a>
            <a class="nav-link" onclick="openProjectTab('video', this)">Video Lesson</a>
            <a class="nav-link" onclick="openProjectTab('slides', this)">Step-by-Step</a>
            <a class="nav-link" onclick="openProjectTab('challenges', this)">Challenges</a>
            <a class="nav-link" onclick="openProjectTab('quiz', this)">Quiz</a>
        </nav>

        <!-- Project Main Content Area -->
        <div id="project-main-content">
             <!-- Progress Bar (Moved Above Header) -->
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <!-- Project Header (Populated Dynamically) -->
            <header class="page-header" id="project-header">
                 <!-- Main Info (Image & Text) -->
                 <div class="header-main-content">
                     <img src="" alt="Project Image" class="header-image" id="projectImage">
                     <div class="header-text">
                        <h1 class="header-title" id="projectTitle">Project Title</h1>
                        <p class="header-subtitle" id="projectSubtitle">Project Subtitle</p>
                     </div>
                 </div>
                 <!-- Action Buttons -->
                 <div class="header-actions">
                    <button class="icon-btn back-btn" id="backToCourseBtn" onclick="showCourseView()" aria-label="Back to Course" title="Back to Course">←</button>
                    <button class="icon-btn edit-btn" onclick="openProjectEditModal()" aria-label="Edit Project" title="Edit Project">✏️</button>
                 </div>
            </header>

            <!-- Project Content Sections -->
            <main id="projectTabContentContainer">
                <!-- Sections now use .content-section class -->
                 <section id="overview" class="content-section active">
                     <h2>About This Project</h2>
                     <p id="overviewText">Loading overview...</p>
                     <h3>What You'll Learn</h3>
                     <div id="learnContainer"><p>Loading learning objectives...</p></div>
                 </section>
                 <section id="video" class="content-section">
                     <h2>Video Lesson</h2>
                     <p id="videoIntroText"></p>
                     <h3 id="videoTitle"></h3>
                     <div class="video-container">
                         <iframe src="" frameborder="0" loading="lazy" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen id="mainVideo" title="Project Video"></iframe>
                     </div>
                     <h3>Key Points</h3>
                     <ul id="videoKeyPoints" style="padding-left: 25px; list-style: disc;"><p>Loading key points...</p></ul>
                 </section>
                 <section id="slides" class="content-section">
                     <h2>Step-by-Step Guide</h2>
                     <div class="slideshow" id="slideshowContainer"><p>Loading slides...</p></div>
                     <nav class="slide-nav">
                         <button onclick="prevSlide()">Previous</button>
                         <button onclick="nextSlide()">Next</button>
                     </nav>
                 </section>
                 <section id="challenges" class="content-section">
                     <h2>Project Challenges</h2>
                     <p>Try these challenges to test your skills:</p>
                     <div id="challengesContainer"><p>Loading challenges...</p></div>
                 </section>
                 <section id="quiz" class="content-section">
                     <h2>Project Quiz</h2>
                     <p>Test your knowledge from this project:</p>
                     <div id="quizContainer"><p>Loading quiz...</p></div>
                     <!-- Final result area added by script -->
                     <button class="submit-btn" id="submitQuizBtn" onclick="submitQuiz()">Submit Quiz</button>
                 </section>
            </main>
        </div><!-- End #project-main-content -->

    </div><!-- End #project-view -->

</div><!-- End .main-container -->


<!-- ==== MODALS (Structure remains the same, styling slightly adjusted via CSS) ==== -->

<!-- == COURSE Editor Modal == -->
<div id="courseEditModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('courseEditModal')" title="Close Editor" aria-label="Close Course Editor">&times;</span>
        <h2>Edit Course Details</h2>
        <form class="edit-form" onsubmit="event.preventDefault(); saveCourseChanges();">
            <section class="edit-section" style="border-top: none; padding-top: 0;">
                <h4>Course Metadata</h4>
                <label for="editCourseTitle">Course Title:</label>
                <input type="text" id="editCourseTitle" required>

                <label for="editCourseImage">Course Header Image URL:</label>
                <input type="url" id="editCourseImage" placeholder="https://example.com/image.jpg">

                <label for="editCourseDescription">Course Description:</label>
                <textarea id="editCourseDescription" rows="6"></textarea>
            </section>

            <!-- Course Theme Color Editor -->
            <section id="courseStyleEditor" class="edit-section">
                 <h4>Course Theme Colors</h4>
                 <p class="form-hint">Set the main colors used globally unless overridden by a specific project.</p>
                 <label>Primary Color:</label>
                 <div class="color-picker">
                     <div class="color-option" style="background-color: #4A90E2;" onclick="selectCourseColor('primary', '#4A90E2')" title="Blue"></div>
                     <div class="color-option" style="background-color: #F5A623;" onclick="selectCourseColor('primary', '#F5A623')" title="Orange"></div>
                     <div class="color-option" style="background-color: #7ED321;" onclick="selectCourseColor('primary', '#7ED321')" title="Green"></div>
                     <div class="color-option" style="background-color: #BD10E0;" onclick="selectCourseColor('primary', '#BD10E0')" title="Purple"></div>
                     <div class="color-option" style="background-color: #4A4A4A;" onclick="selectCourseColor('primary', '#4A4A4A')" title="Dark Grey"></div>
                     <input type="color" id="coursePrimaryColorPicker" oninput="customCourseColorSelected('primary', this.value)" aria-label="Custom Primary Color">
                 </div>
                 <label>Secondary Color:</label>
                 <div class="color-picker">
                    <div class="color-option" style="background-color: #F5A623;" onclick="selectCourseColor('secondary', '#F5A623')" title="Orange"></div>
                    <div class="color-option" style="background-color: #4A90E2;" onclick="selectCourseColor('secondary', '#4A90E2')" title="Blue"></div>
                     <div class="color-option" style="background-color: #7ED321;" onclick="selectCourseColor('secondary', '#7ED321')" title="Green"></div>
                     <div class="color-option" style="background-color: #BD10E0;" onclick="selectCourseColor('secondary', '#BD10E0')" title="Purple"></div>
                     <div class="color-option" style="background-color: #D0021B;" onclick="selectCourseColor('secondary', '#D0021B')" title="Red"></div>
                     <input type="color" id="courseSecondaryColorPicker" oninput="customCourseColorSelected('secondary', this.value)" aria-label="Custom Secondary Color">
                 </div>
                 <label>Accent Color:</label>
                 <div class="color-picker">
                      <div class="color-option" style="background-color: #7ED321;" onclick="selectCourseColor('accent', '#7ED321')" title="Green"></div>
                      <div class="color-option" style="background-color: #F5A623;" onclick="selectCourseColor('accent', '#F5A623')" title="Orange"></div>
                       <div class="color-option" style="background-color: #4A90E2;" onclick="selectCourseColor('accent', '#4A90E2')" title="Blue"></div>
                      <div class="color-option" style="background-color: #BD10E0;" onclick="selectCourseColor('accent', '#BD10E0')" title="Purple"></div>
                      <div class="color-option" style="background-color: #D0021B;" onclick="selectCourseColor('accent', '#D0021B')" title="Red"></div>
                     <input type="color" id="courseAccentColorPicker" oninput="customCourseColorSelected('accent', this.value)" aria-label="Custom Accent Color">
                 </div>
            </section>

            <!-- Project Tabs Editor -->
            <section id="projectTabsEditor" class="edit-section">
                 <h4>Manage Project Tabs</h4>
                 <div id="projectTabsList">
                     <!-- Project tab edit items will be listed here -->
                 </div>
                 <button type="button" class="add-item-btn" onclick="addProjectTabEditField()">+ Add New Project Tab</button>
            </section>

            <div class="modal-actions">
                 <button type="button" onclick="closeModal('courseEditModal')">Cancel</button>
                 <button type="submit">Save Course</button>
            </div>
        </form>
    </div>
</div>


<!-- == PROJECT Editor Modal == -->
<div id="projectEditModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('projectEditModal')" title="Close Editor" aria-label="Close Project Editor">&times;</span>
        <h2>Edit Project Details</h2>
         <p style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 20px;">Editing project: <strong id="editingProjectNameLabel"></strong></p>
        <form class="edit-form" onsubmit="event.preventDefault(); saveProjectChanges();">
             <input type="hidden" id="editingProjectId"> <!-- Store ID of project being edited -->

            <label for="editSectionProject">Select Section to Edit:</label>
            <select id="editSectionProject" onchange="showProjectEditSection()">
                <option value="projMeta">Project Header & Course Tab</option>
                <option value="overview">Overview & Learn</option>
                <option value="video">Video Lesson</option>
                <option value="slides">Step-by-Step Slides</option>
                <option value="challenges">Challenges</option>
                <option value="quiz">Quiz Questions</option>
                <option value="projStyle">Project Styles (Font, Size, Colors)</option>
            </select>

            <!-- Editing Sections (Content remains the same, just wrapped in styled containers) -->
            <section id="projMetaEdit" class="edit-section" style="border-top: none; padding-top: 10px;">
                 <h4>Project Header & Course Tab</h4>
                <label for="editProject_Title">Project Title:</label>
                <input type="text" id="editProject_Title" required>
                <label for="editProject_Subtitle">Subtitle:</label>
                <input type="text" id="editProject_Subtitle" placeholder="Short description for project page header">
                <label for="editProject_HeaderImage">Project Header Image URL:</label>
                <input type="url" id="editProject_HeaderImage" placeholder="https://example.com/header.png">
                <p class="form-hint">Appears on the project page (sidebar layout). ~90x90px circle recommended.</p>
                 <hr style="margin: 20px 0;">
                 <label for="editProject_TabName">Tab Name (on Course Page):</label>
                 <input type="text" id="editProject_TabName" required placeholder="e.g., Beating Heart">
                 <label for="editProject_TabImage">Card Image URL (on Course Page):</label>
                 <input type="url" id="editProject_TabImage" placeholder="https://example.com/grid-image.jpg">
                 <p class="form-hint">Appears on the main course grid card. Landscape (~300x180px) recommended.</p>
            </section>

            <section id="overviewEdit" class="edit-section" style="display:none;">
                 <h4>Overview Content</h4>
                <label for="editProject_OverviewText">Overview Text:</label>
                <textarea id="editProject_OverviewText" rows="5" placeholder="Describe the project..."></textarea>
                 <hr style="margin: 25px 0;">
                  <h4>"What You'll Learn" Items</h4>
                  <div id="learnEditContainer"> <!-- Populated by loadLearnEditFieldsForProject --> </div>
                  <button type="button" class="add-item-btn" onclick="addLearnEditField()">+ Add Learning Item</button>
            </section>

            <section id="videoEdit" class="edit-section" style="display:none;">
                 <h4>Video Lesson Content</h4>
                 <label for="editProject_VideoIntroText">Introduction Text (Above Video):</label>
                 <input type="text" id="editProject_VideoIntroText" placeholder="e.g., Watch this video to see how it's done...">
                 <label for="editProject_VideoTitle">Video Section Title (Above Video):</label>
                 <input type="text" id="editProject_VideoTitle" placeholder="e.g., Programming the Animation">
                 <label for="editProject_VideoUrl">Video Embed URL:</label>
                 <input type="url" id="editProject_VideoUrl" placeholder="e.g., https://www.youtube.com/embed/VIDEO_ID">
                 <label for="editProject_VideoKeyPoints">Key Points (one per line, below video):</label>
                 <textarea id="editProject_VideoKeyPoints" rows="5" placeholder="Point 1&#10;Point 2&#10;Point 3..."></textarea>
            </section>

            <section id="slidesEdit" class="edit-section" style="display:none;">
                <h4>Step-by-Step Slides</h4>
                <div id="slidesEditContainer"> <!-- Populated by loadSlidesEditFieldsForProject --> </div>
                <button type="button" class="add-item-btn" onclick="addSlideEditField()">+ Add Slide</button>
            </section>

            <section id="challengesEdit" class="edit-section" style="display:none;">
                <h4>Project Challenges</h4>
                <div id="challengesEditContainer"> <!-- Populated by loadChallengesEditFieldsForProject --> </div>
                <button type="button" class="add-item-btn" onclick="addChallengeEditField()">+ Add Challenge</button>
            </section>

            <section id="quizEdit" class="edit-section" style="display:none;">
                <h4>Quiz Questions</h4>
                 <div id="quizEditContainer"> <!-- Populated by loadQuizEditFieldsForProject --> </div>
                 <button type="button" class="add-item-btn" onclick="addQuizEditField()">+ Add Question</button>
            </section>

            <section id="projStyleEdit" class="edit-section" style="display:none;">
                 <h4>Project Specific Styles</h4>
                 <p class="form-hint">Optionally override the global course styles just for this project.</p>

                 <h5>Color Overrides</h5>
                 <p class="form-hint" style="margin-bottom: 10px;">Select colors below to override the main course theme for this project only. The color picker will show a dashed border if inheriting the course color.</p>
                  <button type="button" onclick="clearProjectColorOverrides()" style="font-size: 0.85rem; padding: 5px 10px; margin-bottom: 20px; background-color: #adb5bd; color: var(--white); font-weight: normal; box-shadow: none;">Use Course Default Colors</button>

                 <label>Project Primary Color Override:</label>
                 <div class="color-picker" id="projectPrimaryColorPickerContainer">
                    <div class="color-option" style="background-color: #4A90E2;" onclick="selectProjectColor('primary', '#4A90E2')" title="Blue"></div>
                     <div class="color-option" style="background-color: #F5A623;" onclick="selectProjectColor('primary', '#F5A623')" title="Orange"></div>
                     <div class="color-option" style="background-color: #7ED321;" onclick="selectProjectColor('primary', '#7ED321')" title="Green"></div>
                     <div class="color-option" style="background-color: #BD10E0;" onclick="selectProjectColor('primary', '#BD10E0')" title="Purple"></div>
                     <div class="color-option" style="background-color: #4A4A4A;" onclick="selectProjectColor('primary', '#4A4A4A')" title="Dark Grey"></div>
                     <input type="color" id="projectPrimaryColorPicker" oninput="customProjectColorSelected('primary', this.value)" aria-label="Custom Project Primary Color">
                 </div>
                 <label>Project Secondary Color Override:</label>
                 <div class="color-picker" id="projectSecondaryColorPickerContainer">
                     <div class="color-option" style="background-color: #F5A623;" onclick="selectProjectColor('secondary', '#F5A623')" title="Orange"></div>
                     <div class="color-option" style="background-color: #4A90E2;" onclick="selectProjectColor('secondary', '#4A90E2')" title="Blue"></div>
                     <div class="color-option" style="background-color: #7ED321;" onclick="selectProjectColor('secondary', '#7ED321')" title="Green"></div>
                     <div class="color-option" style="background-color: #BD10E0;" onclick="selectProjectColor('secondary', '#BD10E0')" title="Purple"></div>
                     <div class="color-option" style="background-color: #D0021B;" onclick="selectProjectColor('secondary', '#D0021B')" title="Red"></div>
                     <input type="color" id="projectSecondaryColorPicker" oninput="customProjectColorSelected('secondary', this.value)" aria-label="Custom Project Secondary Color">
                 </div>
                 <label>Project Accent Color Override:</label>
                 <div class="color-picker" id="projectAccentColorPickerContainer">
                     <div class="color-option" style="background-color: #7ED321;" onclick="selectProjectColor('accent', '#7ED321')" title="Green"></div>
                     <div class="color-option" style="background-color: #F5A623;" onclick="selectProjectColor('accent', '#F5A623')" title="Orange"></div>
                      <div class="color-option" style="background-color: #4A90E2;" onclick="selectProjectColor('accent', '#4A90E2')" title="Blue"></div>
                     <div class="color-option" style="background-color: #BD10E0;" onclick="selectProjectColor('accent', '#BD10E0')" title="Purple"></div>
                     <div class="color-option" style="background-color: #D0021B;" onclick="selectProjectColor('accent', '#D0021B')" title="Red"></div>
                     <input type="color" id="projectAccentColorPicker" oninput="customProjectColorSelected('accent', this.value)" aria-label="Custom Project Accent Color">
                 </div>

                 <h5 style="margin-top: 30px;">Font & Size Override</h5>
                 <label>Font Family Override:</label>
                 <div class="font-selector" id="projectFontSelector">
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', null)" >Use Course Default</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Inter', sans-serif`)" style="font-family: 'Inter', sans-serif;">Inter</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Roboto', sans-serif`)" style="font-family: 'Roboto', sans-serif;">Roboto</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Lato', sans-serif`)" style="font-family: 'Lato', sans-serif;">Lato</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Georgia', serif`)" style="font-family: Georgia, serif;">Georgia</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Courier New', monospace`)" style="font-family: 'Courier New', monospace;">Courier New</div>
                 </div>

                 <label>Base Text Size Override:</label>
                 <div class="size-selector" id="projectSizeSelector">
                      <div class="size-option" onclick="selectProjectStyle('baseSize', null)">Use Course Default</div>
                     <div class="size-option" onclick="selectProjectStyle('baseSize', 'small')">Small (14px)</div>
                     <div class="size-option" onclick="selectProjectStyle('baseSize', 'medium')">Medium (16px)</div>
                     <div class="size-option" onclick="selectProjectStyle('baseSize', 'large')">Large (18px)</div>
                 </div>
            </section>

            <div class="modal-actions">
                <button type="button" onclick="closeModal('projectEditModal')">Cancel</button>
                <button type="submit">Save Project</button>
            </div>
        </form>
    </div>
</div>


<script>
    // --- Global Data Storage (Use the SAME courseData object from original) ---
    let courseData = {
        title: "Micro:bit Adventures",
        description: "Explore the exciting world of physical computing with the BBC micro:bit! This course contains several projects designed to introduce you to coding concepts and hardware interaction in a fun, hands-on way. This new design integrates the description better and uses a sidebar for project navigation.",
        imageUrl: "https://images.unsplash.com/photo-1619410283995-43d9134e7656?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NXx8cHJvZ3JhbW1pbmd8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60",
        // Course-level theme colors (match new CSS defaults or customize)
        style: {
            primaryColor: '#4A90E2',   // Softer Blue
            secondaryColor: '#F5A623', // Orange
            accentColor: '#7ED321',    // Lime Green
        },
        projects: [
            // Project 1: Beating Heart (Data merged from project page)
            {
                id: 'proj_heart',
                tabName: "Beating Heart", // Used for Sidebar Link & Card Title
                tabImage: "https://makecode.microbit.org/v0/beta-sim.html?nohw=1#pub:_7cvWKT73g7Pv", // Used for Course Card Image
                projectTitle: "Beating Heart Animation", // Used for Project Header
                projectSubtitle: "Make your Micro:bit display a classic beating heart!", // Used for Project Header
                projectHeaderImage: "https://makecode.microbit.org/v0/beta-sim.html?nohw=1#pub:_7cvWKT73g7Pv", // Used for Project Header Image
                overviewText: "Welcome to your first Micro:bit project! You'll learn the basics of block coding by creating a simple but effective animation on the Micro:bit's LED display – a beating heart. This is a fantastic way to understand loops and timing in programming.",
                videoIntroText: "Watch this short video guide to see exactly how to build the code blocks for the beating heart animation in the MakeCode editor:",
                videoTitle: "Coding the Beating Heart",
                videoUrl: "https://www.youtube.com/embed/2yzT7_QGLLc", // Example Video
                videoKeyPoints: [ "The LED matrix is a 5x5 grid.", "'forever' block repeats continuously.", "'show leds' draws patterns.", "'show icon' uses pre-made images.", "'pause (ms)' creates delays (ms = milliseconds)." ],
                learnData: [ { title: "Micro:bit LEDs", description: "Understand the 5x5 LED grid.", mediaType: 'image', mediaUrl: 'https://os.mbed.com/docs/mbed-os/v6.16/apis/assets/images/Glossary_MB_LEDMatrix.png' }, { title: "'Forever' Loop", description: "Learn how the 'forever' block runs code repeatedly.", mediaType: 'none', mediaUrl: '' }, { title: "Displaying Images", description: "Explore 'show leds' and 'show icon'.", mediaType: 'image', mediaUrl: 'https://microbit.org/images/lessons/flashing-heart/animated-step-3.gif' }, { title: "Timing with 'Pause'", description: "Control animation speed with delays.", mediaType: 'none', mediaUrl: '' } ],
                slidesData: [ { url: "https://makecode.microbit.org/v0/beta-sim.html?nohw=1#pub:_7cvWKT73g7Pv", description: "1. Final Code", type: "iframe" }, { url: "https://microbit.org/images/lessons/flashing-heart/animated-step-2.gif", description: "2. Drag 'show leds'", type: "image" }, { url: "https://microbit.org/images/lessons/flashing-heart/animated-step-3.gif", description: "3. Draw large heart", type: "image" }, { url: "https://microbit.org/images/lessons/flashing-heart/animated-step-4.gif", description: "4. Add 'pause (500ms)'", type: "image" }, { url: "https://microbit.org/images/lessons/flashing-heart/animated-step-5.gif", description: "5. Add second 'show leds' (small heart)", type: "image" }, { url: "https://microbit.org/images/lessons/flashing-heart/animated-step-6.gif", description: "6. Add final 'pause (500ms)'", type: "image" } ],
                challengesData: [ { title: "Speed Control", description: "Change 'pause (ms)' values (e.g., 1000, 100).", mediaType: 'none', mediaUrl: '' }, { title: "Different Icon", description: "Use 'show icon' instead of 'show leds'.", mediaType: 'none', mediaUrl: '' }, { title: "Your Animation", description: "Create your own two-frame animation.", mediaType: 'image', mediaUrl: 'https://lancaster-university.github.io/microbit-docs/assets/images/microbit-smiley.png' } ],
                quizData: [ { questionText: "Which block makes code run over and over?", correctAnswer: "'forever'", incorrectAnswers: ["'on start'", "'pause (ms)'", "'show icon'"] }, { questionText: "How many LEDs are in the display grid?", correctAnswer: "25 (5x5)", incorrectAnswers: ["10", "5", "50"] }, { questionText: "What unit does 'pause (ms)' use?", correctAnswer: "Milliseconds", incorrectAnswers: ["Seconds", "Minutes", "Microseconds"] }, { questionText: "To animate, show image, then ______, then show another image.", correctAnswer: "Pause", incorrectAnswers: ["Stop", "Repeat", "Shake"] } ],
                 // Project specific style overrides (null = inherit from course)
                style: {
                    fontFamily: null, // Inherit Font
                    baseSize: null, // Inherit size
                    // Example override for this project:
                    primaryColor: '#E63946', // Red Primary for this project only
                    secondaryColor: '#F1FAEE', // Off-white Secondary
                    accentColor: '#A8DADC', // Light Blue Accent
                 },
                 isCompleted: false // Completion flag
            },
            // Project 2: Smiley Buttons (Basic data for structure)
            {
                 id: 'proj_smiley',
                 tabName: "Smiley Buttons",
                 tabImage: "https://makecode.microbit.org/v0/beta-sim.html?nohw=1#pub:_LL1gP83dhL7K",
                 projectTitle: "Smiley Buttons Interaction",
                 projectSubtitle: "Show different faces when buttons A and B are pressed.",
                 projectHeaderImage: "https://makecode.microbit.org/v0/beta-sim.html?nohw=1#pub:_LL1gP83dhL7K",
                 overviewText: "Learn how to make your Micro:bit react to input! In this project, pressing button A will show a happy face, and pressing button B will show a sad face. This introduces event handling and basic input.",
                 videoIntroText: "This video demonstrates how to use the 'on button pressed' blocks:",
                 videoTitle: "Handling Button Inputs",
                 videoUrl: "https://www.youtube.com/embed/Gk_Q8Rv9AlU", // Example Video
                 videoKeyPoints: ["Use 'on button A pressed'.", "Use 'on button B pressed'.", "Code inside only runs when button pressed.", "'show icon' is useful."],
                 learnData: [ {title:"Input Events", description:"Understand 'on button pressed' triggers.", mediaType:'none', mediaUrl:''}, {title:"Event Handlers", description:"Learn these blocks handle specific events.", mediaType:'none', mediaUrl:''}, {title:"Button ID", description:"Distinguish button A and B.", mediaType:'image', mediaUrl:'https://teach.microbit.org/images/buttons.png'} ],
                 slidesData: [ { url: "https://makecode.microbit.org/v0/beta-sim.html?nohw=1#pub:_LL1gP83dhL7K", description: "1. Final Code", type: "iframe" }, { url: "https://microbit.org/images/lessons/smiley-buttons/animated-step-2.gif", description: "2. Drag 'on button A pressed'", type: "image" }, { url: "https://microbit.org/images/lessons/smiley-buttons/animated-step-3.gif", description: "3. Place 'show icon' (Happy)", type: "image" }, { url: "https://microbit.org/images/lessons/smiley-buttons/animated-step-4.gif", description: "4. Drag another 'on button pressed' -> B", type: "image" }, { url: "https://microbit.org/images/lessons/smiley-buttons/animated-step-5.gif", description: "5. Place 'show icon' (Sad)", type: "image" } ],
                 challengesData: [ {title: "Surprise Face!", description: "Add 'on button A+B pressed' for 'Surprised' face?", mediaType:'none', mediaUrl:''}, {title: "Clear Screen", description: "Add 'clear screen' before 'show icon'. Effect?", mediaType:'none', mediaUrl:''}, {title: "Different Icons", description: "Choose different icons for A and B.", mediaType:'none', mediaUrl:''} ],
                 quizData: [ {questionText: "Which block runs code ONLY when Button A is clicked?", correctAnswer:"'on button A pressed'", incorrectAnswers:["'forever'", "'on start'", "'show leds'"]}, {questionText: "What is an external trigger like a button press called?", correctAnswer:"Event", incorrectAnswers:["Loop", "Variable", "Sequence"]}, {questionText: "Easiest block for pre-drawn images?", correctAnswer:"'show icon'", incorrectAnswers:["'show leds'", "'pause (ms)'", "'clear screen'"]} ],
                 style: { fontFamily: null, baseSize: null, primaryColor: null, secondaryColor: null, accentColor: null }, // Inherits course style
                 isCompleted: false
             }
        ]
    };

    // --- State variables ---
    let currentProjectId = null;
    let currentProjectDataCache = null;
    let currentSlideIndex = 0;

    // --- Constants for limits ---
    const MAX_PROJECTS = 24;
    const MAX_SLIDES = 10;
    const MAX_CHALLENGES = 10;
    const MAX_LEARN_ITEMS = 8;
    const MAX_QUIZ_QUESTIONS = 10;
    const MAX_INCORRECT_ANSWERS = 3;

    // --- THEME APPLICATION (Modified slightly) ---
    function hexToRgb(hex) { /* ... (keep original function) ... */
      let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
    }

    function applyThemeColors(primary, secondary, accent) {
        const root = document.documentElement;
        // Use new CSS var defaults if values are missing
        root.style.setProperty('--primary', primary || '#4A90E2');
        root.style.setProperty('--secondary', secondary || '#F5A623');
        root.style.setProperty('--accent', accent || '#7ED321');

        const primaryRgb = hexToRgb(primary || '#4A90E2');
        if (primaryRgb) root.style.setProperty('--primary-rgb', `${primaryRgb.r}, ${primaryRgb.g}, ${primaryRgb.b}`);
        // Add RGB for secondary if needed
        // const secondaryRgb = hexToRgb(secondary || '#F5A623');
        // if (secondaryRgb) root.style.setProperty('--secondary-rgb', `${secondaryRgb.r}, ${secondaryRgb.g}, ${secondaryRgb.b}`);
    }

    function applyCourseTheme() {
        console.log("Applying COURSE theme");
        const courseStyle = courseData.style || {};
        applyThemeColors(courseStyle.primaryColor, courseStyle.secondaryColor, courseStyle.accentColor);

        const root = document.documentElement;
        // Set course defaults using CSS variables defined in :root
        root.style.setProperty('--base-font-family', 'var(--base-font-family)'); // Use the value from :root
        root.style.setProperty('--base-font-size', 'var(--base-font-size)');   // Use the value from :root

        // Clear project-specific styles when returning to course
        const projectViewEl = document.getElementById('project-view');
        const projectMainContent = document.getElementById('project-main-content'); // Target content area for font styles
         if (projectViewEl && projectMainContent) {
             projectMainContent.style.fontFamily = '';
             projectMainContent.style.fontSize = '';
             // Reset body styles which might be affected by project overrides if not handled carefully
             document.body.style.fontFamily = '';
             document.body.style.fontSize = '';
         }
    }

    function applyProjectSpecificStyles(project) {
        if (!project) return;
        console.log("Applying PROJECT specific styles for:", project.id);
        const projectStyle = project.style || {};
        const courseStyle = courseData.style || {};

        applyThemeColors(
            projectStyle.primaryColor || courseStyle.primaryColor,
            projectStyle.secondaryColor || courseStyle.secondaryColor,
            projectStyle.accentColor || courseStyle.accentColor
        );

        // Apply Font/Size Overrides to the project's main content area OR body
        // Applying to body might be simpler if the specificity works out
        const projectMainContent = document.getElementById('project-main-content'); // Or document.body;
        if (projectMainContent) {
            const projectFont = projectStyle.fontFamily;
            projectMainContent.style.fontFamily = projectFont || 'var(--base-font-family)'; // Fallback to CSS var

            const projectSize = projectStyle.baseSize;
            let effectiveFontSize = 'var(--base-font-size)'; // Default to CSS var
            if (projectSize === 'small') effectiveFontSize = '14px';
            else if (projectSize === 'large') effectiveFontSize = '18px';
            else if (projectSize === 'medium') effectiveFontSize = '16px';
            projectMainContent.style.fontSize = effectiveFontSize;
        }
    }

    // --- VIEW NAVIGATION (Mostly Unchanged Logic) ---
    function showCourseView() {
        document.getElementById('course-view').style.display = 'block';
        document.getElementById('project-view').style.display = 'none'; // Should be flex, but none works
        currentProjectId = null;
        currentProjectDataCache = null;
        document.title = courseData.title || "Course Platform";
        applyCourseTheme(); // Reset theme
        renderCoursePage();
        window.scrollTo(0, 0);
    }

    function showProjectView(projectId) {
        const project = courseData.projects.find(p => p.id === projectId);
        if (!project) { console.error(`Project ID ${projectId} not found!`); showCourseView(); return; }

        currentProjectId = projectId;
        renderProjectPage(project); // Populate project view

        document.getElementById('course-view').style.display = 'none';
        document.getElementById('project-view').style.display = 'flex'; // Use flex for sidebar layout
        document.title = project.projectTitle || "Project";

        applyCourseTheme(); // Base theme
        applyProjectSpecificStyles(project); // Overrides

        window.scrollTo(0, 0);
        try { history.pushState({ projectId: projectId }, project.projectTitle || '', `#project-${projectId}`); } catch (e) { /* handle error */ }
    }
    window.onpopstate = function(event) { /* ... (keep original function) ... */
         if (event.state && event.state.projectId) {
             showProjectView(event.state.projectId);
         } else {
             showCourseView();
         }
     };

    // --- COURSE PAGE RENDERING (Update for new card class) ---
    function renderCoursePage() {
        console.log("Rendering Course Page");
        const course = courseData;
        document.getElementById('courseTitle').textContent = course.title;
        const courseImg = document.getElementById('courseImage');
        if(courseImg) { courseImg.src = course.imageUrl || ''; courseImg.alt = course.title + " Image"; }
        document.getElementById('courseDescription').textContent = course.description;

        const grid = document.getElementById('projectGrid');
        grid.innerHTML = '';

        if (!course.projects || course.projects.length === 0) {
            grid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-light);">No projects have been added yet.</p>'; // Span full grid width
            return;
        }

        course.projects.forEach(project => {
            if (!project || !project.id) return;
            const card = document.createElement('a'); // Use <a> tag for semantics
            card.className = 'project-card'; // Use new class name
            card.href = `#project-${project.id}`;
            card.onclick = (event) => { event.preventDefault(); showProjectView(project.id); };

            const img = document.createElement('img');
            img.src = project.tabImage || 'https://via.placeholder.com/300x180/eee/999?text=Project'; // Adjust placeholder size
            img.alt = project.tabName || 'Project Card';
            img.loading = 'lazy';

            const infoDiv = document.createElement('div');
            infoDiv.className = 'project-card-info'; // Use new class name
            const nameSpan = document.createElement('span');
            nameSpan.textContent = project.tabName || 'Unnamed Project';
            infoDiv.appendChild(nameSpan);

            card.appendChild(img);
            card.appendChild(infoDiv);

            if (project.isCompleted) {
                const tick = document.createElement('span');
                tick.className = 'completion-tick';
                tick.innerHTML = '&#10004;';
                tick.setAttribute('aria-label', 'Project Completed');
                tick.title = 'Project Completed';
                card.appendChild(tick);
            }
            grid.appendChild(card);
        });
    }


    // --- PROJECT PAGE RENDERING (Update for new structure) ---
    function renderProjectPage(project) {
        console.log("Rendering Project:", project?.projectTitle);
        if (!project) return;

        const projectView = document.getElementById('project-view');
        if (!projectView) return;

        // Populate Project Header (within #project-main-content)
        const projectHeader = projectView.querySelector('#project-header');
        if (projectHeader) {
            projectHeader.querySelector('#projectImage').src = project.projectHeaderImage || project.tabImage || 'https://via.placeholder.com/90x90/eee/999?text=P';
            projectHeader.querySelector('#projectImage').alt = project.projectTitle + " Header Image";
            projectHeader.querySelector('#projectTitle').textContent = project.projectTitle || 'Project Title';
            projectHeader.querySelector('#projectSubtitle').textContent = project.projectSubtitle || '';
        }

        // Populate Sidebar Navigation Links
        const navContainer = projectView.querySelector('#project-nav');
        if (navContainer) {
             navContainer.innerHTML = ''; // Clear old links
             // Define the order and names of tabs (match HTML structure)
             const tabs = [
                 { id: 'overview', name: 'Overview' },
                 { id: 'video', name: 'Video Lesson' },
                 { id: 'slides', name: 'Step-by-Step' },
                 { id: 'challenges', name: 'Challenges' },
                 { id: 'quiz', name: 'Quiz' }
             ];
             tabs.forEach(tabInfo => {
                  // Optionally hide tabs if their content is empty (can add checks here)
                  // e.g., if (tabInfo.id === 'video' && !project.videoUrl) return;

                  const link = document.createElement('a');
                  link.className = 'nav-link';
                  link.textContent = tabInfo.name;
                  link.onclick = () => openProjectTab(tabInfo.id, link);
                  navContainer.appendChild(link);
             });
        }

        // Populate Project Content Sections (within #project-main-content)
        const contentContainer = projectView.querySelector('#projectTabContentContainer');
        if (!contentContainer) return;

        // Overview Tab
        const overviewContent = contentContainer.querySelector('#overview');
        if (overviewContent) {
            overviewContent.querySelector('#overviewText').textContent = project.overviewText || 'No overview provided.';
            renderLearnItemsForProject(project.learnData || [], overviewContent.querySelector('#learnContainer'));
        }

        // Video Tab
        const videoContent = contentContainer.querySelector('#video');
        if (videoContent) {
            const videoIframe = videoContent.querySelector('#mainVideo');
            const keyPointsUL = videoContent.querySelector('#videoKeyPoints');
            videoContent.querySelector('#videoIntroText').textContent = project.videoIntroText || '';
            videoContent.querySelector('#videoTitle').textContent = project.videoTitle || '';
            if(videoIframe) videoIframe.src = project.videoUrl || '';
            if(keyPointsUL) {
                keyPointsUL.innerHTML = '';
                (project.videoKeyPoints || []).forEach(p => { if (p && p.trim()) { const li = document.createElement('li'); li.textContent = p; keyPointsUL.appendChild(li); } });
                if (keyPointsUL.innerHTML === '') keyPointsUL.innerHTML = '<li style="color: var(--text-light); font-style: italic;">No key points provided.</li>';
             }
        }

        // Slides Tab
        const slidesContent = contentContainer.querySelector('#slides');
        if (slidesContent) {
            renderSlideshowForProject(project.slidesData || [], slidesContent.querySelector('#slideshowContainer'));
        }

        // Challenges Tab
        const challengesContent = contentContainer.querySelector('#challenges');
        if (challengesContent) {
            renderChallengesForProject(project.challengesData || [], challengesContent.querySelector('#challengesContainer'));
        }

        // Quiz Tab
        const quizContent = contentContainer.querySelector('#quiz');
        if (quizContent) {
             renderQuizForProject(project.quizData || [], quizContent.querySelector('#quizContainer'), quizContent.querySelector('#submitQuizBtn'));
        }

        // Activate the first project tab ('Overview') and update progress
        const firstNavLink = navContainer?.querySelector('.nav-link');
        if (firstNavLink) {
            // Find the tabName from the first button's onclick
             const clickAttr = firstNavLink.getAttribute('onclick') || '';
             const match = clickAttr.match(/openProjectTab\('([^']+)'/);
             const firstTabName = match ? match[1] : 'overview';
             openProjectTab(firstTabName, firstNavLink); // Activate first tab
        } else {
            updateProjectProgressBar(''); // Reset progress if no tabs
        }
    }


    // --- Project Specific Content Rendering Helpers (Unchanged Logic) ---
    function renderLearnItemsForProject(learnItemsData, container) { /* ... (keep original function) ... */
        if (!container) return; container.innerHTML = '';
         const validItems = (learnItemsData || []).filter(item => item.title && item.title.trim());
         if (validItems.length === 0) { container.innerHTML = '<p style="color: var(--text-light); font-style: italic;">No learning objectives specified.</p>'; return; }
         validItems.forEach((item, index) => {
             const el = document.createElement('div'); el.className = 'step'; // Use step styling
             el.innerHTML = `<div class="step-number">${index + 1}</div>
                             <div class="step-content">
                                 <strong></strong>
                                 ${ item.description ? '<p class="description"></p>' : '' }
                                 <div class="step-media" style="display: none;"></div>
                             </div>`;
             el.querySelector('strong').textContent = item.title;
             if(item.description) el.querySelector('p.description').textContent = item.description;

             const mediaDiv = el.querySelector('.step-media');
             if (item.mediaType && item.mediaType !== 'none' && item.mediaUrl && item.mediaUrl.trim()) {
                 const url = item.mediaUrl.trim();
                 if (url) {
                    mediaDiv.style.display = 'block';
                    const title = item.title || 'Media';
                    if (item.mediaType === 'image') mediaDiv.innerHTML = `<img src="${url}" loading="lazy" alt="${title}">`;
                    else if (item.mediaType === 'video') mediaDiv.innerHTML = `<iframe src="${url}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="${title}"></iframe>`;
                 }
             }
             container.appendChild(el);
         });
    }
    function renderChallengesForProject(challengesItemsData, container) { /* ... (keep original function) ... */
        if (!container) return; container.innerHTML = '';
         const validItems = (challengesItemsData || []).filter(item => item.title && item.title.trim());
         if (validItems.length === 0) { container.innerHTML = '<p style="color: var(--text-light); font-style: italic;">No challenges specified.</p>'; return; }
         validItems.forEach((item) => {
             const el = document.createElement('div'); el.className = 'step'; // Reuse step styling
             el.innerHTML = `<div class="step-number" style="background-color: var(--accent); color: var(--dark);">★</div>
                              <div class="step-content">
                                 <strong></strong>
                                 ${ item.description ? '<p class="description"></p>' : '' }
                                 <div class="step-media" style="display: none;"></div>
                             </div>`;
             el.querySelector('strong').textContent = item.title;
            if(item.description) el.querySelector('p.description').textContent = item.description;

             const mediaDiv = el.querySelector('.step-media');
             if (item.mediaType && item.mediaType !== 'none' && item.mediaUrl && item.mediaUrl.trim()) {
                 const url = item.mediaUrl.trim();
                  if (url) {
                     mediaDiv.style.display = 'block';
                     const title = item.title || 'Media';
                     if (item.mediaType === 'image') mediaDiv.innerHTML = `<img src="${url}" loading="lazy" alt="${title}">`;
                     else if (item.mediaType === 'video') mediaDiv.innerHTML = `<iframe src="${url}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="${title}"></iframe>`;
                  }
             }
             container.appendChild(el);
         });
    }
    function renderSlideshowForProject(slidesItemsData, container) { /* ... (keep original function) ... */
         const slidesView = container?.closest('.content-section#slides'); // Get parent content section
         const nav = slidesView?.querySelector('.slide-nav');
         if (!container || !nav) { console.error("Slideshow container or nav not found"); return; }
         container.innerHTML = '';
         const validSlides = (slidesItemsData || []).filter(slide => slide.url && slide.url.trim());

         if (validSlides.length === 0) {
             container.innerHTML = '<p style="color: var(--text-light); font-style: italic;">No slides available.</p>';
             nav.style.display = 'none'; return;
         }

         nav.style.display = 'flex';
         validSlides.forEach((slide, index) => {
             const slideDiv = document.createElement('div'); slideDiv.className = 'slide';
             const contentType = slide.type === 'image' ? 'image' : 'iframe';
             const url = slide.url.trim();
             const title = slide.description || `Slide ${index + 1}`;

             slideDiv.innerHTML = `<div class="slide-content-wrapper"></div>${slide.description ? '<p></p>' : ''}`;
             const wrapper = slideDiv.querySelector('.slide-content-wrapper');
             if (contentType === 'iframe') {
                 wrapper.innerHTML = `<iframe src="${url}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="${title}"></iframe>`;
             } else if (contentType === 'image') {
                 wrapper.innerHTML = `<img src="${url}" loading="lazy" alt="${title}">`;
             }
             if (slide.description) slideDiv.querySelector('p').textContent = slide.description;
             container.appendChild(slideDiv);
         });
         currentSlideIndex = 0; showSlide(0);
    }
    function renderQuizForProject(quizItemsData, container, submitBtn) { /* ... (keep original function) ... */
        if (!container || !submitBtn) { console.error("Quiz container or submit btn not found"); return; }
          container.innerHTML = '';
          container.closest('.content-section#quiz')?.querySelector('.final-quiz-result')?.remove();
          submitBtn.disabled = false; submitBtn.style.display = 'none';

          const validQuestions = (quizItemsData || []).filter(q => q.questionText && q.questionText.trim() && q.correctAnswer && q.correctAnswer.trim());
          if (validQuestions.length === 0) {
              container.innerHTML = '<p style="color: var(--text-light); font-style: italic;">No quiz questions available.</p>';
              return;
          }
          submitBtn.style.display = 'block';
          validQuestions.forEach((q, index) => {
                const questionDiv = document.createElement('div'); questionDiv.className = 'quiz-question';
                questionDiv.innerHTML = `<p class="question-text"></p><div class="quiz-options"></div><div class="quiz-feedback correct" style="display:none;">Correct!</div><div class="quiz-feedback incorrect" style="display:none;"></div>`;
                questionDiv.querySelector('.question-text').textContent = `${index + 1}. ${q.questionText}`;
                const optionsDiv = questionDiv.querySelector('.quiz-options');
                let options = [q.correctAnswer.trim()];
                 (q.incorrectAnswers || []).forEach(ans => { if (ans && ans.trim()) options.push(ans.trim()); });
                shuffleArray(options);
                options.forEach((optionText) => {
                    const isCorrect = (optionText === q.correctAnswer.trim());
                    const optionEl = document.createElement('div'); optionEl.className = 'quiz-option';
                    optionEl.textContent = optionText; optionEl.setAttribute('role', 'button');
                    optionEl.setAttribute('tabindex', '0'); optionEl.onclick = () => selectQuizOption(optionEl);
                    optionEl.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectQuizOption(optionEl); }};
                    optionEl.setAttribute('data-is-correct', isCorrect.toString());
                    optionsDiv.appendChild(optionEl);
                });
               container.appendChild(questionDiv);
          });
    }

    // --- Project-Specific Tab/Progress/Slides/Quiz Interaction (Update for new nav classes) ---
    function openProjectTab(tabName, clickedLinkElement) {
        const contentContainer = document.getElementById('projectTabContentContainer');
        if (!contentContainer) return;
        // Hide all content sections
        contentContainer.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
        // Deactivate all nav links
        const navContainer = document.getElementById('project-nav');
        if (navContainer) navContainer.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        // Activate the target content and link
        const targetContent = contentContainer.querySelector('#' + tabName);
        if (targetContent) targetContent.classList.add('active');
        clickedLinkElement?.classList.add('active');
        updateProjectProgressBar(tabName); // Update progress based on the activated tab
    }

    function updateProjectProgressBar(tabName) { /* ... (keep original function) ... */
        const progressBar = document.getElementById('progressBar');
         if (!progressBar) return;
         let progress = 0;
         // Use the same defined order for progress calculation
         const tabOrder = ['overview', 'video', 'slides', 'challenges', 'quiz'];
         const tabIndex = tabOrder.indexOf(tabName);
         if (tabIndex >= 0) {
             progress = ((tabIndex + 1) / tabOrder.length) * 100;
         }
         progressBar.style.width = progress + '%';
    }

    function showSlide(n) { /* ... (keep original function) ... */
        const slides = document.querySelectorAll('#project-view #slideshowContainer .slide');
        const validSlidesCount = slides.length; if (validSlidesCount === 0) return;
        slides.forEach(slide => slide.classList.remove('active'));
        currentSlideIndex = (n % validSlidesCount + validSlidesCount) % validSlidesCount;
        if(slides[currentSlideIndex]) slides[currentSlideIndex].classList.add('active');
    }
    function nextSlide() { showSlide(currentSlideIndex + 1); }
    function prevSlide() { showSlide(currentSlideIndex - 1); }

    function selectQuizOption(optionElement) { /* ... (keep original function) ... */
         const questionDiv = optionElement.closest('.quiz-question');
        if (!questionDiv || questionDiv.classList.contains('answered')) return;
        questionDiv.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
        optionElement.classList.add('selected');
    }
    function submitQuiz() { /* ... (keep original function, ensure selectors target new structure if needed) ... */
        const questions = document.querySelectorAll('#project-view #quizContainer .quiz-question');
         let answeredCount = 0, score = 0; const totalQuestions = questions.length; if (totalQuestions === 0) return;
         let firstUnanswered = null;

         questions.forEach((qDiv) => {
              const selectedOption = qDiv.querySelector('.quiz-option.selected');
              qDiv.classList.remove('answered');
              qDiv.querySelectorAll('.quiz-feedback').forEach(fb => fb.style.display = 'none');
              qDiv.querySelectorAll('.quiz-option').forEach(opt => {
                   opt.classList.remove('correct', 'incorrect'); opt.style.opacity = '1'; opt.style.cursor = 'pointer';
                   opt.onclick = () => selectQuizOption(opt);
                   opt.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectQuizOption(opt); }};
              });
              qDiv.style.outline = '';
              if (selectedOption) { answeredCount++; } else if (!firstUnanswered) { firstUnanswered = qDiv; }
         });

         if (answeredCount < totalQuestions) {
             alert(`Please answer all ${totalQuestions} questions!`);
             if(firstUnanswered) {
                 firstUnanswered.scrollIntoView({behavior:'smooth',block:'center'});
                 firstUnanswered.style.outline='2px solid var(--danger)';
                 setTimeout(()=> { if(firstUnanswered) firstUnanswered.style.outline=''; }, 2500);
             }
             return;
         }

         questions.forEach((qDiv) => {
              const selectedOption = qDiv.querySelector('.quiz-option.selected');
              const feedbackCorrect = qDiv.querySelector('.quiz-feedback.correct');
              const feedbackIncorrect = qDiv.querySelector('.quiz-feedback.incorrect');
              const allOptions = qDiv.querySelectorAll('.quiz-option');
              qDiv.classList.add('answered');
              const isSelectedCorrect = selectedOption.getAttribute('data-is-correct') === 'true';

              allOptions.forEach(opt => {
                   const optIsCorrect = opt.getAttribute('data-is-correct') === 'true';
                   if (optIsCorrect) opt.classList.add('correct');
                   if (opt === selectedOption) { if (!isSelectedCorrect) opt.classList.add('incorrect'); }
                   else if (!optIsCorrect || opt !== qDiv.querySelector('.quiz-option.correct')) { opt.style.opacity = "0.6"; }
                   opt.style.cursor = "default"; opt.onclick = null; opt.onkeydown = null;
              });

              if (isSelectedCorrect) { score++; if(feedbackCorrect) feedbackCorrect.style.display='block'; }
              else {
                  if(feedbackIncorrect) {
                      const correctOptionElement = qDiv.querySelector('.quiz-option.correct');
                      feedbackIncorrect.textContent = `Not quite. Correct: "${correctOptionElement ? correctOptionElement.textContent : 'N/A'}".`;
                      feedbackIncorrect.style.display='block';
                  }
              }
         });

         const submitBtn = document.querySelector('#project-view #submitQuizBtn'); if(submitBtn) submitBtn.disabled = true;
         const quizTabContent = document.querySelector('#project-view #quiz'); // Target section
         let resultDiv = quizTabContent?.querySelector('.final-quiz-result');
         if (!resultDiv && quizTabContent) { resultDiv = document.createElement('div'); quizTabContent.appendChild(resultDiv); }

          if (resultDiv) {
              const scorePercent = totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0;
              const passThreshold = 70; const passed = scorePercent >= passThreshold;
              resultDiv.textContent = `Quiz Complete! Score: ${score}/${totalQuestions} (${scorePercent}%).`;
              resultDiv.className = 'final-quiz-result ' + (passed ? 'success' : 'fail');
              resultDiv.style.display = 'block'; resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
              if (passed && currentProjectId) markProjectAsCompleted(currentProjectId);
          }
    }
    function markProjectAsCompleted(projectId) { /* ... (keep original function) ... */
        const project = courseData.projects.find(p => p.id === projectId);
         if (project && !project.isCompleted) {
             console.log(`Marking project ${projectId} as completed.`);
             project.isCompleted = true;
             // Could add persistence logic here
         }
    }
    function checkProjectCompletionStatus() { /* ... (keep original function if using persistence) ... */ }

    // --- MODAL & EDITING LOGIC (Mostly Unchanged Logic, minor selector adjustments if needed) ---
    function closeModal(modalId) { /* ... (keep original function) ... */
         const modal = document.getElementById(modalId);
        if(modal) modal.style.display = 'none';
        currentProjectDataCache = null;
    }
    // Course Editor
    function openCourseEditModal() { /* ... (keep original function) ... */
        const modal = document.getElementById('courseEditModal');
         if (!modal) return;
         modal.querySelector('#editCourseTitle').value = courseData.title || '';
         modal.querySelector('#editCourseImage').value = courseData.imageUrl || '';
         modal.querySelector('#editCourseDescription').value = courseData.description || '';
         renderProjectTabsEditor();
         loadCourseColorSelections();
         modal.style.display = 'block';
    }
    function renderProjectTabsEditor() { /* ... (keep original function) ... */
        const listContainer = document.getElementById('projectTabsList');
         if (!listContainer) return;
         listContainer.innerHTML = '';
         (courseData.projects || []).forEach((project, index) => {
             if (!project || !project.id) return;
             const itemDiv = document.createElement('div');
             itemDiv.className = 'project-tab-edit-item';
             itemDiv.setAttribute('data-project-id', project.id);
             itemDiv.innerHTML = `
                 <span class="index">${index + 1}</span>
                 <div class="inputs">
                     <label for="tab-name-${project.id}">Card/Tab Name:</label> <input type="text" id="tab-name-${project.id}" class="edit-tab-name" value="${project.tabName || ''}" required>
                     <label for="tab-image-${project.id}">Card Image URL:</label> <input type="url" id="tab-image-${project.id}" class="edit-tab-image" value="${project.tabImage || ''}" placeholder="https://...">
                 </div>
                 <button type="button" class="remove-item-btn" onclick="removeProjectTab('${project.id}', this)" title="Remove project" aria-label="Remove Project">&times;</button>`;
             listContainer.appendChild(itemDiv);
         });
         if (!courseData.projects || courseData.projects.length === 0) {
              listContainer.innerHTML = '<p style="font-style: italic; color: var(--text-light); text-align: center; padding: 10px 0;">No projects added.</p>';
         }
    }
    function addProjectTabEditField() { /* ... (keep original function) ... */
        if ((courseData.projects || []).length >= MAX_PROJECTS) { alert(`Max ${MAX_PROJECTS} projects allowed.`); return; }
        const newIdx = (courseData.projects?.length || 0) + 1;
        const newId = `proj_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`;
        const newProj = { id: newId, tabName: `New Project ${newIdx}`, tabImage: "", projectTitle: `New Project ${newIdx}`, projectSubtitle: "", projectHeaderImage: "", overviewText: "", videoIntroText: "", videoTitle: "", videoUrl: "", videoKeyPoints: [], learnData: [], slidesData: [], challengesData: [], quizData: [], style: {}, isCompleted: false };
        if (!courseData.projects) courseData.projects = [];
        courseData.projects.push(newProj);
        renderProjectTabsEditor();
        const listCont = document.getElementById('projectTabsList');
        const newItem = listCont?.querySelector(`[data-project-id="${newId}"]`);
        newItem?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        newItem?.querySelector('input')?.focus();
    }
    function removeProjectTab(projectIdToRemove, buttonElement) { /* ... (keep original function) ... */
        const projIndex = courseData.projects.findIndex(p=>p.id===projectIdToRemove); if (projIndex === -1) return;
        const projName = courseData.projects[projIndex]?.tabName || projectIdToRemove;
        if (!confirm(`⚠️ Permanently REMOVE project "${projName}" and all its content?`)) return;
        courseData.projects.splice(projIndex, 1);
        renderProjectTabsEditor(); renderCoursePage();
        if (currentProjectId === projectIdToRemove) showCourseView();
    }
    // Course Color Pickers
    function selectCourseColor(type, color) { /* ... (keep original function, check IDs/classes) ... */
        if (!courseData.style) courseData.style = {};
        courseData.style[type + 'Color'] = color;
        applyCourseTheme(); // Apply live preview
        const pickerInputId = `course${type.charAt(0).toUpperCase() + type.slice(1)}ColorPicker`;
        const pickerInput = document.getElementById(pickerInputId);
         const pickerContainer = pickerInput?.closest('.color-picker');
         if (pickerInput) pickerInput.value = color;
         if (pickerContainer) {
             pickerContainer.querySelectorAll('.color-option').forEach(option => {
                 option.classList.toggle('selected', areColorsEqual(option.style.backgroundColor, color));
             });
         }
    }
    function customCourseColorSelected(type, color) { /* ... (keep original function) ... */
        selectCourseColor(type, color);
        const pickerInputId = `course${type.charAt(0).toUpperCase() + type.slice(1)}ColorPicker`;
        const pickerContainer = document.getElementById(pickerInputId)?.closest('.color-picker');
        pickerContainer?.querySelectorAll('.color-option').forEach(option => option.classList.remove('selected'));
    }
    function loadCourseColorSelections() { /* ... (keep original function, use new default values if needed) ... */
         selectCourseColor('primary', courseData.style?.primaryColor || '#4A90E2');
         selectCourseColor('secondary', courseData.style?.secondaryColor || '#F5A623');
         selectCourseColor('accent', courseData.style?.accentColor || '#7ED321');
    }
    function saveCourseChanges() { /* ... (keep original function) ... */
        courseData.title = document.getElementById('editCourseTitle')?.value.trim() || courseData.title;
        courseData.imageUrl = document.getElementById('editCourseImage')?.value.trim() || courseData.imageUrl;
        courseData.description = document.getElementById('editCourseDescription')?.value.trim() || courseData.description;
        document.querySelectorAll('#projectTabsList .project-tab-edit-item').forEach(item => {
            const projectId = item.getAttribute('data-project-id');
            const project = courseData.projects.find(p => p.id === projectId);
            if (project) {
                project.tabName = item.querySelector('.edit-tab-name')?.value.trim() || project.tabName;
                project.tabImage = item.querySelector('.edit-tab-image')?.value.trim() || project.tabImage;
            }
        });
        applyCourseTheme(); renderCoursePage(); closeModal('courseEditModal');
        alert("Course changes saved!");
    }
    // Project Editor
    function openProjectEditModal() { /* ... (keep original function) ... */
        const modal = document.getElementById('projectEditModal');
        if (!modal || !currentProjectId) { alert("Select a project first."); return; }
        const projectIndex = courseData.projects.findIndex(p => p.id === currentProjectId);
        if (projectIndex === -1) { alert("Project data not found."); return; }
        currentProjectDataCache = JSON.parse(JSON.stringify(courseData.projects[projectIndex]));
        const project = currentProjectDataCache;
        modal.querySelector('#editingProjectId').value = project.id;
        modal.querySelector('#editingProjectNameLabel').textContent = project.projectTitle || project.tabName;
        // Load simple fields
        modal.querySelector('#editProject_Title').value = project.projectTitle || '';
        modal.querySelector('#editProject_Subtitle').value = project.projectSubtitle || '';
        modal.querySelector('#editProject_HeaderImage').value = project.projectHeaderImage || '';
        modal.querySelector('#editProject_TabName').value = project.tabName || '';
        modal.querySelector('#editProject_TabImage').value = project.tabImage || '';
        modal.querySelector('#editProject_OverviewText').value = project.overviewText || '';
        modal.querySelector('#editProject_VideoIntroText').value = project.videoIntroText || '';
        modal.querySelector('#editProject_VideoTitle').value = project.videoTitle || '';
        modal.querySelector('#editProject_VideoUrl').value = project.videoUrl || '';
        modal.querySelector('#editProject_VideoKeyPoints').value = (project.videoKeyPoints || []).join('\n');
        // Load dynamic lists
        loadLearnEditFieldsForProject(project.learnData, modal.querySelector('#learnEditContainer'));
        loadSlidesEditFieldsForProject(project.slidesData, modal.querySelector('#slidesEditContainer'));
        loadChallengesEditFieldsForProject(project.challengesData, modal.querySelector('#challengesEditContainer'));
        loadQuizEditFieldsForProject(project.quizData, modal.querySelector('#quizEditContainer'));
        // Load styles
        loadProjectStyleSelections(project.style); loadProjectColorSelections(project.style);
        modal.style.display = 'block'; document.getElementById('editSectionProject').value = 'projMeta'; showProjectEditSection();
    }
    // Editor Field Loaders (Unchanged Logic)
    function createEditItemGroup(index, typePrefix, contentGenerator, removeHandler) { /* ... (keep original function) ... */
        const itemGroup = document.createElement('div'); itemGroup.className = 'edit-item-group';
        itemGroup.innerHTML = contentGenerator(index);
        const removeBtn = document.createElement('button'); removeBtn.type = 'button'; removeBtn.className = 'remove-item-btn';
        removeBtn.innerHTML = '&times;'; removeBtn.title = `Remove item`; removeBtn.setAttribute('aria-label', `Remove Item ${index + 1}`);
        removeBtn.onclick = () => removeHandler(itemGroup); itemGroup.appendChild(removeBtn);
        const mediaTypeSelect = itemGroup.querySelector('.media-type-select');
        if (mediaTypeSelect) handleMediaTypeChange(mediaTypeSelect); // Initial check
        return itemGroup;
    }
    function handleMediaTypeChange(selectElement) { /* ... (keep original function) ... */
        const urlInputContainer = selectElement.closest('.edit-item-group')?.querySelector('.media-url-input-container');
        if (urlInputContainer) urlInputContainer.style.display = (selectElement.value === 'none' || !selectElement.value) ? 'none' : 'block';
    }
    function loadLearnEditFieldsForProject(data, container) { /* ... (keep original function) ... */
        if (!container) return; container.innerHTML = ''; const items = data || [];
        items.forEach((item, index) => {
            const prefix = 'learn'; const content = (i) => `
                <label for="${prefix}-title-${i}"><b>Item ${i + 1} Title:</b></label> <input type="text" id="${prefix}-title-${i}" class="${prefix}-title" value="${item.title || ''}" required>
                <label for="${prefix}-desc-${i}">Description:</label> <textarea id="${prefix}-desc-${i}" class="${prefix}-desc" rows="2">${item.description || ''}</textarea>
                <div class="media-controls"> <label>Media:</label> <select class="media-type-select" onchange="handleMediaTypeChange(this)"> <option value="none" ${!item.mediaType || item.mediaType === 'none' ? 'selected' : ''}>None</option> <option value="image" ${item.mediaType === 'image' ? 'selected' : ''}>Image</option> <option value="video" ${item.mediaType === 'video' ? 'selected' : ''}>Video</option> </select> <div class="media-url-input-container" style="display: none;"> <input type="url" class="media-url-input" placeholder="Media URL..." value="${item.mediaUrl || ''}"> </div> </div>`;
            container.appendChild(createEditItemGroup(index, prefix, content, handleRemoveLearnItem));
        });
        if (items.length === 0) container.innerHTML = '<p style="font-style: italic; color: var(--text-light);">No items added.</p>';
    }
    function loadSlidesEditFieldsForProject(data, container) { /* ... (keep original function) ... */
        if (!container) return; container.innerHTML = ''; const items = data || [];
        items.forEach((slide, index) => {
            const prefix = 'slide'; const content = (i) => `
                <label for="${prefix}-url-${i}"><b>Slide ${i + 1} URL:</b></label> <input type="url" id="${prefix}-url-${i}" class="${prefix}-url" value="${slide.url || ''}" required>
                <label for="${prefix}-desc-${i}">Caption:</label> <input type="text" id="${prefix}-desc-${i}" class="${prefix}-desc" value="${slide.description || ''}">
                <label>Type:</label> <select class="${prefix}-type"> <option value="iframe" ${!slide.type || slide.type === 'iframe' ? 'selected' : ''}>Embed</option> <option value="image" ${slide.type === 'image' ? 'selected' : ''}>Image</option> </select>`;
            container.appendChild(createEditItemGroup(index, prefix, content, handleRemoveSlideItem));
        });
        if (items.length === 0) container.innerHTML = '<p style="font-style: italic; color: var(--text-light);">No slides added.</p>';
    }
    function loadChallengesEditFieldsForProject(data, container) { /* ... (keep original function) ... */
         if (!container) return; container.innerHTML = ''; const items = data || [];
        items.forEach((challenge, index) => {
            const prefix = 'challenge'; const content = (i) => `
                <label for="${prefix}-title-${i}"><b>Challenge ${i + 1} Title:</b></label> <input type="text" id="${prefix}-title-${i}" class="${prefix}-title" value="${challenge.title || ''}" required>
                <label for="${prefix}-desc-${i}">Description:</label> <textarea id="${prefix}-desc-${i}" class="${prefix}-desc" rows="2">${challenge.description || ''}</textarea>
                <div class="media-controls"> <label>Media:</label> <select class="media-type-select" onchange="handleMediaTypeChange(this)"> <option value="none" ${!challenge.mediaType || challenge.mediaType === 'none' ? 'selected' : ''}>None</option> <option value="image" ${challenge.mediaType === 'image' ? 'selected' : ''}>Image</option> <option value="video" ${challenge.mediaType === 'video' ? 'selected' : ''}>Video</option> </select> <div class="media-url-input-container" style="display: none;"> <input type="url" class="media-url-input" placeholder="Media URL..." value="${challenge.mediaUrl || ''}"> </div> </div>`;
            container.appendChild(createEditItemGroup(index, prefix, content, handleRemoveChallengeItem));
        });
        if (items.length === 0) container.innerHTML = '<p style="font-style: italic; color: var(--text-light);">No challenges added.</p>';
    }
    function loadQuizEditFieldsForProject(data, container) { /* ... (keep original function) ... */
        if (!container) return; container.innerHTML = ''; const items = data || [];
        items.forEach((q, index) => {
            const prefix = 'quiz'; let incorrectInputsHTML = '';
            for (let i = 0; i < MAX_INCORRECT_ANSWERS; i++) {
                const val = (q.incorrectAnswers && q.incorrectAnswers[i]) ? q.incorrectAnswers[i] : '';
                incorrectInputsHTML += `<label class="incorrect-answer-label">Incorrect ${i + 1}:</label> <input type="text" class="${prefix}-incorrect" value="${val}">`;
            }
            const content = (i) => `
                <label for="${prefix}-question-${i}"><b>Question ${i + 1}:</b></label> <textarea id="${prefix}-question-${i}" class="${prefix}-question" rows="2" required>${q.questionText || ''}</textarea>
                <label style="color: var(--success); font-weight: bold;">Correct Answer:</label> <input type="text" class="${prefix}-correct" value="${q.correctAnswer || ''}" required>
                ${incorrectInputsHTML}`;
            container.appendChild(createEditItemGroup(index, prefix, content, handleRemoveQuizItem));
        });
        if (items.length === 0) container.innerHTML = '<p style="font-style: italic; color: var(--text-light);">No quiz questions.</p>';
    }
    // Project Style & Color Pickers (Unchanged Logic)
    function loadProjectStyleSelections(projectStyleData) { /* ... keep ... */
        const modal = document.getElementById('projectEditModal'); if (!modal) return; const styleData = projectStyleData || {};
        const currentFont = styleData.fontFamily || null; const fontSelector = modal.querySelector('#projectFontSelector');
        if (fontSelector) { fontSelector.querySelectorAll('.font-option').forEach(option => { const onclickAttr = option.getAttribute('onclick'); const match = onclickAttr?.match(/selectProjectStyle\('fontFamily',\s*(null|(['"`])(.*?)\2)\)/); let optionValue = undefined; if (match) { optionValue = match[1] === 'null' ? null : match[3]; } option.classList.toggle('selected', optionValue === currentFont); }); }
        const currentSize = styleData.baseSize || null; const sizeSelector = modal.querySelector('#projectSizeSelector');
        if (sizeSelector) { sizeSelector.querySelectorAll('.size-option').forEach(option => { const onclickAttr = option.getAttribute('onclick'); const match = onclickAttr?.match(/selectProjectStyle\('baseSize',\s*(null|'small'|'medium'|'large')\)/); const optionValue = match ? (match[1] === 'null' ? null : match[1]) : undefined; option.classList.toggle('selected', optionValue === currentSize); }); }
    }
    function loadProjectColorSelections(projectStyleData) { /* ... keep ... */
        const styleData = projectStyleData || {};
        selectProjectColor('primary', styleData.primaryColor || null, false);
        selectProjectColor('secondary', styleData.secondaryColor || null, false);
        selectProjectColor('accent', styleData.accentColor || null, false);
    }
    function selectProjectStyle(styleProperty, value) { /* ... keep ... */
        if (!currentProjectDataCache) return; if (!currentProjectDataCache.style) currentProjectDataCache.style = {};
        currentProjectDataCache.style[styleProperty] = value; loadProjectStyleSelections(currentProjectDataCache.style);
        if (document.getElementById('project-view').style.display !== 'none') applyProjectSpecificStyles(currentProjectDataCache);
    }
    function selectProjectColor(type, color, applyLive = true) { /* ... keep ... */
        if (!currentProjectDataCache) return; if (!currentProjectDataCache.style) currentProjectDataCache.style = {};
        currentProjectDataCache.style[type + 'Color'] = color; // color can be null
        const pickerInputId = `project${type.charAt(0).toUpperCase() + type.slice(1)}ColorPicker`;
        const pickerInput = document.getElementById(pickerInputId); const pickerContainer = document.getElementById(`${pickerInputId}Container`);
        if (pickerInput) { const effectiveColor = color || courseData.style?.[type + 'Color'] || '#ffffff'; pickerInput.value = effectiveColor; pickerInput.classList.toggle('inherited-style', color === null); }
        if (pickerContainer) { pickerContainer.querySelectorAll('.color-option').forEach(option => { option.classList.toggle('selected', color !== null && areColorsEqual(option.style.backgroundColor, color)); }); }
        if (applyLive && document.getElementById('project-view').style.display !== 'none') applyProjectSpecificStyles(currentProjectDataCache);
    }
    function customProjectColorSelected(type, color) { /* ... keep ... */
        selectProjectColor(type, color, true);
        const pickerContainer = document.getElementById(`project${type.charAt(0).toUpperCase() + type.slice(1)}ColorPickerContainer`);
        pickerContainer?.querySelectorAll('.color-option').forEach(option => option.classList.remove('selected'));
    }
    function clearProjectColorOverrides() { /* ... keep ... */
        if (!confirm("Reset colors to course defaults?")) return;
        selectProjectColor('primary', null, false); selectProjectColor('secondary', null, false); selectProjectColor('accent', null, false);
        if (document.getElementById('project-view').style.display !== 'none') applyProjectSpecificStyles(currentProjectDataCache);
        alert("Colors reset. Save project to confirm.");
    }
    // Add/Remove Handlers (Unchanged Logic)
    function findIndexAndRemove(element, dataArrayName, reloadFunctionName) { /* ... keep ... */
        if (!currentProjectDataCache || !currentProjectDataCache[dataArrayName]) return; const container = element.parentNode;
        const items = Array.from(container.children).filter(child => child.classList.contains('edit-item-group')); const index = items.indexOf(element);
        if (index > -1) { const itemType = dataArrayName.replace('Data', ''); let confirmMsg = `Remove this ${itemType}?`; if (itemType === 'quiz' || itemType === 'slide') confirmMsg = `⚠️ Permanently remove this ${itemType}?`; if (confirm(confirmMsg)) { currentProjectDataCache[dataArrayName].splice(index, 1); window[reloadFunctionName](currentProjectDataCache[dataArrayName], container); } } else { element.remove(); }
    }
    function handleRemoveLearnItem(el) { findIndexAndRemove(el, 'learnData', 'loadLearnEditFieldsForProject'); }
    function handleRemoveSlideItem(el) { findIndexAndRemove(el, 'slidesData', 'loadSlidesEditFieldsForProject'); }
    function handleRemoveChallengeItem(el) { findIndexAndRemove(el, 'challengesData', 'loadChallengesEditFieldsForProject'); }
    function handleRemoveQuizItem(el) { findIndexAndRemove(el, 'quizData', 'loadQuizEditFieldsForProject'); }
    function addItemToProjectData(dataArrayName, maxItems, newItemObject, reloadFunctionName, containerSelector, focusSelector = null) { /* ... keep ... */
        if (!currentProjectDataCache) return; if (!currentProjectDataCache[dataArrayName]) currentProjectDataCache[dataArrayName] = [];
        if (currentProjectDataCache[dataArrayName].length >= maxItems) { alert(`Max ${maxItems} items.`); return; }
        currentProjectDataCache[dataArrayName].push(newItemObject); const container = document.querySelector(containerSelector);
        if (container && typeof window[reloadFunctionName] === 'function') { window[reloadFunctionName](currentProjectDataCache[dataArrayName], container); const lastItem = container.lastElementChild; if (lastItem?.classList.contains('edit-item-group')) { lastItem.scrollIntoView({behavior:'smooth', block:'nearest'}); if(focusSelector) lastItem.querySelector(focusSelector)?.focus(); } } else { console.error(`Reload/container fail: ${reloadFunctionName}, ${containerSelector}`); }
    }
    function addLearnEditField() { addItemToProjectData('learnData', MAX_LEARN_ITEMS, { title: "", description: "", mediaType:'none', mediaUrl:'' }, 'loadLearnEditFieldsForProject', '#projectEditModal #learnEditContainer', '.learn-title'); }
    function addSlideEditField() { addItemToProjectData('slidesData', MAX_SLIDES, { url: "", description: "", type:"iframe" }, 'loadSlidesEditFieldsForProject', '#projectEditModal #slidesEditContainer', '.slide-url'); }
    function addChallengeEditField() { addItemToProjectData('challengesData', MAX_CHALLENGES, { title: "", description: "", mediaType:'none', mediaUrl:'' }, 'loadChallengesEditFieldsForProject', '#projectEditModal #challengesEditContainer', '.challenge-title'); }
    function addQuizEditField() { addItemToProjectData('quizData', MAX_QUIZ_QUESTIONS, { questionText:"", correctAnswer:"", incorrectAnswers: Array(MAX_INCORRECT_ANSWERS).fill("") }, 'loadQuizEditFieldsForProject', '#projectEditModal #quizEditContainer', '.quiz-question'); }
    // Show Project Edit Section (Unchanged Logic)
    function showProjectEditSection() { /* ... keep ... */
        const modal = document.getElementById('projectEditModal'); const select = document.getElementById('editSectionProject'); if (!modal || !select) return;
        modal.querySelectorAll('.edit-section').forEach(section => section.style.display = 'none'); const sectionIdToShow = select.value + 'Edit';
        const targetSection = modal.querySelector('#' + sectionIdToShow); if (targetSection) targetSection.style.display = 'block';
    }
    // Save Project Changes (Unchanged Logic, but verify selectors)
    function saveProjectChanges() { /* ... keep ... */
        const projectId = document.getElementById('editingProjectId')?.value; const projectIndex = courseData.projects.findIndex(p => p.id === projectId);
        if (projectIndex === -1 || !currentProjectDataCache) { alert("Error saving: Project data mismatch."); return; }
        const modal = document.getElementById('projectEditModal'); if (!modal) { alert("Error saving: Modal not found."); return; }
        let updatedProjectData = { id: projectId, isCompleted: currentProjectDataCache.isCompleted, style: JSON.parse(JSON.stringify(currentProjectDataCache.style || {})), /* simple fields: */ projectTitle: modal.querySelector('#editProject_Title')?.value.trim() || 'Project', projectSubtitle: modal.querySelector('#editProject_Subtitle')?.value.trim() || '', projectHeaderImage: modal.querySelector('#editProject_HeaderImage')?.value.trim() || '', tabName: modal.querySelector('#editProject_TabName')?.value.trim() || 'Tab', tabImage: modal.querySelector('#editProject_TabImage')?.value.trim() || '', overviewText: modal.querySelector('#editProject_OverviewText')?.value.trim() || '', videoIntroText: modal.querySelector('#editProject_VideoIntroText')?.value.trim() || '', videoTitle: modal.querySelector('#editProject_VideoTitle')?.value.trim() || '', videoUrl: modal.querySelector('#editProject_VideoUrl')?.value.trim() || '', videoKeyPoints: modal.querySelector('#editProject_VideoKeyPoints')?.value.split('\n').map(s => s.trim()).filter(s => s), /* list fields init: */ learnData: [], slidesData: [], challengesData: [], quizData: [] };
        let isValid = true; try {
            // Learn Items
            modal.querySelectorAll('#learnEditContainer .edit-item-group').forEach(item => { const titleInput=item.querySelector('.learn-title'); const title=titleInput?.value.trim(); if(title){ const mediaTypeSelect=item.querySelector('.media-type-select'); const mediaUrlInput=item.querySelector('.media-url-input'); const mediaType=mediaTypeSelect?.value||'none'; const mediaUrl=(mediaType!=='none'&&mediaUrlInput)?mediaUrlInput.value.trim():''; if(mediaType!=='none'&&!mediaUrl){alert(`URL needed for media in Learn Item: "${title}"`);mediaUrlInput?.focus();isValid=!1;throw new Error("VFail");} updatedProjectData.learnData.push({title:title,description:item.querySelector('.learn-desc')?.value.trim()||"",mediaType:mediaType,mediaUrl:mediaUrl}); titleInput.style.borderColor='';} else if(titleInput?.required&&!title){alert("Title needed for Learn Item.");titleInput.style.borderColor='red';titleInput.focus();isValid=!1;throw new Error("VFail");} }); if(!isValid)return;
            // Slides
            modal.querySelectorAll('#slidesEditContainer .edit-item-group').forEach(item => { const urlInput=item.querySelector('.slide-url'); const url=urlInput?.value.trim(); if(url){ updatedProjectData.slidesData.push({url:url,description:item.querySelector('.slide-desc')?.value.trim()||"",type:item.querySelector('.slide-type')?.value||"iframe"}); urlInput.style.borderColor=''; } else if(urlInput?.required&&!url){alert("URL needed for Slide.");urlInput.style.borderColor='red';urlInput.focus();isValid=!1;throw new Error("VFail");} }); if(!isValid)return;
            // Challenges
            modal.querySelectorAll('#challengesEditContainer .edit-item-group').forEach(item => { const titleInput=item.querySelector('.challenge-title'); const title=titleInput?.value.trim(); if(title){ const mediaTypeSelect=item.querySelector('.media-type-select'); const mediaUrlInput=item.querySelector('.media-url-input'); const mediaType=mediaTypeSelect?.value||'none'; const mediaUrl=(mediaType!=='none'&&mediaUrlInput)?mediaUrlInput.value.trim():''; if(mediaType!=='none'&&!mediaUrl){alert(`URL needed for media in Challenge: "${title}"`);mediaUrlInput?.focus();isValid=!1;throw new Error("VFail");} updatedProjectData.challengesData.push({title:title,description:item.querySelector('.challenge-desc')?.value.trim()||"",mediaType:mediaType,mediaUrl:mediaUrl}); titleInput.style.borderColor='';} else if(titleInput?.required&&!title){alert("Title needed for Challenge.");titleInput.style.borderColor='red';titleInput.focus();isValid=!1;throw new Error("VFail");} }); if(!isValid)return;
            // Quiz Questions
            modal.querySelectorAll('#quizEditContainer .edit-item-group').forEach(item=>{ const questionInput=item.querySelector('.quiz-question'); const correctInput=item.querySelector('.quiz-correct'); const question=questionInput?.value.trim(); const correct=correctInput?.value.trim(); if(question&&correct){ let incorrect=[]; item.querySelectorAll('.quiz-incorrect').forEach(inp=>{if(inp.value.trim())incorrect.push(inp.value.trim())}); updatedProjectData.quizData.push({questionText:question,correctAnswer:correct,incorrectAnswers:incorrect}); questionInput.style.borderColor='';correctInput.style.borderColor=''; } else { if(questionInput?.required&&!question){alert("Question text needed.");questionInput.style.borderColor='red';questionInput.focus();isValid=!1;throw new Error("VFail");} if(correctInput?.required&&!correct){alert("Correct answer needed.");correctInput.style.borderColor='red';correctInput.focus();isValid=!1;throw new Error("VFail");} } }); if(!isValid)return;
            // Commit
            courseData.projects[projectIndex] = updatedProjectData;
            applyProjectSpecificStyles(updatedProjectData); renderProjectPage(updatedProjectData); renderCoursePage(); closeModal('projectEditModal');
            alert(`Project "${updatedProjectData.projectTitle || updatedProjectData.tabName}" saved!`); currentProjectDataCache = null;
        } catch (error) { if (error.message !== "VFail") { console.error("Save error:", error); alert("Error saving project."); } }
    }

    // --- Utility Functions (Unchanged) ---
    function shuffleArray(array){for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]]}}
    function areColorsEqual(color1, color2){ /* ... (keep original function) ... */
        if (!color1 || !color2) return color1 === color2; if (color1.toLowerCase() === color2.toLowerCase()) return true;
        const convertToRgba = (color) => { const ctx = document.createElement('canvas').getContext('2d'); if (!ctx) return null; ctx.fillStyle = color; const computedColor = ctx.fillStyle; if (computedColor.startsWith('rgba')) return computedColor; if (computedColor.startsWith('#')) { const rgb = hexToRgb(computedColor); return rgb ? `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 1)` : null; } if (computedColor.startsWith('rgb(')) { return computedColor.replace('rgb(', 'rgba(').replace(')', ', 1)'); } return computedColor; };
        try { const rgba1 = convertToRgba(color1); const rgba2 = convertToRgba(color2); return rgba1 && rgba2 && rgba1 === rgba2; } catch (e) { console.warn("Color compare fallback:", e); return String(color1).trim().toLowerCase() === String(color2).trim().toLowerCase(); }
    }

    // --- EXPORT COURSE (Update selectors/cleanup for new structure) ---
    function exportCourseHTML() {
        console.log("Starting COURSE export (New Design)...");
        try {
            applyCourseTheme(); // Ensure base theme active
            const exportDocElement = document.documentElement.cloneNode(true);

            // Remove editor UI
            exportDocElement.querySelector('#courseEditModal')?.remove();
            exportDocElement.querySelector('#projectEditModal')?.remove();
            exportDocElement.querySelectorAll('.edit-btn').forEach(btn => btn.remove());
            exportDocElement.querySelectorAll('.export-btn').forEach(btn => btn.remove());
            // KEEP '.back-btn' in the project header actions

            // Prepare viewer state
            exportDocElement.querySelector('#course-view').style.display = 'block';
            exportDocElement.querySelector('#project-view').style.display = 'none'; // Initial state for exported file
            // Clear any inline project styles from content area
            const exportProjectContentEl = exportDocElement.querySelector('#project-main-content');
            if(exportProjectContentEl) { exportProjectContentEl.style.fontFamily = ''; exportProjectContentEl.style.fontSize = ''; }

            // Reset quiz state visually
            exportDocElement.querySelectorAll('.quiz-question').forEach(q => { q.classList.remove('answered'); q.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected', 'correct', 'incorrect')); q.querySelectorAll('.quiz-feedback').forEach(f => f.style.display = 'none'); });
            exportDocElement.querySelector('.final-quiz-result')?.remove();
            const exportSubmitBtn = exportDocElement.querySelector('#project-view #submitQuizBtn');
            if (exportSubmitBtn) exportSubmitBtn.disabled = false;

            // Remove original scripts
            exportDocElement.querySelectorAll('script').forEach(script => script.remove());

            // Create viewer script with embedded data
            const viewerScript = document.createElement('script');
            const courseDataString = JSON.stringify(courseData).replace(/</g, '\\u003c').replace(/>/g, '\\u003e');

            // Minified Viewer Logic (Adapted for the new structure)
            // NOTE: This minified script assumes the NEW HTML structure and CSS classes.
            // It keeps the core logic but updates selectors/class names where necessary.
            viewerScript.textContent = `
// --- EXPORTED VIEWER SCRIPT (v2 - New Design) ---
const courseDataForView = ${courseDataString};
let currentSlideIndex = 0; let currentProjectIdForView = null;
function shuffleArray(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}}
function hexToRgb(h){let r=/^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(h);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null}
function areColorsEqual(c1,c2){if(!c1||!c2)return c1===c2;if(c1.toLowerCase()===c2.toLowerCase())return!0;const cvt=c=>{const x=document.createElement('canvas').getContext('2d');if(!x)return null;x.fillStyle=c;const cc=x.fillStyle;if(cc.startsWith('rgba'))return cc;if(cc.startsWith('#')){const r=hexToRgb(cc);return r?\`rgba(\${r.r}, \${r.g}, \${r.b}, 1)\`:null}if(cc.startsWith('rgb('))return cc.replace('rgb(','rgba(').replace(')',', 1)');return cc};try{const r1=cvt(c1),r2=cvt(c2);return r1&&r2&&r1===r2}catch(e){return String(c1).trim().toLowerCase()===String(c2).trim().toLowerCase()}}
function applyThemeClrs(p,s,a){const r=document.documentElement;r.style.setProperty('--primary',p||'#4A90E2');r.style.setProperty('--secondary',s||'#F5A623');r.style.setProperty('--accent',a||'#7ED321');const pr=hexToRgb(p||'#4A90E2');if(pr)r.style.setProperty('--primary-rgb',\`\${pr.r}, \${pr.g}, \${pr.b}\`)}
function applyCourseThemeForView(){const cs=courseDataForView.style||{};applyThemeClrs(cs.primaryColor,cs.secondaryColor,cs.accentColor);const r=document.documentElement;r.style.setProperty('--base-font-family','var(--base-font-family)');r.style.setProperty('--base-font-size','var(--base-font-size)');const pMc=document.getElementById('project-main-content');if(pMc){pMc.style.fontFamily='';pMc.style.fontSize=''}document.body.style.fontFamily='';document.body.style.fontSize=''}
function applyProjectStylesForView(p){if(!p)return;const ps=p.style||{};const cs=courseDataForView.style||{};applyThemeClrs(ps.primaryColor||cs.primaryColor,ps.secondaryColor||cs.secondaryColor,ps.accentColor||cs.accentColor);const pMc=document.getElementById('project-main-content');if(!pMc)return;pMc.style.fontFamily=ps.fontFamily||'var(--base-font-family)';let ef='var(--base-font-size)';if(ps.baseSize==='small')ef='14px';else if(ps.baseSize==='large')ef='18px';else if(ps.baseSize==='medium')ef='16px';pMc.style.fontSize=ef}
function showCourseView(){document.getElementById('course-view').style.display='block';document.getElementById('project-view').style.display='none';currentProjectIdForView=null;document.title=courseDataForView.title||"Course";applyCourseThemeForView();renderCoursePageForView();window.scrollTo(0,0)}
function showProjectView(pid){const p=courseDataForView.projects.find(pr=>pr.id===pid);if(!p){showCourseView();return}currentProjectIdForView=pid;renderProjectPageForView(p);document.getElementById('course-view').style.display='none';document.getElementById('project-view').style.display='flex';document.title=p.projectTitle||"Project";applyCourseThemeForView();applyProjectStylesForView(p);window.scrollTo(0,0);try{history.pushState({projectId:pid},p.projectTitle||'',\`#project-\${pid}\`)}catch(e){}}
window.onpopstate=function(e){if(e.state&&e.state.projectId)showProjectView(e.state.projectId);else showCourseView()};
function renderCoursePageForView(){const c=courseDataForView;document.getElementById('courseTitle').textContent=c.title;const i=document.getElementById('courseImage');if(i){i.src=c.imageUrl||'';i.alt=c.title+" Img"}document.getElementById('courseDescription').textContent=c.description;const g=document.getElementById('projectGrid');g.innerHTML='';if(!c.projects||c.projects.length===0){g.innerHTML='<p style="grid-column:1/-1;text-align:center;color:var(--text-light);">No projects.</p>';return}c.projects.forEach(p=>{if(!p||!p.id)return;const cd=document.createElement('a');cd.className='project-card';cd.href=\`#project-\${p.id}\`;cd.onclick=e=>{e.preventDefault();showProjectView(p.id)};cd.innerHTML=\`<img src="\${p.tabImage||'https://via.placeholder.com/300x180/eee/999?text=Prj'}" alt="\${p.tabName||'Card'}" loading="lazy"><div class="project-card-info"><span>\${p.tabName||'Project'}</span></div>\`;if(p.isCompleted){const k=document.createElement('span');k.className='completion-tick';k.innerHTML='&#10004;';k.title='Completed';cd.appendChild(k)}g.appendChild(cd)})}
function renderProjectPageForView(p){if(!p)return;const pv=document.getElementById('project-view');if(!pv)return;const h=pv.querySelector('#project-header');if(h){h.querySelector('#projectImage').src=p.projectHeaderImage||p.tabImage||'';h.querySelector('#projectImage').alt=p.projectTitle+" Hdr";h.querySelector('#projectTitle').textContent=p.projectTitle;h.querySelector('#projectSubtitle').textContent=p.projectSubtitle}const nc=pv.querySelector('#project-nav');if(nc){nc.innerHTML='';const ts=[{id:'overview',name:'Overview'},{id:'video',name:'Video Lesson'},{id:'slides',name:'Step-by-Step'},{id:'challenges',name:'Challenges'},{id:'quiz',name:'Quiz'}];ts.forEach(ti=>{const l=document.createElement('a');l.className='nav-link';l.textContent=ti.name;l.onclick=()=>openProjectTab(ti.id,l);nc.appendChild(l)})}const cc=pv.querySelector('#projectTabContentContainer');if(!cc)return;const ov=cc.querySelector('#overview');if(ov){ov.querySelector('#overviewText').textContent=p.overviewText||'';renderLearnItemsForProjectView(p.learnData||[],ov.querySelector('#learnContainer'))}const vd=cc.querySelector('#video');if(vd){vd.querySelector('#videoIntroText').textContent=p.videoIntroText||'';vd.querySelector('#videoTitle').textContent=p.videoTitle||'';vd.querySelector('#mainVideo').src=p.videoUrl||'';const ul=vd.querySelector('#videoKeyPoints');ul.innerHTML='';(p.videoKeyPoints||[]).forEach(pt=>{if(pt&&pt.trim())ul.innerHTML+=\`<li>\${pt}</li>\`});if(!ul.innerHTML)ul.innerHTML='<li style="color:var(--text-light);font-style:italic;">No points.</li>'}const sl=cc.querySelector('#slides');if(sl)renderSlideshowForProjectView(p.slidesData||[],sl.querySelector('#slideshowContainer'));const ch=cc.querySelector('#challenges');if(ch)renderChallengesForProjectView(p.challengesData||[],ch.querySelector('#challengesContainer'));const qz=cc.querySelector('#quiz');if(qz)renderQuizForProjectView(p.quizData||[],qz.querySelector('#quizContainer'),qz.querySelector('#submitQuizBtn'));const fnl=nc?.querySelector('.nav-link');if(fnl){const ca=fnl.getAttribute('onclick')||'';const m=ca.match(/openProjectTab\\('([^']+)'/);openProjectTab(m?m[1]:'overview',fnl)}else{updateProjectProgressBar('')}}
function renderMedia(t,u,i){if(!u)return'';if(t==='image')return\`<img src="\${u}" loading="lazy" alt="\${i}">\`;if(t==='video')return\`<iframe src="\${u}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="\${i}"></iframe>\`;return''}
function renderLearnItemsForProjectView(d,c){if(!c)return;c.innerHTML='';const v=(d||[]).filter(i=>i.title&&i.title.trim());if(v.length===0){c.innerHTML='<p style="color:var(--text-light);font-style:italic;">No objectives.</p>';return}v.forEach((i,x)=>{const e=document.createElement('div');e.className='step';e.innerHTML=\`<div class="step-number">\${x+1}</div><div class="step-content"><strong>\${i.title}</strong>\${i.description?\`<p class="description">\${i.description}</p>\`:''}<div class="step-media" style="display:none;"></div></div>\`;const m=e.querySelector('.step-media');const mu=renderMedia(i.mediaType,i.mediaUrl,i.title||'');if(mu){m.style.display='block';m.innerHTML=mu}c.appendChild(e)})}
function renderChallengesForProjectView(d,c){if(!c)return;c.innerHTML='';const v=(d||[]).filter(i=>i.title&&i.title.trim());if(v.length===0){c.innerHTML='<p style="color:var(--text-light);font-style:italic;">No challenges.</p>';return}v.forEach(i=>{const e=document.createElement('div');e.className='step';e.innerHTML=\`<div class="step-number" style="background-color:var(--accent);color:var(--dark);">★</div><div class="step-content"><strong>\${i.title}</strong>\${i.description?\`<p class="description">\${i.description}</p>\`:''}<div class="step-media" style="display:none;"></div></div>\`;const m=e.querySelector('.step-media');const mu=renderMedia(i.mediaType,i.mediaUrl,i.title||'');if(mu){m.style.display='block';m.innerHTML=mu}c.appendChild(e)})}
function renderSlideshowForProjectView(d,c){const n=c?.closest('.content-section#slides')?.querySelector('.slide-nav');if(!c||!n)return;c.innerHTML='';const v=(d||[]).filter(s=>s.url&&s.url.trim());if(v.length===0){c.innerHTML='<p style="color:var(--text-light);font-style:italic;">No slides.</p>';n.style.display='none';return}n.style.display='flex';v.forEach((s,x)=>{const dv=document.createElement('div');dv.className='slide';const u=s.url.trim();const t=s.type==='image'?'image':'iframe';const ds=s.description||'';const ti=ds||'Slide '+(x+1);dv.innerHTML=\`<div class="slide-content-wrapper"></div>\${ds?\`<p>\${ds}</p>\`:''}\`;const w=dv.querySelector('.slide-content-wrapper');w.innerHTML=renderMedia(t,u,ti);c.appendChild(dv)});currentSlideIndex=0;showSlide(0)}
function renderQuizForProjectView(d,c,b){if(!c||!b)return;c.innerHTML='';c.closest('.content-section#quiz')?.querySelector('.final-quiz-result')?.remove();b.disabled=!1;b.style.display='none';const v=(d||[]).filter(q=>q.questionText&&q.questionText.trim()&&q.correctAnswer&&q.correctAnswer.trim());if(v.length===0){c.innerHTML='<p style="color:var(--text-light);font-style:italic;">No quiz.</p>';return}b.style.display='block';v.forEach((q,x)=>{const dv=document.createElement('div');dv.className='quiz-question';dv.innerHTML=\`<p class="question-text">\${x+1}. \${q.questionText}</p><div class="quiz-options"></div><div class="quiz-feedback correct" style="display:none;">Correct!</div><div class="quiz-feedback incorrect" style="display:none;"></div>\`;const od=dv.querySelector('.quiz-options');let os=[q.correctAnswer.trim()];(q.incorrectAnswers||[]).forEach(a=>{if(a&&a.trim())os.push(a.trim())});shuffleArray(os);os.forEach(ot=>{const cr=ot===q.correctAnswer.trim();const oe=document.createElement('div');oe.className='quiz-option';oe.textContent=ot;oe.setAttribute('role','button');oe.tabIndex=0;oe.onclick=()=>selectQuizOption(oe);oe.onkeydown=e=>{if(e.key==='Enter'||e.key===' ')selectQuizOption(oe)};oe.dataset.isCorrect=cr.toString();od.appendChild(oe)});c.appendChild(dv)})}
function openProjectTab(tn,cl){const c=document.getElementById('projectTabContentContainer');if(!c)return;c.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));const n=document.getElementById('project-nav');if(n)n.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));const t=c.querySelector('#'+tn);if(t)t.classList.add('active');cl?.classList.add('active');updateProjectProgressBar(tn)}
function updateProjectProgressBar(tn){const p=document.getElementById('progressBar');if(!p)return;let r=0;const o=['overview','video','slides','challenges','quiz'];const i=o.indexOf(tn);if(i>=0)r=((i+1)/o.length)*100;p.style.width=r+'%'}
function showSlide(n){const s=document.querySelectorAll('#project-view #slideshowContainer .slide');const c=s.length;if(c===0)return;s.forEach(sl=>sl.classList.remove('active'));currentSlideIndex=(n%c+c)%c;if(s[currentSlideIndex])s[currentSlideIndex].classList.add('active')}
function nextSlide(){showSlide(currentSlideIndex+1)}function prevSlide(){showSlide(currentSlideIndex-1)}
function selectQuizOption(oe){const qd=oe.closest('.quiz-question');if(!qd||qd.classList.contains('answered'))return;qd.querySelectorAll('.quiz-option').forEach(o=>o.classList.remove('selected'));oe.classList.add('selected')}
function markProjectAsCompletedInView(pid){const p=courseDataForView.projects.find(pr=>pr.id===pid);if(p&&!p.isCompleted)p.isCompleted=!0;}
function submitQuiz(){const qs=document.querySelectorAll('#project-view #quizContainer .quiz-question');let an=0,sc=0;const tt=qs.length;if(tt===0)return;let fu=null;qs.forEach(q=>{const s=q.querySelector('.quiz-option.selected');q.classList.remove('answered');q.querySelectorAll('.quiz-feedback').forEach(f=>f.style.display='none');q.querySelectorAll('.quiz-option').forEach(o=>{o.classList.remove('correct','incorrect');o.style.opacity='1';o.style.cursor='pointer';o.onclick=()=>selectQuizOption(o);o.onkeydown=e=>{if(e.key==='Enter'||e.key===' ')selectQuizOption(oe)}});q.style.outline='';if(s)an++;else if(!fu)fu=q});if(an<tt){alert('Answer all '+tt+' questions!');if(fu){fu.scrollIntoView({behavior:'smooth'});fu.style.outline='2px solid var(--danger)';setTimeout(()=>fu.style.outline='',2500)}return}qs.forEach(q=>{const s=q.querySelector('.quiz-option.selected');const fc=q.querySelector('.quiz-feedback.correct');const fi=q.querySelector('.quiz-feedback.incorrect');const ao=q.querySelectorAll('.quiz-option');q.classList.add('answered');const isc=s.dataset.isCorrect==='true';ao.forEach(o=>{const oc=o.dataset.isCorrect==='true';if(oc)o.classList.add('correct');if(o===s){if(!isc)o.classList.add('incorrect')}else if(!oc||o!==q.querySelector('.quiz-option.correct')){o.style.opacity="0.6"}o.style.cursor="default";o.onclick=null;o.onkeydown=null});if(isc){sc++;if(fc)fc.style.display='block'}else{if(fi){const co=q.querySelector('.quiz-option.correct');fi.textContent=\`Incorrect. Correct: "\${co?co.textContent:'N/A'}"\`;fi.style.display='block'}}});const b=document.querySelector('#project-view #submitQuizBtn');if(b)b.disabled=!0;const qc=document.querySelector('#project-view #quiz');let rd=qc?.querySelector('.final-quiz-result');if(!rd&&qc){rd=document.createElement('div');qc.appendChild(rd)}if(rd){const pc=tt>0?Math.round((sc/tt)*100):0;const ps=pc>=70;rd.textContent=\`Quiz Complete! \${sc}/\${tt} (\${pc}%).\`;rd.className='final-quiz-result '+(ps?'success':'fail');rd.style.display='block';rd.scrollIntoView({behavior:'smooth'});if(ps&&currentProjectIdForView)markProjectAsCompletedInView(currentProjectIdForView)}}
document.addEventListener('DOMContentLoaded',function(){applyCourseThemeForView();renderCoursePageForView();let d=!1;if(window.location.hash&&window.location.hash.startsWith('#project-')){const p=window.location.hash.substring(9);if(courseDataForView.projects.some(j=>j.id===p)){showProjectView(p);d=!0}}if(!d)showCourseView();console.log("Exported Viewer Initialized.");});
            `;
            exportDocElement.querySelector('body').appendChild(viewerScript);

            // Generate HTML string and trigger download
            const htmlContent = '<!DOCTYPE html>\n' + exportDocElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const downloadUrl = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = downloadUrl;
            const filename = (courseData.title || "course").replace(/[^\w\s.-]/g, '').replace(/\s+/g, '_').toLowerCase() + '_export.html';
            a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(downloadUrl); console.log("Course export completed.");

        } catch (error) {
            console.error("Error during COURSE export:", error);
            alert("Export error. Check console.");
        }
    }


    // --- INITIAL PAGE LOAD (Editor Mode) ---
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Course Editor/Viewer Initializing (New Design)...");
        // checkProjectCompletionStatus(); // Load completion status if using persistence
        applyCourseTheme();
        renderCoursePage();

        // Check hash for deep linking
        let displayedProject = false;
        if (window.location.hash && window.location.hash.startsWith('#project-')) {
            const pid = window.location.hash.substring(9);
            if (courseData.projects.some(p => p.id === pid)) {
                showProjectView(pid);
                displayedProject = true;
            }
        }
        if (!displayedProject) {
            showCourseView(); // Default to course view
        }
        console.log("Initialization complete.");
    });

</script>

</body>
</html>
