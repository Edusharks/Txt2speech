<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fun Learning Adventures! 🚀</title> <!-- K12 Friendly Title -->

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">

<style>
    /* --- K12 Friendly Base Styles & Theme --- */
    :root {
        /* Cheerful Default Theme Colors */
        --primary: #00A9B5;    /* Teal */
        --secondary: #FFC800; /* Yellow */
        --accent: #FF6F61;     /* Coral/Orange */
        --light: #F8FDFF;      /* Very light blue/white */
        --dark: #2E3D4F;       /* Dark muted blue */
        --success: #6DD98A;    /* Friendly Green */
        --danger: #FF7B7B;     /* Softer Red */
        --white: #FFFFFF;
        --grey-light: #EAF0F6;
        --grey-medium: #CED9E5;
        --grey-dark: #8A9BA8;

        /* Font Settings */
        --font-display: 'Nunito', sans-serif; /* Fun, rounded */
        --font-body: 'Poppins', sans-serif; /* Clean, readable */
        --base-font-size: 16px;

        /* Transitions & Effects */
        --transition-speed: 0.3s;
        --transition-ease: ease-in-out;
        --border-radius-base: 12px; /* More rounded corners */
        --border-radius-large: 20px;
        --box-shadow-soft: 0 4px 15px rgba(46, 61, 79, 0.08);
        --box-shadow-lifted: 0 8px 25px rgba(46, 61, 79, 0.12);

        /* Icon SVGs (Self-contained) */
        --icon-edit: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffffff' width='20px' height='20px'%3E%3Cpath d='M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z'/%3E%3C/svg%3E");
        --icon-export: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffffff' width='20px' height='20px'%3E%3Cpath d='M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z'/%3E%3C/svg%3E");
        --icon-back: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffffff' width='24px' height='24px'%3E%3Cpath d='M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z'/%3E%3C/svg%3E");
        --icon-add: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffffff' width='16px' height='16px'%3E%3Cpath d='M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z'/%3E%3C/svg%3E");
        --icon-remove: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffffff' width='16px' height='16px'%3E%3Cpath d='M19 13H5v-2h14v2z'/%3E%3C/svg%3E");
        --icon-check: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffffff' width='24px' height='24px'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z'/%3E%3C/svg%3E");
        --icon-next: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffffff' width='18px' height='18px'%3E%3Cpath d='M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z'/%3E%3C/svg%3E");
        --icon-prev: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffffff' width='18px' height='18px'%3E%3Cpath d='M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z'/%3E%3C/svg%3E");
        --icon-overview: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z'/%3E%3Cpolyline points='9 22 9 12 15 12 15 22'/%3E%3C/svg%3E");
        --icon-video: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolygon points='5 3 19 12 5 21 5 3'/%3E%3C/svg%3E");
        --icon-steps: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cline x1='8' y1='6' x2='21' y2='6'/%3E%3Cline x1='8' y1='12' x2='21' y2='12'/%3E%3Cline x1='8' y1='18' x2='21' y2='18'/%3E%3Cline x1='3' y1='6' x2='3.01' y2='6'/%3E%3Cline x1='3' y1='12' x2='3.01' y2='12'/%3E%3Cline x1='3' y1='18' x2='3.01' y2='18'/%3E%3C/svg%3E");
        --icon-challenge: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Ccircle cx='12' cy='12' r='6'/%3E%3Ccircle cx='12' cy='12' r='2'/%3E%3C/svg%3E");
        --icon-quiz: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z'/%3E%3Cpath d='M14.5 9.5L11 13 9.5 11.5'/%3E%3C/svg%3E");

        /* Global CSS Variable Accessors (to update colors more easily) */
        --primary-rgb: 0, 169, 181; /* Teal */
        --secondary-rgb: 255, 200, 0; /* Yellow */
        /* Other vars set in applyThemeColors JS */
    }
    html { scroll-behavior: smooth; box-sizing: border-box; font-size: var(--base-font-size); }
    *, *:before, *:after { box-sizing: inherit; }
    body {
        font-family: var(--font-body);
        margin: 0;
        padding: 0;
        background-color: var(--light);
        color: var(--dark);
        line-height: 1.7; /* Slightly more spacing */
        transition: background-color var(--transition-speed) var(--transition-ease), color var(--transition-speed) var(--transition-ease);
        background-image: radial-gradient(var(--grey-light) 1px, transparent 1px); /* Subtle dot background */
        background-size: 15px 15px;
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 30px 20px; }
    h1, h2, h3, h4, h5, h6 { font-family: var(--font-display); font-weight: 800; color: var(--dark); margin-bottom: 0.8em; }
    h1 { font-size: 2.5rem; margin-bottom: 15px; } /* Header title specific below */
    h2 { font-size: 1.6rem; color: var(--primary); padding-bottom: 8px; margin-bottom: 30px; display: inline-block; position: relative; }
    h2::after { /* Playful underline */
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 50%;
        height: 5px;
        background-color: var(--secondary);
        border-radius: 5px;
        transition: background-color var(--transition-speed) var(--transition-ease);
    }
    h3 { font-size: 1.3rem; color: var(--accent); margin-top: 35px; margin-bottom: 15px; }
    a { color: var(--primary); text-decoration: none; transition: color var(--transition-speed); }
    a:hover { color: var(--accent); text-decoration: underline; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

    /* --- Generic UI Components --- */
    .icon-button {
        background-color: rgba(255, 255, 255, 0.2);
        color: var(--white);
        border: 1px solid rgba(255, 255, 255, 0.5);
        width: 44px;
        height: 44px;
        border-radius: 50%;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0; /* Hide text if any */
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        transition: all var(--transition-speed) var(--transition-ease);
        background-repeat: no-repeat;
        background-position: center center;
        background-size: 60%;
        position: absolute;
        z-index: 10;
    }
    .icon-button:hover { background-color: rgba(255, 255, 255, 0.4); transform: scale(1.1); box-shadow: 0 5px 12px rgba(0,0,0,0.2); }
    .icon-button.edit-btn { background-image: var(--icon-edit); top: 25px; right: 25px; }
    .icon-button.export-btn { background-image: var(--icon-export); top: 25px; right: 80px; /* Adjusted spacing */ }
    .icon-button.back-btn { background-image: var(--icon-back); top: 25px; right: 80px; }

    .btn {
        display: inline-block;
        padding: 12px 25px;
        border: none;
        border-radius: 30px; /* Pill shape */
        font-family: var(--font-display);
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        text-align: center;
        transition: all var(--transition-speed) var(--transition-ease);
        box-shadow: var(--box-shadow-soft);
        text-decoration: none;
        position: relative;
        overflow: hidden;
    }
    .btn-primary { background-color: var(--primary); color: var(--white); }
    .btn-primary:hover { background-color: color-mix(in srgb, var(--primary) 90%, black); transform: translateY(-2px); box-shadow: var(--box-shadow-lifted); }
    .btn-secondary { background-color: var(--secondary); color: var(--dark); }
    .btn-secondary:hover { background-color: color-mix(in srgb, var(--secondary) 90%, black); transform: translateY(-2px); box-shadow: var(--box-shadow-lifted); }
    .btn-accent { background-color: var(--accent); color: var(--white); }
    .btn-accent:hover { background-color: color-mix(in srgb, var(--accent) 90%, black); transform: translateY(-2px); box-shadow: var(--box-shadow-lifted); }
    .btn-success { background-color: var(--success); color: var(--white); }
    .btn-success:hover { background-color: color-mix(in srgb, var(--success) 90%, black); transform: translateY(-2px); box-shadow: var(--box-shadow-lifted); }
    .btn-danger { background-color: var(--danger); color: var(--white); }
    .btn-danger:hover { background-color: color-mix(in srgb, var(--danger) 90%, black); transform: translateY(-2px); box-shadow: var(--box-shadow-lifted); }
    .btn-grey { background-color: var(--grey-medium); color: var(--dark); }
    .btn-grey:hover { background-color: var(--grey-dark); color: var(--white); transform: translateY(-2px); box-shadow: var(--box-shadow-lifted); }

    /* --- Header Styles (Course & Project) --- */
    .page-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        margin-bottom: 40px;
        background: linear-gradient(135deg, var(--primary) 0%, color-mix(in srgb, var(--primary) 70%, var(--secondary)) 100%); /* Gradient using mix */
        color: var(--white);
        padding: 40px 30px;
        border-radius: var(--border-radius-large);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        text-align: center;
        position: relative;
        overflow: hidden; /* For potential decorative elements */
    }
    .page-header::before { /* Decorative element */
        content: '';
        position: absolute;
        bottom: -50px; right: -50px;
        width: 150px; height: 150px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        opacity: 0.7;
    }
    .page-header img.header-image {
        width: 140px; /* Slightly larger default */
        height: 140px;
        object-fit: cover;
        border-radius: 50%; /* Circular images */
        border: 5px solid var(--white);
        box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        background-color: var(--grey-light); /* BG for transparent PNGs */
    }
    #project-view .page-header img.header-image { width: 110px; height: 110px; } /* Smaller for project */

    .page-header .header-title-container { flex-grow: 1; }
    .page-header .header-title {
        color: var(--white);
        margin: 0 0 5px 0;
        font-size: 2.4rem; /* Larger, more prominent title */
        font-family: var(--font-display);
        font-weight: 800;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    }
    .page-header .header-subtitle {
        color: rgba(255, 255, 255, 0.95);
        font-size: 1.1rem;
        margin: 0;
        font-weight: 400; /* Lighter subtitle */
    }
    #project-view .page-header .header-title { font-size: 2.1rem; }
    #project-view .page-header .header-subtitle { font-size: 1.0rem; }


    /* --- Course View Specific Styles --- */
    #course-view { animation: fadeIn 0.5s; }
    #course-description-container {
        background-color: var(--white);
        padding: 30px 35px; /* More padding */
        border-radius: var(--border-radius-large);
        box-shadow: var(--box-shadow-soft);
        margin-bottom: 40px;
        font-size: 1.05rem;
        line-height: 1.8; /* Even more line height */
        position: relative;
        overflow: hidden;
    }
     #course-description-container h2 { /* Header inside the description box */
         margin-bottom: 15px;
         font-size: 1.4rem;
         color: var(--primary); /* Override global h2 color if needed */
     }
      #course-description-container h2::after { left: 0; width: 40px; } /* Adjust underline */

    #projectGrid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Responsive grid */
        gap: 30px; /* More space between cards */
        margin-top: 20px;
    }
    .project-tab { /* Project Card */
        background-color: var(--white);
        border-radius: var(--border-radius-large);
        box-shadow: var(--box-shadow-soft);
        overflow: hidden;
        cursor: pointer;
        transition: transform var(--transition-speed) var(--transition-ease), box-shadow var(--transition-speed) var(--transition-ease);
        display: flex;
        flex-direction: column;
        text-decoration: none;
        color: inherit;
        position: relative; /* For completion badge */
        border: 1px solid var(--grey-light);
    }
    .project-tab:hover {
        transform: translateY(-8px) scale(1.02); /* More dynamic hover */
        box-shadow: var(--box-shadow-lifted);
    }
    .project-tab img {
        width: 100%;
        height: 180px; /* Adjusted height */
        object-fit: cover;
        display: block;
        border-bottom: 1px solid var(--grey-light); /* Subtle separator */
    }
    .project-tab-info {
        padding: 20px; /* More padding inside card */
        text-align: center;
        background-color: var(--white);
        flex-grow: 1;
        display: flex;
        flex-direction: column; /* Stack title and potentially progress */
        align-items: center;
        justify-content: center;
        min-height: 80px; /* Ensure some height even with short titles */
    }
    .project-tab-info span { /* Project Title */
        font-family: var(--font-display);
        font-weight: 700; /* Bold */
        color: var(--primary);
        font-size: 1.2rem; /* Larger title */
        transition: color var(--transition-speed) var(--transition-ease);
        line-height: 1.3;
    }
    .completion-badge { /* Changed from tick to badge */
        position: absolute;
        top: 15px;
        right: 15px;
        width: 35px;
        height: 35px;
        background-color: var(--success);
        background-image: var(--icon-check);
        background-size: 60%;
        background-repeat: no-repeat;
        background-position: center center;
        color: var(--white);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0; /* Hide text */
        box-shadow: 0 3px 7px rgba(0,0,0,0.2);
        z-index: 5;
    }


    /* --- Project View Specific Styles --- */
    #project-view {
        animation: fadeIn 0.5s;
        /* Project specific font/size applied here via JS on the #project-view element */
    }
    /* Progress Bar */
    .progress-container{
        width: 100%; background-color: var(--grey-light);
        border-radius: 20px; /* Rounded */ margin: 30px 0; height: 16px; /* Thicker */
        overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
    }
    .progress-bar{
        height: 100%;
        background: linear-gradient(90deg, var(--secondary), color-mix(in srgb, var(--secondary) 70%, var(--accent)));
        border-radius: 20px; width: 0%;
        transition: width .6s ease-in-out, background var(--transition-speed) var(--transition-ease);
        display: flex; align-items: center; justify-content: flex-end;
        position: relative;
    }
    .progress-bar::after { /* Animated sparkle/shine effect */
        content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%);
        animation: progressShine 2s infinite linear;
        opacity: 0.6;
    }
    @keyframes progressShine { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

    /* Project Tabs */
    #projectTabs {
        display:flex; gap: 12px; /* Spacing */ margin-bottom: 25px; overflow-x:auto; padding-bottom: 10px; -webkit-overflow-scrolling:touch;
    }
    #projectTabs::-webkit-scrollbar{height:5px;background-color:var(--grey-light);border-radius:3px;}
    #projectTabs::-webkit-scrollbar-thumb{background-color:var(--grey-medium);border-radius:3px;}
    #projectTabs .tab{
        padding: 10px 18px; background-color: var(--white); border-radius: var(--border-radius-base); cursor:pointer; font-weight:600;
        box-shadow: 0 2px 5px rgba(0,0,0,.05); white-space:nowrap; font-size: 0.95rem; flex-shrink:0;
        transition: all var(--transition-speed) var(--transition-ease);
        border: 1px solid var(--grey-light);
        color: var(--grey-dark);
        display: flex; /* For icon alignment */
        align-items: center; gap: 8px; /* Space between icon and text */
    }
    #projectTabs .tab .tab-icon { /* Container for tab icon */
        width: 20px; height: 20px;
        background-color: var(--grey-dark); /* Default icon color */
        mask-repeat: no-repeat;
        mask-position: center center;
        mask-size: contain;
        -webkit-mask-repeat: no-repeat;
        -webkit-mask-position: center center;
        -webkit-mask-size: contain;
        transition: background-color var(--transition-speed);
    }
     /* Assign specific icons via mask */
     #projectTabs .tab[data-tab-id="overview"] .tab-icon { mask-image: var(--icon-overview); -webkit-mask-image: var(--icon-overview); }
     #projectTabs .tab[data-tab-id="video"] .tab-icon { mask-image: var(--icon-video); -webkit-mask-image: var(--icon-video); }
     #projectTabs .tab[data-tab-id="slides"] .tab-icon { mask-image: var(--icon-steps); -webkit-mask-image: var(--icon-steps); }
     #projectTabs .tab[data-tab-id="challenges"] .tab-icon { mask-image: var(--icon-challenge); -webkit-mask-image: var(--icon-challenge); }
     #projectTabs .tab[data-tab-id="quiz"] .tab-icon { mask-image: var(--icon-quiz); -webkit-mask-image: var(--icon-quiz); }


    #projectTabs .tab.active{
        background-color:var(--primary); color:var(--white); transform:translateY(-4px) scale(1.03); box-shadow: 0 6px 15px rgba(var(--primary-rgb, 0, 169, 181),.3);
        border-color: var(--primary);
    }
     #projectTabs .tab.active .tab-icon { background-color: var(--white); /* Active icon color */ }

    #projectTabs .tab:hover:not(.active){
        background-color:var(--grey-light); color: var(--primary); transform:translateY(-2px); box-shadow:0 4px 10px rgba(0,0,0,.08);
        border-color: var(--primary);
    }
    #projectTabs .tab:hover:not(.active) .tab-icon { background-color: var(--primary); }

    /* Tab Content Area */
    #projectTabContentContainer .tab-content{
        display:none; background-color:var(--white); padding:30px 35px; border-radius:var(--border-radius-large);
        box-shadow: var(--box-shadow-soft); animation:fadeIn .5s ease-out; margin-bottom:30px;
        border: 1px solid var(--grey-light);
    }
     #projectTabContentContainer .tab-content h2 { /* Specific styling for H2 within content */
        font-size: 1.5rem; margin-bottom: 20px;
        color: var(--primary); /* Use primary color for headings inside */
     }
     #projectTabContentContainer .tab-content h2::after { width: 45px; } /* Adjust underline */
     #projectTabContentContainer .tab-content h3 { color: var(--accent); font-size: 1.25rem; }

    #projectTabContentContainer .tab-content.active{display:block}

    /* --- Styling for Content Inside Project Tabs --- */

    /* Video */
    .video-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;margin:25px 0;border-radius:var(--border-radius-base);box-shadow:var(--box-shadow-soft);}
    .video-container iframe{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:var(--border-radius-base);border:none}
    #videoKeyPoints { padding-left: 25px; list-style-type: '🚀'; /* Fun list marker */ } /* Emoji may vary by OS */
    #videoKeyPoints li { padding-left: 10px; margin-bottom: 8px; }

    /* Slideshow */
    .slideshow{position:relative;margin:25px 0;background-color:var(--grey-light);padding:25px;border-radius:var(--border-radius-large); box-shadow: inset 0 0 10px rgba(0,0,0,0.05);}
    .slide{display:none;text-align:center}
    .slide-content-wrapper{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;margin:0 auto 20px;max-width:100%;background-color:var(--white);border-radius:var(--border-radius-base); box-shadow: var(--box-shadow-soft);}
    .slide iframe,.slide img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;border-radius:var(--border-radius-base); background-color:transparent;}
    .slide p.slide-caption {margin:15px 0 0;font-size: 0.95rem; color: var(--dark); font-style: italic;}
    .slide.active{display:block;animation:fadeIn .5s}
    .slide-nav { text-align: center; margin-top: 25px; display: flex; justify-content: center; gap: 20px; }
    .slide-nav button { /* Larger, more prominent nav buttons */
        background-color: var(--primary); color: var(--white); border: none; padding: 0; width: 50px; height: 50px; /* Square/Circle */
        border-radius: 50%; cursor: pointer; font-size: 0; /* Hide text */
        transition: all var(--transition-speed) var(--transition-ease);
        box-shadow: var(--box-shadow-soft);
        display: flex; align-items: center; justify-content: center;
        background-repeat: no-repeat; background-position: center center; background-size: 50%;
    }
     .slide-nav button.prev-btn { background-image: var(--icon-prev); }
     .slide-nav button.next-btn { background-image: var(--icon-next); }

    .slide-nav button:hover{ background-color: color-mix(in srgb, var(--primary) 90%, black); transform:scale(1.1); box-shadow: var(--box-shadow-lifted);}

    /* Steps & Challenges Styling */
    .step{display:flex;gap:25px;margin-bottom:30px;padding:25px;background-color:var(--white);border-radius:var(--border-radius-large);align-items:flex-start;border-left:8px solid var(--secondary);box-shadow:var(--box-shadow-soft); transition: border-color var(--transition-speed) var(--transition-ease); }
    #challengesContainer .step { border-left-color: var(--accent); } /* Different color for challenges */

    .step-number{background-color:var(--secondary);color:var(--dark);min-width:45px;height:45px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;flex-shrink:0;font-size:1.2rem;margin-top:4px; font-family: var(--font-display); transition: background-color var(--transition-speed) var(--transition-ease);}
    #challengesContainer .step-number { background-color: var(--accent); } /* Challenge indicator color */

    .step-content{flex:1;display:flex;flex-direction:column}
    .step-content strong{font-size:1.2rem; color:var(--primary);display:block;margin-bottom:8px; transition: color var(--transition-speed) var(--transition-ease); font-weight: 700;}
    .step-content p.description{margin:0 0 15px;font-size:1rem;color:var(--dark);line-height:1.7}
    .step-content p.description:last-child{margin-bottom:0}
    .step-content .step-media{margin-top:15px;max-width:100%;width:100%;overflow:hidden;border-radius:var(--border-radius-base);background-color:var(--grey-light);box-shadow:inset 0 1px 3px rgba(0,0,0,0.05)}
    .step-content .step-media img{display:block;max-width:100%;height:auto;border-radius:var(--border-radius-base);box-shadow:var(--box-shadow-soft)}
    .step-content .step-media iframe{display:block;width:100%;aspect-ratio:16/9;border:none;border-radius:var(--border-radius-base);box-shadow:var(--box-shadow-soft)}

    /* Quiz Styling */
    .quiz-question{background-color:var(--grey-light);padding:25px;margin-bottom:25px;border-radius:var(--border-radius-large);box-shadow:var(--box-shadow-soft);border: 2px solid transparent; transition: border-color 0.3s;}
    .quiz-question.unanswered-highlight { border-color: var(--danger); }
    .quiz-question p.question-text{margin:0 0 20px;font-size:1.1rem;font-weight:700;color:var(--dark)}
    .quiz-options{margin-top:15px;display:grid;grid-template-columns: 1fr; gap: 12px;} /* Grid layout for options */
    @media (min-width: 600px) { .quiz-options { grid-template-columns: 1fr 1fr; } } /* Two columns on wider screens */

    .quiz-option{display:flex; align-items: center; gap: 10px; padding: 15px 20px;margin-bottom:0;background-color:var(--white);border:2px solid var(--grey-medium);border-radius:var(--border-radius-base);cursor:pointer;transition:all .3s ease;font-size:1rem;position:relative;text-align:left; box-shadow: var(--box-shadow-soft); color: var(--dark);}
    .quiz-option::before { /* Radio button like indicator */
        content: ''; display: inline-block; width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--grey-dark); margin-right: 10px; background-color: var(--white); flex-shrink: 0; transition: all 0.2s ease;
    }
    .quiz-option:hover{background-color:var(--grey-light);border-color:var(--grey-dark);transform:translateY(-2px); box-shadow: var(--box-shadow-lifted);}
    .quiz-option.selected{border-color:var(--primary);background-color:color-mix(in srgb, var(--primary) 15%, var(--white)); font-weight: 600; color: var(--primary);}
    .quiz-option.selected::before { border-color: var(--primary); background-color: var(--primary); transform: scale(1.1); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 30%, white); }

    /* Answered State Styling */
    .quiz-question.answered .quiz-option { cursor: default; }
    .quiz-option.correct{background-color:var(--success);color:var(--white);border-color:var(--success);font-weight:700}
    .quiz-option.correct::before { border-color: var(--white); background-color: var(--white); } /* Check mark could go here via mask */
    .quiz-option.correct.selected{background-color:var(--success);color:var(--white);border-color:color-mix(in srgb, var(--success) 80%, black);} /* Darker border if selected correct */

    .quiz-option.incorrect.selected{background-color:var(--danger);color:var(--white);border-color:var(--danger);font-weight:700; }
    .quiz-option.incorrect.selected::before { border-color: var(--white); background-color: var(--white); } /* X mark could go here */

    /* Fade out non-correct/non-selected options after answer */
    .quiz-question.answered .quiz-option:not(.selected):not(.correct){opacity:.6;pointer-events:none; background-color:var(--grey-light); border-color: var(--grey-light); box-shadow: none; transform: none;}
    .quiz-question.answered .quiz-option.correct:not(.selected){opacity:1} /* Ensure correct answer is fully visible if not selected */

    /* Feedback messages */
    .quiz-feedback{margin-top:18px;padding:15px 20px;border-radius:var(--border-radius-base);display:none;font-size: 0.95rem;border-width:2px;border-style:solid; font-weight: 600;}
    .quiz-feedback.correct{background-color: color-mix(in srgb, var(--success) 20%, var(--white));color: color-mix(in srgb, var(--success) 80%, black);border-color: var(--success)}
    .quiz-feedback.incorrect{background-color: color-mix(in srgb, var(--danger) 20%, var(--white));color: color-mix(in srgb, var(--danger) 80%, black);border-color: var(--danger)}

    /* Final score */
    .final-quiz-result{margin-top:30px;padding:20px 25px;border-radius:var(--border-radius-large);text-align:center;font-weight:700;font-size:1.25rem; transition: all 0.5s;}
    .final-quiz-result.success{background-color:color-mix(in srgb, var(--success) 80%, var(--secondary)); /* Mix for fun */ color:var(--white);border:3px solid var(--success)}
    .final-quiz-result.fail{background-color:color-mix(in srgb, var(--danger) 30%, var(--white));color:color-mix(in srgb, var(--danger) 80%, black);border:3px dashed var(--danger)}

    /* Submit Button */
    .submit-btn {
        /* Inherit from .btn, add specifics */
        padding: 15px 35px; font-size: 1.1rem; margin-top: 30px;
        display: block; width: auto; max-width: 300px; margin-left:auto; margin-right:auto;
        background-color: var(--accent); color: var(--white);
    }
     .submit-btn:hover:not(:disabled) { background-color: color-mix(in srgb, var(--accent) 85%, black); transform: translateY(-3px) scale(1.02); box-shadow: var(--box-shadow-lifted); }
     .submit-btn:disabled{background-color:var(--grey-medium);color:var(--grey-dark);cursor:not-allowed;box-shadow:none;transform:none;opacity:.7}


    /* --- Modal Styles (Editor - Keep Functional but Aligned) --- */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(46, 61, 79, 0.7); /* Use dark color slightly transparent */ z-index:1000;overflow-y:auto;padding:5vh 15px} /* Use vh padding */
    .modal-content{background-color:var(--white);margin:0 auto;padding:35px 40px;border-radius:var(--border-radius-large);width:90%;max-width:850px;box-shadow:0 10px 40px rgba(0,0,0,.3);position:relative; animation: fadeInModal 0.4s ease-out; }
    @keyframes fadeInModal { from { opacity: 0; transform: translateY(-20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
    .close-modal{position:absolute;top:15px;right:20px;font-size:36px;font-weight:300;color:var(--grey-dark);cursor:pointer;line-height:1;z-index:1001;padding:0px 8px;transition: color 0.3s, transform 0.2s; border-radius: 50%;}
    .close-modal:hover{color:var(--danger); transform: rotate(90deg); background-color: var(--grey-light);}
    .modal h2 { color: var(--primary); margin-bottom: 25px; text-align: center; font-size: 1.8rem;}

    /* Edit Form Styling */
    .edit-form{margin-top:25px}
    .edit-form label{display:block;margin-bottom:8px;font-weight:600;color:var(--dark);font-size:.9rem}
    .edit-form input[type=text],.edit-form input[type=url],.edit-form textarea,.edit-form select{width:100%;padding:12px 15px;margin-bottom:18px;border:2px solid var(--grey-medium);border-radius:var(--border-radius-base);font-size:1rem;box-sizing:border-box; transition: border-color 0.3s, box-shadow 0.3s; background-color: var(--white);}
    .edit-form input:focus, .edit-form textarea:focus, .edit-form select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent); background-color: color-mix(in srgb, var(--primary) 5%, var(--white)); }
    .edit-form textarea{resize:vertical;min-height:90px; font-family: var(--font-body); }

    /* Buttons inside modals */
    .edit-form button, button.remove-item-btn, button.add-item-btn {
        /* Inherit .btn styles but allow override */
        padding: 8px 15px; border-radius: var(--border-radius-base); margin-right: 10px; margin-top: 10px; font-size: .9rem; font-weight: 600;
    }
    button.remove-item-btn{
        background-color:var(--danger); margin-left:10px; line-height:1; padding: 0; width: 32px; height: 32px;
        font-size: 0; background-image: var(--icon-remove); background-repeat: no-repeat; background-position: center; background-size: 16px 16px; box-shadow: none;
    }
    button.remove-item-btn:hover{ background-color:color-mix(in srgb, var(--danger) 85%, black); transform: scale(1.1); }

    button.add-item-btn{
        background-color:var(--success); display:inline-flex; align-items: center; gap: 5px; margin-top:15px;margin-left:0;margin-right:0;width:auto; padding: 8px 15px 8px 10px;
        background-image: var(--icon-add); background-repeat: no-repeat; background-position: 10px center; background-size: 16px 16px; padding-left: 30px; /* Make space for icon */
    }
    button.add-item-btn::before { display: none; } /* Remove potential inherited pseudo element */
    button.add-item-btn:hover{ background-color:color-mix(in srgb, var(--success) 85%, black); }

    .modal-actions { margin-top: 35px; text-align: right; border-top: 1px solid var(--grey-light); padding-top: 25px; }
    .modal-actions button { display: inline-block; /* From .btn */ width: auto; min-width: 120px; margin-left: 10px; }
    .modal-actions button.save-btn { /* Use specific class */ background-color: var(--success); color: var(--white); }
    .modal-actions button.save-btn:hover { background-color: color-mix(in srgb, var(--success) 85%, black); }
    .modal-actions button.cancel-btn { /* Use specific class */ background-color: var(--grey-medium); color: var(--dark); }
    .modal-actions button.cancel-btn:hover { background-color: var(--grey-dark); color: var(--white); }

    /* Structure within forms */
    .edit-section{margin-top:30px;padding-top:25px;border-top:1px solid var(--grey-light)}
    .edit-item-group{margin-bottom:25px;padding:25px;border:1px solid var(--grey-light);border-radius:var(--border-radius-large);background-color:#fff;position:relative; box-shadow: 0 2px 6px rgba(0,0,0,0.05);}
    .edit-item-group .remove-item-btn{position:absolute;top:15px;right:15px;}
    .edit-item-group>label:first-of-type{font-weight:700;color:var(--primary);font-size:1rem;margin-top:5px; display: block; margin-bottom: 15px;} /* Bold top-level label */
    .edit-item-group label{font-weight:600;color: var(--dark); font-size:.9rem}
    .edit-item-group input[type=text],.edit-item-group input[type=url],.edit-item-group textarea,.edit-item-group select{margin-bottom:15px}
    .media-controls{margin-top:15px;padding-top:15px;border-top:1px dashed var(--grey-medium)}
    .media-controls label{font-weight:600; color: var(--dark);font-size:.9rem}
    .media-url-input-container { margin-top: 8px; } /* Container for URL input */
    .incorrect-answer-label{font-size:.9rem;color:var(--grey-dark);margin-top:10px;font-weight:600}

    /* Style Editor Sections */
    .color-picker { display: flex; gap: 12px; margin-bottom: 18px; flex-wrap: wrap; align-items: center; }
    .color-option { width: 36px; height: 36px; border-radius: 50%; cursor: pointer; border: 3px solid var(--grey-light); transition: transform .2s, border-color .2s, box-shadow .2s; box-shadow: var(--box-shadow-soft); }
    .color-option.selected { border: 4px solid var(--primary); transform: scale(1.18); box-shadow: 0 0 0 4px var(--white), var(--box-shadow-lifted); }
    input[type=color] { width: 42px; height: 42px; border: none; padding: 0; border-radius: 50%; overflow: hidden; cursor: pointer; vertical-align: middle; background-color: white; box-shadow: var(--box-shadow-soft); transition: transform 0.2s;}
    input[type=color]:hover { transform: scale(1.1); }
    input[type=color]::-webkit-color-swatch-wrapper { padding: 0; }
    input[type=color]::-webkit-color-swatch { border: 3px solid var(--white); border-radius: 50%; }
    input[type=color].inherited-style { border: 3px dashed var(--grey-dark) !important; opacity: 0.7; }
    input[type=color].inherited-style::-webkit-color-swatch { border: 3px solid var(--white); }

    .font-selector,.size-selector {display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap}
    .font-option,.size-option {padding:8px 16px;border:2px solid var(--grey-medium);border-radius:var(--border-radius-base);cursor:pointer;transition: all .3s; font-size: 0.9rem; background-color: var(--white); color: var(--dark); font-weight: 600;}
    .font-option.selected, .size-option.selected{background-color:var(--primary);color:var(--white);border-color:var(--primary); transform: scale(1.05); box-shadow: var(--box-shadow-soft);}
    .font-option:hover:not(.selected), .size-option:hover:not(.selected) { background-color: var(--grey-light); border-color: var(--grey-dark);}

    /* --- Specific Modal Sections Formatting --- */
     /* Titles inside editor sections */
    #projectEditModal .edit-section h4, #courseEditModal .edit-section h4{
        color: var(--primary); margin-bottom: 20px; padding-bottom: 8px; border-bottom: 3px solid var(--secondary); display: inline-block; font-size: 1.3rem;
    }
     #projectEditModal .edit-section h5{ color: var(--accent); margin-top: 30px; margin-bottom: 15px; font-size: 1.1rem; font-weight: 700; }
     #projectEditModal #editingProjectNameLabel { color: var(--accent); font-weight: bold; background-color: var(--grey-light); padding: 2px 8px; border-radius: 5px;}
     #projectEditModal .form-hint, #courseEditModal .form-hint { font-size: 0.9rem; color: var(--grey-dark); margin-top: -10px; margin-bottom: 15px; font-style: italic;}

     /* Course Editor Project List */
    #courseEditModal #projectTabsEditor { margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--grey-light); }
    #projectTabsList { max-height: 350px; overflow-y: auto; padding-right: 10px; background-color: var(--grey-light); border-radius: var(--border-radius-base); padding: 15px;}
    .project-tab-edit-item { display: grid; grid-template-columns: auto 1fr auto; gap: 15px; align-items: center; padding: 15px; border: 1px solid var(--grey-medium); border-radius: var(--border-radius-base); margin-bottom: 12px; background-color: #fff; box-shadow: var(--box-shadow-soft);}
    .project-tab-edit-item .index { font-weight: bold; font-size: 1.1rem; color: var(--secondary); font-family: var(--font-display); background-color: var(--primary); color: var(--white); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;}
    .project-tab-edit-item .inputs { display: flex; flex-direction: column; gap: 8px;}
    .project-tab-edit-item label { font-size: 0.85rem; margin-bottom: 3px; color: var(--dark); font-weight: 600;}
    .project-tab-edit-item input { padding: 8px 12px; font-size: 0.95rem;}


    /* --- Media Queries (Adjustments for Smaller Screens) --- */
    @media (max-width:768px){
        .container { padding: 20px 15px; }
        h1 { font-size: 2rem; }
        h2 { font-size: 1.4rem; }
        h3 { font-size: 1.2rem; }

        .page-header{ flex-direction:column; text-align:center; padding: 30px 20px; gap:15px}
        .page-header img.header-image{width:100px;height:100px;}
        .page-header .header-title{font-size:1.9rem}
        .page-header .header-subtitle{font-size:1rem}
         #project-view .page-header img.header-image{width:90px;height:90px}
         #project-view .page-header .header-title { font-size: 1.7rem; }

        /* Stack icons vertically maybe */
        .icon-button { width: 40px; height: 40px; top: 15px; }
        .icon-button.edit-btn { right: 15px; }
        .icon-button.export-btn { right: 65px; } /* Adjust as needed */
        .icon-button.back-btn { right: 65px; } /* Adjust as needed */


        #projectGrid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;}
        .project-tab img { height: 160px; }
        .project-tab-info span { font-size: 1.1rem; }

        .step{align-items: flex-start; flex-direction: column; gap: 15px;}
        .step-number{margin-bottom: 5px; margin-top: 0; width: 40px; height: 40px; font-size: 1.1rem;}
        .step-content .step-media{max-width:100%}

        .modal-content{padding:25px 20px; width: 95%; }
        .modal h2 { font-size: 1.5rem; }

        #projectTabs .tab { padding: 8px 15px; font-size: 0.9rem; gap: 5px; }
        #projectTabs .tab .tab-icon { width: 18px; height: 18px; }
        #projectTabContentContainer .tab-content { padding: 25px; }
    }

     @media (max-width:480px){
         :root { --base-font-size: 15px; } /* Slightly smaller base */
         h1 { font-size: 1.8rem; }
         h2 { font-size: 1.3rem; }
         .container { padding: 15px 10px; }

         .page-header .header-title{font-size:1.6rem}
         .page-header .header-subtitle{font-size:.9rem}
         .page-header img.header-image{width:80px;height:80px;}
          #project-view .page-header img.header-image{width:70px;height:70px;}

         #projectGrid { grid-template-columns: 1fr; gap: 20px;} /* Single column */
         .project-tab img { height: 180px; } /* Can be taller in single column */

         .quiz-options { grid-template-columns: 1fr; } /* Ensure single column */
         .btn { padding: 10px 20px; font-size: 0.95rem; }
         .submit-btn { padding: 12px 30px; font-size: 1rem; max-width: 250px;}

         .modal-actions { text-align: center; }
         .modal-actions button { width: 48%; margin: 5px 1%; min-width: 100px;}

         .slide-nav button { width: 45px; height: 45px; }

         .step{ padding: 20px; gap: 10px; }
         .step-number { width: 35px; height: 35px; font-size: 1rem; }

         #projectTabs { gap: 8px; }
         #projectTabs .tab { padding: 6px 12px; font-size: 0.85rem; }
     }

</style>
</head>
<body>

<!-- Container for the whole application -->
<div class="container">

    <!-- == COURSE VIEW (Visible by default) == -->
    <div id="course-view">
        <header class="page-header" id="course-header">
             <!-- Using Icon Buttons -->
             <button class="icon-button edit-btn" onclick="openCourseEditModal()" aria-label="Edit Course Details" title="Edit Course"></button>
             <button class="icon-button export-btn" onclick="exportCourseHTML()" aria-label="Export Course HTML" title="Export Course"></button>
             <img src="https://images.unsplash.com/photo-1619410283995-43d9134e7656?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NXx8cHJvZ3JhbW1pbmd8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60" alt="Course Image" class="header-image" id="courseImage">
             <div class="header-title-container">
                 <h1 class="header-title" id="courseTitle">Course Title</h1>
                 <!-- Maybe a short tagline could go here -->
             </div>
        </header>

        <section id="course-description-container">
            <h2>Let's Explore! ✨</h2> <!-- More engaging header -->
            <p id="courseDescription">Loading course description...</p>
        </section>

        <section>
            <h2>Your Adventures!</h2> <!-- Renamed "Projects" -->
            <div id="projectGrid">
                <!-- Project tabs/cards will be dynamically inserted here -->
                <p>Getting ready...</p>
            </div>
        </section>
    </div>

    <!-- == PROJECT VIEW (Hidden by default) == -->
    <div id="project-view" style="display: none;">
        <!-- Project Header (Populated Dynamically) -->
        <header class="page-header" id="project-header">
            <button class="icon-button back-btn" id="backToCourseBtn" onclick="showCourseView()" aria-label="Back to Course" title="Back to Course"></button>
            <button class="icon-button edit-btn" onclick="openProjectEditModal()" aria-label="Edit Project" title="Edit Project"></button>
            <!-- Project Export Button REMOVED -->
            <img src="" alt="Project Image" class="header-image" id="projectImage">
            <div class="header-title-container">
                <h1 class="header-title" id="projectTitle">Project Title</h1>
                <p class="header-subtitle" id="projectSubtitle">Project Subtitle</p>
            </div>
        </header>

        <!-- Progress Bar -->
        <div class="progress-container" title="Your Progress!">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <!-- Project Navigation Tabs with Icons -->
        <nav class="tabs" id="projectTabs" aria-label="Project Sections">
             <!-- Added data-tab-id for easier styling/JS and aria-label -->
            <div class="tab active" onclick="openProjectTab('overview', this)" role="tab" aria-selected="true" aria-controls="overview" data-tab-id="overview"><span class="tab-icon"></span>Overview</div>
            <div class="tab" onclick="openProjectTab('video', this)" role="tab" aria-selected="false" aria-controls="video" data-tab-id="video"><span class="tab-icon"></span>Video Lesson</div>
            <div class="tab" onclick="openProjectTab('slides', this)" role="tab" aria-selected="false" aria-controls="slides" data-tab-id="slides"><span class="tab-icon"></span>Step-by-Step</div>
            <div class="tab" onclick="openProjectTab('challenges', this)" role="tab" aria-selected="false" aria-controls="challenges" data-tab-id="challenges"><span class="tab-icon"></span>Challenges</div>
            <div class="tab" onclick="openProjectTab('quiz', this)" role="tab" aria-selected="false" aria-controls="quiz" data-tab-id="quiz"><span class="tab-icon"></span>Quiz Time!</div>
        </nav>

        <!-- Main Content Area for Project Tabs -->
        <main id="projectTabContentContainer">
             <!-- Templates for each tab -->
             <section id="overview" class="tab-content active" role="tabpanel" aria-labelledby="tab-overview">
                 <h2>🚀 Project Mission!</h2>
                 <p id="overviewText">Loading overview...</p>
                 <h3>🎯 What You'll Master</h3>
                 <div id="learnContainer"><p>Loading learning objectives...</p></div>
             </section>
             <section id="video" class="tab-content" role="tabpanel" aria-labelledby="tab-video">
                 <h2>🎬 Video Time!</h2>
                 <p id="videoIntroText"></p>
                 <h3 id="videoTitle"></h3>
                 <div class="video-container">
                     <iframe src="" frameborder="0" loading="lazy" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen id="mainVideo" title="Project Video"></iframe>
                 </div>
                 <h3>💡 Key Discoveries</h3>
                 <ul id="videoKeyPoints" style="font-size: 1rem; padding-left: 25px; list-style: disc;"><p>Loading key points...</p></ul>
             </section>
             <section id="slides" class="tab-content" role="tabpanel" aria-labelledby="tab-slides">
                 <h2>🧱 Step-by-Step Guide</h2>
                 <div class="slideshow" id="slideshowContainer"><p>Loading slides...</p></div>
                 <nav class="slide-nav" aria-label="Slideshow Navigation">
                      <!-- Buttons using icons -->
                     <button class="prev-btn" onclick="prevSlide()" aria-label="Previous Slide" title="Previous"></button>
                     <button class="next-btn" onclick="nextSlide()" aria-label="Next Slide" title="Next"></button>
                 </nav>
             </section>
             <section id="challenges" class="tab-content" role="tabpanel" aria-labelledby="tab-challenges">
                 <h2>🏆 Extra Challenges!</h2>
                 <p>Ready for more fun? Try these bonus tasks:</p>
                 <div id="challengesContainer"><p>Loading challenges...</p></div>
             </section>
             <section id="quiz" class="tab-content" role="tabpanel" aria-labelledby="tab-quiz">
                 <h2>🧠 Quiz Time!</h2>
                 <p>Let's see what you've learned:</p>
                 <div id="quizContainer"><p>Loading quiz...</p></div>
                 <!-- Final result area added by script -->
                 <button class="btn btn-accent submit-btn" id="submitQuizBtn" onclick="submitQuiz()">Check Answers!</button>
             </section>
        </main>
    </div>

</div><!-- End .container -->


<!-- ==== MODALS ==== -->

<!-- == COURSE Editor Modal == -->
<div id="courseEditModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('courseEditModal')" title="Close Editor" aria-label="Close Course Editor">&times;</span>
        <h2>Edit Course ⚙️</h2>
        <form class="edit-form" onsubmit="event.preventDefault(); saveCourseChanges();">
            <section class="edit-section" style="border-top: none; padding-top: 0;">
                <h4>Course Basics</h4>
                <label for="editCourseTitle">Course Title:</label>
                <input type="text" id="editCourseTitle" required>

                <label for="editCourseImage">Course Header Image URL:</label>
                <input type="url" id="editCourseImage" placeholder="https://...">

                <label for="editCourseDescription">Course Description:</label>
                <textarea id="editCourseDescription" rows="6"></textarea>
            </section>

            <!-- Course Theme Color Editor -->
            <section id="courseStyleEditor" class="edit-section">
                 <h4>🎨 Course Colors</h4>
                 <p class="form-hint">Set the main colors for the whole course.</p>
                 <label>Primary Color:</label>
                 <div class="color-picker">
                     <div class="color-option" style="background-color: #00A9B5;" onclick="selectCourseColor('primary', '#00A9B5')" title="Teal"></div>
                     <div class="color-option" style="background-color: #8E44AD;" onclick="selectCourseColor('primary', '#8E44AD')" title="Purple"></div>
                     <div class="color-option" style="background-color: #3498DB;" onclick="selectCourseColor('primary', '#3498DB')" title="Blue"></div>
                     <div class="color-option" style="background-color: #2ECC71;" onclick="selectCourseColor('primary', '#2ECC71')" title="Green"></div>
                     <div class="color-option" style="background-color: #E74C3C;" onclick="selectCourseColor('primary', '#E74C3C')" title="Red"></div>
                     <input type="color" id="coursePrimaryColorPicker" oninput="customCourseColorSelected('primary', this.value)" aria-label="Custom Primary Color">
                 </div>
                 <label>Secondary Color:</label>
                 <div class="color-picker">
                    <div class="color-option" style="background-color: #FFC800;" onclick="selectCourseColor('secondary', '#FFC800')" title="Yellow"></div>
                    <div class="color-option" style="background-color: #F39C12;" onclick="selectCourseColor('secondary', '#F39C12')" title="Orange"></div>
                    <div class="color-option" style="background-color: #1ABC9C;" onclick="selectCourseColor('secondary', '#1ABC9C')" title="Turquoise"></div>
                    <div class="color-option" style="background-color: #FF7AC6;" onclick="selectCourseColor('secondary', '#FF7AC6')" title="Pink"></div>
                     <div class="color-option" style="background-color: #BDC3C7;" onclick="selectCourseColor('secondary', '#BDC3C7')" title="Silver"></div>
                     <input type="color" id="courseSecondaryColorPicker" oninput="customCourseColorSelected('secondary', this.value)" aria-label="Custom Secondary Color">
                 </div>
                 <label>Accent Color:</label>
                 <div class="color-picker">
                      <div class="color-option" style="background-color: #FF6F61;" onclick="selectCourseColor('accent', '#FF6F61')" title="Coral"></div>
                      <div class="color-option" style="background-color: #FFB800;" onclick="selectCourseColor('accent', '#FFB800')" title="Orange/Yellow"></div>
                      <div class="color-option" style="background-color: #9B59B6;" onclick="selectCourseColor('accent', '#9B59B6')" title="Amethyst"></div>
                      <div class="color-option" style="background-color: #34495E;" onclick="selectCourseColor('accent', '#34495E')" title="Wet Asphalt"></div>
                     <div class="color-option" style="background-color: #E67E22;" onclick="selectCourseColor('accent', '#E67E22')" title="Carrot"></div>
                     <input type="color" id="courseAccentColorPicker" oninput="customCourseColorSelected('accent', this.value)" aria-label="Custom Accent Color">
                 </div>
            </section>

            <!-- Project Tabs Editor -->
            <section id="projectTabsEditor" class="edit-section">
                 <h4>Manage Adventures</h4> <!-- Renamed "Project Tabs" -->
                 <div id="projectTabsList">
                     <!-- Project tab edit items will be listed here -->
                 </div>
                 <button type="button" class="btn add-item-btn" onclick="addProjectTabEditField()">New Adventure</button>
            </section>

            <div class="modal-actions">
                 <!-- Updated button classes and text -->
                 <button type="button" class="btn btn-grey cancel-btn" onclick="closeModal('courseEditModal')">Cancel</button>
                 <button type="submit" class="btn btn-primary save-btn">Save Course</button>
            </div>
        </form>
    </div>
</div>


<!-- == PROJECT Editor Modal == -->
<div id="projectEditModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('projectEditModal')" title="Close Editor" aria-label="Close Project Editor">&times;</span>
        <h2>Edit Adventure ✏️</h2>
         <p style="font-size: 0.95rem; color: #555; margin-bottom: 20px; text-align: center;">Now Editing: <strong id="editingProjectNameLabel"></strong></p>
        <form class="edit-form" onsubmit="event.preventDefault(); saveProjectChanges();">
             <input type="hidden" id="editingProjectId"> <!-- Store ID of project being edited -->

            <label for="editSectionProject">What part to edit?</label>
            <select id="editSectionProject" onchange="showProjectEditSection()">
                <option value="projMeta">Adventure Header &amp; Course Card</option>
                <option value="overview">Mission &amp; Skills</option>
                <option value="video">Video Lesson</option>
                <option value="slides">Step-by-Step Guide</option>
                <option value="challenges">Bonus Challenges</option>
                <option value="quiz">Quiz Questions</option>
                <option value="projStyle">Adventure Styles (Font, Size, Colors)</option>
            </select>

            <!-- === Project Metadata Edit === -->
            <section id="projMetaEdit" class="edit-section" style="border-top: none; padding-top: 10px;">
                 <h4>Adventure Header & Card</h4>
                <label for="editProject_Title">Adventure Title:</label>
                <input type="text" id="editProject_Title" required>
                <label for="editProject_Subtitle">Subtitle (short description):</label>
                <input type="text" id="editProject_Subtitle" placeholder="e.g., Let's build a flashing light!">
                <label for="editProject_HeaderImage">Header Image URL (appears on Adventure page):</label>
                <input type="url" id="editProject_HeaderImage" placeholder="https://...">
                <p class="form-hint">A small image, roughly square looks best (~110x110px).</p>
                 <hr style="margin: 25px 0; border-color: var(--grey-light);">
                 <label for="editProject_TabName">Card Name (on Course Page):</label>
                 <input type="text" id="editProject_TabName" required placeholder="e.g., Flashy Fun">
                 <label for="editProject_TabImage">Card Image URL (on Course Page):</label>
                 <input type="url" id="editProject_TabImage" placeholder="https://...">
                 <p class="form-hint">A rectangular image works well here (~300x180px).</p>
            </section>

            <!-- === Overview & Learn Edit === -->
            <section id="overviewEdit" class="edit-section" style="display:none;">
                 <h4>Mission Details</h4>
                <label for="editProject_OverviewText">What is this adventure about?</label>
                <textarea id="editProject_OverviewText" rows="5" placeholder="Describe the main goal..."></textarea>
                 <hr style="margin: 25px 0; border-color: var(--grey-light);">
                  <h4>Skills To Master</h4>
                  <p class="form-hint">List the cool things students will learn!</p>
                  <div id="learnEditContainer"> <!-- Populated by loadLearnEditFieldsForProject --> </div>
                  <button type="button" class="btn add-item-btn" onclick="addLearnEditField()">New Skill</button>
            </section>

            <!-- === Video Edit === -->
            <section id="videoEdit" class="edit-section" style="display:none;">
                 <h4>Video Time Content</h4>
                 <label for="editProject_VideoIntroText">Intro Text (Above Video):</label>
                 <input type="text" id="editProject_VideoIntroText" placeholder="e.g., Watch this quick guide...">
                 <label for="editProject_VideoTitle">Video Section Title:</label>
                 <input type="text" id="editProject_VideoTitle" placeholder="e.g., See How It Works!">
                 <label for="editProject_VideoUrl">Video Embed URL (YouTube, Vimeo, etc.):</label>
                 <input type="url" id="editProject_VideoUrl" placeholder="e.g., https://www.youtube.com/embed/...">
                 <label for="editProject_VideoKeyPoints">Key Discoveries (One per line):</label>
                 <textarea id="editProject_VideoKeyPoints" rows="5" placeholder="Important Point 1&#10;Another Cool Thing..."></textarea>
            </section>

            <!-- === Slides Edit === -->
            <section id="slidesEdit" class="edit-section" style="display:none;">
                <h4>Step-by-Step Slides</h4>
                <p class="form-hint">Break down the adventure into easy steps. Add images or embeds.</p>
                <div id="slidesEditContainer"> <!-- Populated by loadSlidesEditFieldsForProject --> </div>
                <button type="button" class="btn add-item-btn" onclick="addSlideEditField()">New Slide</button>
            </section>

            <!-- === Challenges Edit === -->
            <section id="challengesEdit" class="edit-section" style="display:none;">
                <h4>Bonus Challenges</h4>
                <p class="form-hint">Add optional challenges to test their skills further.</p>
                <div id="challengesEditContainer"> <!-- Populated by loadChallengesEditFieldsForProject --> </div>
                <button type="button" class="btn add-item-btn" onclick="addChallengeEditField()">New Challenge</button>
            </section>

            <!-- === Quiz Edit === -->
            <section id="quizEdit" class="edit-section" style="display:none;">
                <h4>Quiz Questions</h4>
                <p class="form-hint">Create questions to check understanding. One correct answer needed.</p>
                 <div id="quizEditContainer"> <!-- Populated by loadQuizEditFieldsForProject --> </div>
                 <button type="button" class="btn add-item-btn" onclick="addQuizEditField()">New Question</button>
            </section>

            <!-- === Project Style Edit === -->
            <section id="projStyleEdit" class="edit-section" style="display:none;">
                 <h4>Adventure Styles (Overrides)</h4>
                 <p class="form-hint">Change the look & feel just for this adventure. If nothing is selected, it uses the course defaults.</p>

                 <h5>🎨 Color Overrides</h5>
                 <p class="form-hint" style="margin-bottom: 10px;">Pick colors below to change from the main course theme. (Dashed border on color picker = using course default).</p>
                  <button type="button" onclick="clearProjectColorOverrides()" class="btn btn-grey" style="font-size: 0.85rem; padding: 5px 10px; margin-bottom: 20px; box-shadow: none; font-weight: normal;">Use Course Colors</button>

                 <label>Adventure Primary Color:</label>
                 <div class="color-picker" id="projectPrimaryColorPickerContainer">
                    <!-- Options matching Course options for consistency -->
                    <div class="color-option" style="background-color: #00A9B5;" onclick="selectProjectColor('primary', '#00A9B5')" title="Teal"></div>
                     <div class="color-option" style="background-color: #8E44AD;" onclick="selectProjectColor('primary', '#8E44AD')" title="Purple"></div>
                     <div class="color-option" style="background-color: #3498DB;" onclick="selectProjectColor('primary', '#3498DB')" title="Blue"></div>
                     <div class="color-option" style="background-color: #2ECC71;" onclick="selectProjectColor('primary', '#2ECC71')" title="Green"></div>
                     <div class="color-option" style="background-color: #E74C3C;" onclick="selectProjectColor('primary', '#E74C3C')" title="Red"></div>
                     <input type="color" id="projectPrimaryColorPicker" oninput="customProjectColorSelected('primary', this.value)" aria-label="Custom Project Primary Color">
                 </div>
                 <label>Adventure Secondary Color:</label>
                 <div class="color-picker" id="projectSecondaryColorPickerContainer">
                    <div class="color-option" style="background-color: #FFC800;" onclick="selectProjectColor('secondary', '#FFC800')" title="Yellow"></div>
                    <div class="color-option" style="background-color: #F39C12;" onclick="selectProjectColor('secondary', '#F39C12')" title="Orange"></div>
                    <div class="color-option" style="background-color: #1ABC9C;" onclick="selectProjectColor('secondary', '#1ABC9C')" title="Turquoise"></div>
                    <div class="color-option" style="background-color: #FF7AC6;" onclick="selectProjectColor('secondary', '#FF7AC6')" title="Pink"></div>
                    <div class="color-option" style="background-color: #BDC3C7;" onclick="selectProjectColor('secondary', '#BDC3C7')" title="Silver"></div>
                    <input type="color" id="projectSecondaryColorPicker" oninput="customProjectColorSelected('secondary', this.value)" aria-label="Custom Project Secondary Color">
                 </div>
                 <label>Adventure Accent Color:</label>
                 <div class="color-picker" id="projectAccentColorPickerContainer">
                      <div class="color-option" style="background-color: #FF6F61;" onclick="selectProjectColor('accent', '#FF6F61')" title="Coral"></div>
                      <div class="color-option" style="background-color: #FFB800;" onclick="selectProjectColor('accent', '#FFB800')" title="Orange/Yellow"></div>
                      <div class="color-option" style="background-color: #9B59B6;" onclick="selectProjectColor('accent', '#9B59B6')" title="Amethyst"></div>
                      <div class="color-option" style="background-color: #34495E;" onclick="selectProjectColor('accent', '#34495E')" title="Wet Asphalt"></div>
                     <div class="color-option" style="background-color: #E67E22;" onclick="selectProjectColor('accent', '#E67E22')" title="Carrot"></div>
                     <input type="color" id="projectAccentColorPicker" oninput="customProjectColorSelected('accent', this.value)" aria-label="Custom Project Accent Color">
                 </div>

                 <h5 style="margin-top: 30px;">✏️ Font & Size Overrides</h5>
                 <label>Adventure Font:</label>
                 <div class="font-selector" id="projectFontSelector">
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', null)" >Use Course Default (Poppins)</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Nunito', sans-serif`)" style="font-family: 'Nunito', sans-serif;">Nunito (Fun & Rounded)</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Poppins', sans-serif`)" style="font-family: 'Poppins', sans-serif;">Poppins (Clean)</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Comic Sans MS', cursive, sans-serif`)" style="font-family: 'Comic Sans MS', cursive;">Comic Sans (Classic Kid)</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Arial', Helvetica, sans-serif`)" style="font-family: Arial, sans-serif;">Arial (System)</div>
                 </div>

                 <label>Adventure Text Size:</label>
                 <div class="size-selector" id="projectSizeSelector">
                      <div class="size-option" onclick="selectProjectStyle('baseSize', null)">Use Course Default (Medium)</div>
                     <div class="size-option" onclick="selectProjectStyle('baseSize', 'small')">A Bit Smaller (14px)</div>
                     <div class="size-option" onclick="selectProjectStyle('baseSize', 'medium')">Medium (16px)</div>
                     <div class="size-option" onclick="selectProjectStyle('baseSize', 'large')">A Bit Bigger (18px)</div>
                 </div>
            </section>

            <div class="modal-actions">
                <button type="button" class="btn btn-grey cancel-btn" onclick="closeModal('projectEditModal')">Cancel</button>
                <button type="submit" class="btn btn-primary save-btn">Save Adventure</button>
            </div>
        </form>
    </div>
</div>


<script>
    // --- Global Data Storage ---
    let courseData = {
        // Using the K12 friendly theme defaults in the data as well
        title: "Micro:bit Adventures!",
        description: "Welcome explorers! Let's dive into the super fun world of coding and creating with the amazing BBC micro:bit. Get ready to build awesome projects and learn cool computer tricks!",
        imageUrl: "https://images.unsplash.com/photo-1518770660439-4636190af475?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8Y29kaW5nJTIwZm9yJTIwa2lkc3xlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=500&q=60", // More kid friendly image
        style: {
            primaryColor: '#00A9B5',   // Teal
            secondaryColor: '#FFC800', // Yellow
            accentColor: '#FF6F61',    // Coral
        },
        projects: [
            // Project 1: Beating Heart (Data mostly reused, check paths)
            {
                id: 'proj_heart',
                tabName: "Flashing Heart", // Renamed for clarity
                tabImage: "https://makecode.microbit.org/v0/beta-sim.html?nohw=1#pub:_7cvWKT73g7Pv", // MakeCode Share Image
                projectTitle: "Make a Flashing Heart ❤️", // Emojis!
                projectSubtitle: "Code your Micro:bit to show a heart that beats!",
                projectHeaderImage: "https://microbit.org/images/lessons/flashing-heart/animated-step-3.gif", // Animated gif might be nice
                overviewText: "Let's start our first Micro:bit quest! We'll learn basic code blocks by making the tiny LEDs on the Micro:bit light up like a flashing heart. It’s like magic, powered by code!",
                videoIntroText: "Watch this video to see how easy it is to drag, drop, and make the heart flash using the code blocks:",
                videoTitle: "Coding Our Flashing Heart!",
                videoUrl: "https://www.youtube.com/embed/2yzT7_QGLLc", // Reusing example
                videoKeyPoints: [
                    "The Micro:bit screen is a 5x5 grid of tiny lights (LEDs).",
                    "The 'forever' block is like a magic spell that keeps running!",
                    "Use 'show leds' to draw your own pictures.",
                    "'show icon' has cool ready-made pictures.",
                    "'pause (ms)' makes the computer wait (milliseconds are super fast!).",
                    "The order you put the blocks in matters!"
                ],
                learnData: [
                     { title: "Light Grid", description: "Learn about the 5x5 LED lights and how to switch them on!", mediaType: 'image', mediaUrl: 'https://os.mbed.com/docs/mbed-os/v6.16/apis/assets/images/Glossary_MB_LEDMatrix.png' },
                     { title: "Endless Loops", description: "Discover the 'forever' block that makes your code repeat again and again.", mediaType: 'none', mediaUrl: '' },
                     { title: "Show Pictures!", description: "Draw shapes with 'show leds' or pick icons like hearts.", mediaType: 'image', mediaUrl: 'https://microbit.org/images/lessons/flashing-heart/animated-step-3.gif' },
                     { title: "Controlling Speed", description: "Use the 'pause (ms)' block to decide how fast or slow your animation goes.", mediaType: 'none', mediaUrl: '' }
                ],
                slidesData: [
                    { url: "https://microbit.org/images/lessons/flashing-heart/animated-step-2.gif", description: "1. Drag 'show leds' into the 'forever' loop.", type: "image" },
                    { url: "https://microbit.org/images/lessons/flashing-heart/animated-step-3.gif", description: "2. Click the squares to draw a big heart!", type: "image" },
                    { url: "https://microbit.org/images/lessons/flashing-heart/animated-step-4.gif", description: "3. Add a 'pause (ms)' block. Set it to 500 (half a second).", type: "image" },
                    { url: "https://microbit.org/images/lessons/flashing-heart/animated-step-5.gif", description: "4. Get another 'show leds' block and draw a small heart.", type: "image" },
                    { url: "https://microbit.org/images/lessons/flashing-heart/animated-step-6.gif", description: "5. Add one more 'pause (ms)' block, also 500.", type: "image" },
                    { url: "https://makecode.microbit.org/v0/beta-sim.html?nohw=1#pub:_7cvWKT73g7Pv", description: "6. Check your code! Does it look like this?", type: "iframe" },
                ],
                challengesData: [
                    { title: "Super Speedy / Super Slow!", description: "Try changing the pause numbers! What happens if you use 100? Or 1000?", mediaType: 'none', mediaUrl: '' },
                    { title: "Icon Power!", description: "Use the 'show icon' block instead of 'show leds'. Pick the Heart and Small Heart icons. Does it look the same?", mediaType: 'none', mediaUrl: '' },
                    { title: "Your Own Movie!", description: "Can you make a different animation? Maybe a winking face?", mediaType: 'image', mediaUrl: 'https://lancaster-university.github.io/microbit-docs/assets/images/microbit-smiley.png' },
                ],
                quizData: [
                    { questionText: "Which block repeats code forever and ever?", correctAnswer: "'forever'", incorrectAnswers: ["'on start'", "'pause (ms)'", "'show icon'"] },
                    { questionText: "How many lights are on the Micro:bit screen?", correctAnswer: "25 (5 rows of 5)", incorrectAnswers: ["10", "5", "50"] },
                    { questionText: "What block tells the computer to wait for a bit?", correctAnswer: "'pause (ms)'", incorrectAnswers: ["'stop'", "'show leds'", "'forever'"] },
                    { questionText: "To make things flash or move, you show something, then _______, then show something else.", correctAnswer: "pause", incorrectAnswers: ["go fast", "draw", "button press"] }
                ],
                 style: { // Example of Project Specific Overrides - Softer heart theme?
                     primaryColor: '#E57373',   // Soft Red
                     secondaryColor: '#FFCDD2', // Light Pink
                     accentColor: '#F8BBD0',    // Lighter Pink
                     fontFamily: `'Nunito', sans-serif`, // Fun font for this project
                     baseSize: 'medium',
                 },
                 isCompleted: false // Completion flag
            },
            // Project 2: Smiley Buttons (Adjusted names and text)
            {
                 id: 'proj_smiley',
                 tabName: "Emoji Buttons", // Renamed
                 tabImage: "https://makecode.microbit.org/v0/beta-sim.html?nohw=1#pub:_LL1gP83dhL7K",
                 projectTitle: "Make Emoji Buttons! 😀😢", // Emoji Title
                 projectSubtitle: "Code buttons A and B to show different faces!",
                 projectHeaderImage: "https://teach.microbit.org/images/buttons.png", // Different image maybe
                 overviewText: "Let's make the Micro:bit react when you press its buttons! We'll code Button A to show a happy face 😀 and Button B to show a sad face 😢. It's all about telling the computer what to do WHEN something happens!",
                 videoIntroText: "See how to use the special 'on button pressed' blocks in this quick video:",
                 videoTitle: "Coding Our Emoji Buttons!",
                 videoUrl: "https://www.youtube.com/embed/Gk_Q8Rv9AlU", // Reusing example
                 videoKeyPoints: [
                     "'on button A pressed' listens for Button A clicks.",
                     "There's a matching block for Button B.",
                     "Code inside these ONLY runs when the button is pushed.",
                     "'show icon' makes showing faces super easy."
                    ],
                 learnData: [
                     {title:"Button Power!", description:"Learn how code can run when you press a button (that's an 'event'!).", mediaType:'image', mediaUrl:'https://teach.microbit.org/images/buttons.png'},
                     {title:"Action Blocks", description:"Discover that 'on button pressed' blocks are waiting for your command.", mediaType:'none', mediaUrl:''},
                     {title:"Which Button?", description:"Find Button A and Button B on your Micro:bit.", mediaType:'none', mediaUrl:''}
                  ],
                 slidesData: [
                     { url: "https://microbit.org/images/lessons/smiley-buttons/animated-step-2.gif", description: "1. Drag out an 'on button A pressed' block.", type: "image" },
                     { url: "https://microbit.org/images/lessons/smiley-buttons/animated-step-3.gif", description: "2. Put 'show icon' inside. Choose the Happy face!", type: "image" },
                     { url: "https://microbit.org/images/lessons/smiley-buttons/animated-step-4.gif", description: "3. Get another 'on button pressed'. Click 'A' and change it to 'B'.", type: "image" },
                     { url: "https://microbit.org/images/lessons/smiley-buttons/animated-step-5.gif", description: "4. Put 'show icon' inside the 'B' block. Choose the Sad face.", type: "image" },
                     { url: "https://makecode.microbit.org/v0/beta-sim.html?nohw=1#pub:_LL1gP83dhL7K", description: "5. Check your code! It should look something like this.", type: "iframe" },
                 ],
                 challengesData: [
                     {title: "Surprise!", description: "Can you make it show a 'Surprised' face 😮 if you press A and B TOGETHER? (Hint: Look for 'A+B' in the button block).", mediaType:'none', mediaUrl:''},
                     {title: "Screen Wipe!", description: "Try adding a 'clear screen' block at the start of each button press block (before 'show icon'). What changes?", mediaType:'none', mediaUrl:''},
                     {title: "Your Emojis!", description: "Pick different icons! What about a Ghost 👻 and a Skull 💀?", mediaType:'none', mediaUrl:''}
                 ],
                 quizData: [
                     {questionText: "Which block runs code ONLY when you click Button A?", correctAnswer:"'on button A pressed'", incorrectAnswers:["'forever'", "'show leds'", "'on start'"]},
                     {questionText: "What do we call something that happens, like pressing a button, that makes code run?", correctAnswer:"An event", incorrectAnswers:["A loop", "A light show", "A pause"]},
                     {questionText: "Which block shows pictures that are already drawn?", correctAnswer:"'show icon'", incorrectAnswers:["'show leds'", "'forever'", "'pause'"]}
                 ],
                 style: { fontFamily: null, baseSize: null, primaryColor: null, secondaryColor: null, accentColor: null }, // Inherit default course styles
                 isCompleted: false
             }
            // Add more project objects here...
        ]
    };

    // State variables (remain the same)
    let currentProjectId = null;
    let currentProjectDataCache = null;
    let currentSlideIndex = 0;

    // Constants for limits (remain the same)
    const MAX_PROJECTS = 24;
    const MAX_SLIDES = 10;
    const MAX_CHALLENGES = 10;
    const MAX_LEARN_ITEMS = 8;
    const MAX_QUIZ_QUESTIONS = 10;
    const MAX_INCORRECT_ANSWERS = 3;

    // --- THEME APPLICATION ---
    function hexToRgb(hex) { /* ... remains the same ... */
      let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
    }
    function applyThemeColors(primary, secondary, accent) { /* ... updated default fallbacks ... */
        const root = document.documentElement;
        const p = primary || '#00A9B5'; // Teal Default
        const s = secondary || '#FFC800'; // Yellow Default
        const a = accent || '#FF6F61'; // Coral Default
        root.style.setProperty('--primary', p);
        root.style.setProperty('--secondary', s);
        root.style.setProperty('--accent', a);
        const primaryRgb = hexToRgb(p); if (primaryRgb) root.style.setProperty('--primary-rgb', `${primaryRgb.r}, ${primaryRgb.g}, ${primaryRgb.b}`);
        const secondaryRgb = hexToRgb(s); if (secondaryRgb) root.style.setProperty('--secondary-rgb', `${secondaryRgb.r}, ${secondaryRgb.g}, ${secondaryRgb.b}`);
    }
    function applyCourseTheme() { /* ... updated default font/size ... */
        console.log("Applying COURSE theme");
        const courseStyle = courseData.style || {};
        applyThemeColors(courseStyle.primaryColor, courseStyle.secondaryColor, courseStyle.accentColor);
        const root = document.documentElement;
        // Apply global font/size defaults from K12 theme
        root.style.setProperty('--base-font-family', `var(--font-body, 'Poppins', sans-serif)`);
        root.style.setProperty('--base-font-size', `var(--base-font-size, 16px)`); // Use variable directly
        const projectViewEl = document.getElementById('project-view');
        if (projectViewEl) { projectViewEl.style.fontFamily = ''; projectViewEl.style.fontSize = ''; } // Reset project view styles
    }
    function applyProjectSpecificStyles(project) { /* ... adjusted font/size logic slightly ... */
        if (!project) return;
        console.log("Applying PROJECT specific styles for:", project.id);
        const projectStyle = project.style || {};
        const courseStyle = courseData.style || {}; // Fallback
        applyThemeColors( projectStyle.primaryColor || courseStyle.primaryColor, projectStyle.secondaryColor || courseStyle.secondaryColor, projectStyle.accentColor || courseStyle.accentColor );
        const projectViewEl = document.getElementById('project-view');
        if (projectViewEl) {
             const projectFont = projectStyle.fontFamily; // Can be null
             projectViewEl.style.fontFamily = projectFont ? projectFont : 'var(--base-font-family)'; // Fallback to course CSS var

             const projectSize = projectStyle.baseSize; // null, 'small', 'medium', 'large'
             let effectiveFontSize = 'var(--base-font-size)'; // Use CSS course var default
             if (projectSize === 'small') effectiveFontSize = '14px';
             else if (projectSize === 'large') effectiveFontSize = '18px';
             else if (projectSize === 'medium') effectiveFontSize = '16px';
             projectViewEl.style.fontSize = effectiveFontSize;
        }
    }

    // --- VIEW NAVIGATION ---
    function showCourseView() { /* ... same logic, just call K12 render function ... */
        document.getElementById('course-view').style.display = 'block';
        document.getElementById('project-view').style.display = 'none';
        currentProjectId = null;
        currentProjectDataCache = null;
        document.title = courseData.title || "Fun Learning Adventures!"; // Updated title
        applyCourseTheme();
        renderCoursePage(); // Re-render for completion badges
        window.scrollTo(0, 0);
    }
    function showProjectView(projectId) { /* ... same logic, just call K12 render/style functions ... */
        const project = courseData.projects.find(p => p.id === projectId);
        if (!project) { showCourseView(); return; }
        currentProjectId = projectId;
        renderProjectPage(project); // Call K12 render function
        document.getElementById('course-view').style.display = 'none';
        document.getElementById('project-view').style.display = 'block';
        document.title = project.projectTitle || "Adventure Time!"; // Updated title
        applyCourseTheme(); // Apply base theme first
        applyProjectSpecificStyles(project); // Apply project overrides
        window.scrollTo(0, 0);
         try { history.pushState({ projectId: projectId }, project.projectTitle || '', `#project-${projectId}`); } catch (e) { console.warn("History API failed."); }
    }
     window.onpopstate = function(event) { /* ... remains the same ... */
         if (event.state && event.state.projectId) { showProjectView(event.state.projectId); }
         else { showCourseView(); }
     };


    // --- COURSE PAGE RENDERING (K12 VERSION) ---
    function renderCoursePage() { /* ... updated classes/text ... */
        console.log("Rendering K12 Course Page");
        const course = courseData;
        document.getElementById('courseTitle').textContent = course.title;
        const courseImg = document.getElementById('courseImage');
        if(courseImg) { courseImg.src = course.imageUrl || ''; courseImg.alt = course.title + " Image"; }
        document.getElementById('courseDescription').textContent = course.description;
        const grid = document.getElementById('projectGrid');
        grid.innerHTML = ''; // Clear existing
        if (!course.projects || course.projects.length === 0) {
            grid.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No adventures added yet. Use the edit button!</p>';
            return;
        }
        course.projects.forEach(project => {
            if (!project || !project.id) return; // Skip bad data
            const tab = document.createElement('a');
            tab.className = 'project-tab'; // K12 Card style
            tab.href = `#project-${project.id}`;
            tab.onclick = (event) => { event.preventDefault(); showProjectView(project.id); };
            const img = document.createElement('img');
            img.src = project.tabImage || 'https://via.placeholder.com/300x180/00A9B5/fff?text=Adventure!'; // Default placeholder
            img.alt = project.tabName || 'Adventure Card';
            img.loading = 'lazy';
            const infoDiv = document.createElement('div');
            infoDiv.className = 'project-tab-info';
            const nameSpan = document.createElement('span');
            nameSpan.textContent = project.tabName || 'Unnamed Adventure';
            infoDiv.appendChild(nameSpan);
            tab.appendChild(img);
            tab.appendChild(infoDiv);
            // Use completion badge instead of tick
            if (project.isCompleted) {
                const badge = document.createElement('span');
                badge.className = 'completion-badge'; // K12 badge style
                badge.setAttribute('aria-label', 'Adventure Completed');
                badge.title = 'Adventure Completed!';
                tab.appendChild(badge);
            }
            grid.appendChild(tab);
        });
    }


    // --- PROJECT PAGE RENDERING (K12 VERSION) ---
    function renderProjectPage(project) { /* ... updated elements/classes/text ... */
        console.log("Rendering K12 Project:", project?.projectTitle);
        if (!project) { return; }
        const projectView = document.getElementById('project-view');
        if (!projectView) return;
        // Header
        const projectHeader = projectView.querySelector('#project-header');
        if (projectHeader) {
            projectHeader.querySelector('#projectImage').src = project.projectHeaderImage || project.tabImage || 'https://via.placeholder.com/110x110/00A9B5/fff?text=🚀';
            projectHeader.querySelector('#projectImage').alt = project.projectTitle + " Header";
            projectHeader.querySelector('#projectTitle').textContent = project.projectTitle || 'Adventure Title';
            projectHeader.querySelector('#projectSubtitle').textContent = project.projectSubtitle || '';
        }
        // Content Tabs
        const contentContainer = projectView.querySelector('#projectTabContentContainer');
        if (!contentContainer) return;
        // Overview
        const overviewContent = contentContainer.querySelector('#overview');
        if (overviewContent) {
            overviewContent.querySelector('#overviewText').textContent = project.overviewText || 'No mission details yet!';
            renderLearnItemsForProject(project.learnData || [], overviewContent.querySelector('#learnContainer')); // K12 specific renderer below
        }
        // Video
        const videoContent = contentContainer.querySelector('#video');
        if (videoContent) {
             const videoIframe = videoContent.querySelector('#mainVideo');
             const keyPointsUL = videoContent.querySelector('#videoKeyPoints');
             videoContent.querySelector('#videoIntroText').textContent = project.videoIntroText || '';
             videoContent.querySelector('#videoTitle').textContent = project.videoTitle || '';
             if(videoIframe) videoIframe.src = project.videoUrl || '';
             if(keyPointsUL) {
                 keyPointsUL.innerHTML = ''; // Clear
                 (project.videoKeyPoints || []).forEach(p => { if (p && p.trim()) keyPointsUL.innerHTML += `<li>${p.trim()}</li>`; });
                 if (keyPointsUL.innerHTML === '') keyPointsUL.innerHTML = '<li style="color: #888; font-style: italic; list-style-type: none;">No discoveries listed.</li>';
             }
        }
        // Slides
        const slidesContent = contentContainer.querySelector('#slides');
        if (slidesContent) {
            renderSlideshowForProject(project.slidesData || [], slidesContent.querySelector('#slideshowContainer')); // K12 specific renderer below
        }
        // Challenges
        const challengesContent = contentContainer.querySelector('#challenges');
        if (challengesContent) {
            renderChallengesForProject(project.challengesData || [], challengesContent.querySelector('#challengesContainer')); // K12 specific renderer below
        }
        // Quiz
        const quizContent = contentContainer.querySelector('#quiz');
        if (quizContent) {
             renderQuizForProject(project.quizData || [], quizContent.querySelector('#quizContainer'), quizContent.querySelector('#submitQuizBtn')); // K12 specific renderer below
        }
        // Activate first tab & update progress
        const projectTabsBar = projectView.querySelector('#projectTabs');
        if (projectTabsBar) {
             const firstProjectTabButton = projectTabsBar.querySelector('.tab');
             if (firstProjectTabButton) {
                  const firstTabId = firstProjectTabButton.getAttribute('data-tab-id') || 'overview';
                  openProjectTab(firstTabId, firstProjectTabButton);
             } else { updateProjectProgressBar(''); }
        }
    }


    // --- Project Specific Content Rendering Helpers (K12 VERSION) ---
    function renderLearnItemsForProject(learnItemsData, container) { /* Uses .step styles */
         if (!container) return; container.innerHTML = '';
         const validItems = (learnItemsData || []).filter(item => item.title && item.title.trim());
         if (validItems.length === 0) { container.innerHTML = '<p style="color: #888; font-style: italic;">No skills listed for this adventure!</p>'; return; }
         validItems.forEach((item, index) => {
             const el = document.createElement('div'); el.className = 'step'; // Use step styling from new CSS
             el.innerHTML = `<div class="step-number">${index + 1}</div>
                             <div class="step-content">
                                 <strong></strong>
                                 ${ item.description ? '<p class="description"></p>' : '' }
                                 <div class="step-media" style="display: none;"></div>
                             </div>`;
             el.querySelector('strong').textContent = item.title;
             if(item.description) el.querySelector('p.description').textContent = item.description;
             const mediaDiv = el.querySelector('.step-media');
             if (item.mediaType && item.mediaType !== 'none' && item.mediaUrl && item.mediaUrl.trim()) {
                mediaDiv.style.display = 'block';
                const url = item.mediaUrl.trim();
                const title = item.title || 'Media';
                if (item.mediaType === 'image') mediaDiv.innerHTML = `<img src="${url}" loading="lazy" alt="${title}">`;
                else if (item.mediaType === 'video') mediaDiv.innerHTML = `<iframe src="${url}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="${title}"></iframe>`;
             }
             container.appendChild(el);
         });
    }
    function renderChallengesForProject(challengesItemsData, container) { /* Uses .step styles */
         if (!container) return; container.innerHTML = '';
         const validItems = (challengesItemsData || []).filter(item => item.title && item.title.trim());
         if (validItems.length === 0) { container.innerHTML = '<p style="color: #888; font-style: italic;">No bonus challenges here... yet!</p>'; return; }
         validItems.forEach((item) => {
             const el = document.createElement('div'); el.className = 'step'; // Use step styling, challenge border/number color defined in CSS
             el.innerHTML = `<div class="step-number">★</div> <!-- Star icon -->
                              <div class="step-content">
                                 <strong></strong>
                                 ${ item.description ? '<p class="description"></p>' : '' }
                                 <div class="step-media" style="display: none;"></div>
                             </div>`;
             el.querySelector('strong').textContent = item.title;
            if(item.description) el.querySelector('p.description').textContent = item.description;
             const mediaDiv = el.querySelector('.step-media');
             if (item.mediaType && item.mediaType !== 'none' && item.mediaUrl && item.mediaUrl.trim()) {
                  mediaDiv.style.display = 'block';
                  const url = item.mediaUrl.trim();
                  const title = item.title || 'Challenge Media';
                  if (item.mediaType === 'image') mediaDiv.innerHTML = `<img src="${url}" loading="lazy" alt="${title}">`;
                  else if (item.mediaType === 'video') mediaDiv.innerHTML = `<iframe src="${url}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="${title}"></iframe>`;
             }
             container.appendChild(el);
         });
    }
     function renderSlideshowForProject(slidesItemsData, container) { /* updated caption class, nav button classes */
         const slidesView = container?.closest('.tab-content#slides');
         const nav = slidesView?.querySelector('.slide-nav');
         if (!container || !nav) { console.error("Slideshow container/nav missing"); return; }
         container.innerHTML = '';
         const validSlides = (slidesItemsData || []).filter(slide => slide.url && slide.url.trim());
         if (validSlides.length === 0) {
             container.innerHTML = '<p style="color: #888; font-style: italic;">No step-by-step guide here right now!</p>';
             nav.style.display = 'none';
             return;
         }
         nav.style.display = 'flex';
         validSlides.forEach((slide, index) => {
             const slideDiv = document.createElement('div'); slideDiv.className = 'slide';
             const contentType = slide.type === 'image' ? 'image' : 'iframe';
             const url = slide.url.trim();
             const title = slide.description || `Slide ${index + 1}`;
             slideDiv.innerHTML = `<div class="slide-content-wrapper"></div>${slide.description ? '<p class="slide-caption"></p>' : ''}`; // Added class to p
             const wrapper = slideDiv.querySelector('.slide-content-wrapper');
             if (contentType === 'iframe') wrapper.innerHTML = `<iframe src="${url}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="${title}"></iframe>`;
             else if (contentType === 'image') wrapper.innerHTML = `<img src="${url}" loading="lazy" alt="${title}">`;
             if (slide.description) slideDiv.querySelector('p.slide-caption').textContent = slide.description;
             container.appendChild(slideDiv);
         });
         currentSlideIndex = 0;
         showSlide(currentSlideIndex);
     }
      function renderQuizForProject(quizItemsData, container, submitBtn) { /* uses new quiz CSS classes */
          if (!container || !submitBtn) { return; }
          container.innerHTML = ''; // Clear
          container.closest('.tab-content#quiz')?.querySelector('.final-quiz-result')?.remove();
          submitBtn.disabled = false; submitBtn.style.display = 'none';
          const validQuestions = (quizItemsData || []).filter(q => q.questionText && q.questionText.trim() && q.correctAnswer && q.correctAnswer.trim());
          if (validQuestions.length === 0) {
              container.innerHTML = '<p style="color: #888; font-style: italic;">No quiz questions ready for this adventure!</p>';
              return; // Keep button hidden
          }
          submitBtn.style.display = 'block'; // Show if questions exist
          validQuestions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'quiz-question'; // Use new K12 style
                questionDiv.innerHTML = `<p class="question-text"></p><div class="quiz-options"></div><div class="quiz-feedback correct" style="display:none;">🎉 Correct! Good job!</div><div class="quiz-feedback incorrect" style="display:none;"></div>`;
                questionDiv.querySelector('.question-text').textContent = `${index + 1}. ${q.questionText}`;
                const optionsDiv = questionDiv.querySelector('.quiz-options');
                let options = [q.correctAnswer.trim()];
                 (q.incorrectAnswers || []).forEach(ans => { if (ans && ans.trim()) options.push(ans.trim()); });
                shuffleArray(options);
                options.forEach((optionText) => {
                    const isCorrect = (optionText === q.correctAnswer.trim());
                    const optionEl = document.createElement('div');
                    optionEl.className = 'quiz-option'; // Use new K12 style
                    optionEl.textContent = optionText;
                    optionEl.setAttribute('role', 'radio'); // More semantic?
                    optionEl.setAttribute('tabindex', '0');
                    optionEl.setAttribute('aria-checked', 'false');
                    optionEl.onclick = () => selectQuizOption(optionEl);
                    optionEl.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectQuizOption(optionEl); }};
                    optionEl.setAttribute('data-is-correct', isCorrect.toString());
                    optionsDiv.appendChild(optionEl);
                });
               container.appendChild(questionDiv);
          });
      }

    // --- Project-Specific Interaction Logic (mostly the same, small updates for UI changes) ---
    function openProjectTab(tabName, element) { /* Added ARIA handling */
        const container = document.getElementById('projectTabContentContainer');
        if (!container) return;
        container.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        const buttonsContainer = document.getElementById('projectTabs');
        if (buttonsContainer) {
            buttonsContainer.querySelectorAll('.tab').forEach(b => {
                b.classList.remove('active');
                b.setAttribute('aria-selected', 'false');
                b.setAttribute('tabindex', '-1'); // Improve keyboard nav for tabs
            });
        }
        const targetContent = container.querySelector('#' + tabName);
        if (targetContent) {
             targetContent.classList.add('active');
             targetContent.setAttribute('tabindex', '0'); // Focusable content
        }
        if (element) {
            element.classList.add('active');
            element.setAttribute('aria-selected', 'true');
            element.setAttribute('tabindex', '0');
        }
        updateProjectProgressBar(tabName);
    }
    function updateProjectProgressBar(tabName) { /* ... remains the same ... */
         const progressBar = document.getElementById('progressBar');
         if (!progressBar) return;
         let progress = 0;
         const tabOrder = ['overview', 'video', 'slides', 'challenges', 'quiz']; // Matches tab IDs/data-tab-id
         const tabIndex = tabOrder.indexOf(tabName);
         if (tabIndex >= 0) progress = ((tabIndex + 1) / tabOrder.length) * 100;
         progressBar.style.width = progress + '%';
         progressBar.setAttribute('aria-valuenow', Math.round(progress)); // Accessibility
    }
    function showSlide(n) { /* ... remains the same ... */
        const slides = document.querySelectorAll('#project-view #slideshowContainer .slide');
        const validSlidesCount = slides.length; if (validSlidesCount === 0) return;
        slides.forEach(slide => slide.classList.remove('active'));
        currentSlideIndex = (n % validSlidesCount + validSlidesCount) % validSlidesCount;
        if(slides[currentSlideIndex]) slides[currentSlideIndex].classList.add('active');
    }
    function nextSlide() { showSlide(currentSlideIndex + 1); }
    function prevSlide() { showSlide(currentSlideIndex - 1); }
    function selectQuizOption(optionElement) { /* Added ARIA */
        const questionDiv = optionElement.closest('.quiz-question');
        if (!questionDiv || questionDiv.classList.contains('answered')) return;
        questionDiv.querySelectorAll('.quiz-option').forEach(opt => {
            opt.classList.remove('selected');
            opt.setAttribute('aria-checked', 'false'); // Update ARIA
        });
        optionElement.classList.add('selected');
        optionElement.setAttribute('aria-checked', 'true'); // Update ARIA
    }
    function submitQuiz() { /* Added feedback on unanswered, adjusted selectors for new classes */
         const questions = document.querySelectorAll('#project-view #quizContainer .quiz-question');
         let answeredCount = 0, score = 0;
         const totalQuestions = questions.length; if (totalQuestions === 0) return;
         let firstUnanswered = null;
         // 1. Check answered & reset previous results/styles
         questions.forEach((qDiv) => {
              const selectedOption = qDiv.querySelector('.quiz-option.selected');
              qDiv.classList.remove('answered', 'unanswered-highlight'); // Remove potential highlight
              qDiv.querySelectorAll('.quiz-feedback').forEach(fb => fb.style.display = 'none');
              qDiv.querySelectorAll('.quiz-option').forEach(opt => {
                   opt.classList.remove('correct', 'incorrect'); opt.style.opacity = '1'; opt.style.cursor = 'pointer'; opt.setAttribute('aria-checked', 'false'); opt.onclick = () => selectQuizOption(opt); opt.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectQuizOption(opt); }};
              });
              if (selectedOption) { answeredCount++; }
              else if (!firstUnanswered) { firstUnanswered = qDiv; }
         });
         // 2. Stop if not all answered
         if (answeredCount < totalQuestions) {
             alert(`Oops! Please answer all ${totalQuestions} questions before checking! 😉`);
             if(firstUnanswered) {
                 firstUnanswered.scrollIntoView({behavior:'smooth',block:'center'});
                 firstUnanswered.classList.add('unanswered-highlight'); // Use class for highlight
                 setTimeout(()=> { firstUnanswered?.classList.remove('unanswered-highlight'); }, 2500);
             }
             return;
         }
         // 3. Grade the Quiz
         questions.forEach((qDiv) => {
              const selectedOption = qDiv.querySelector('.quiz-option.selected');
              const feedbackCorrect = qDiv.querySelector('.quiz-feedback.correct');
              const feedbackIncorrect = qDiv.querySelector('.quiz-feedback.incorrect');
              const allOptions = qDiv.querySelectorAll('.quiz-option');
              qDiv.classList.add('answered');
              const isSelectedCorrect = selectedOption.getAttribute('data-is-correct') === 'true';
              allOptions.forEach(opt => {
                   const optIsCorrect = opt.getAttribute('data-is-correct') === 'true';
                   if (optIsCorrect) opt.classList.add('correct');
                   if (opt === selectedOption && !isSelectedCorrect) opt.classList.add('incorrect');
                   // Update ARIA disabled state and potentially readonly/disabled attributes if needed for screen readers
                   opt.setAttribute('tabindex', '-1');
                   opt.style.cursor = "default"; opt.onclick = null; opt.onkeydown = null;
              });
              if (isSelectedCorrect) { score++; if(feedbackCorrect) feedbackCorrect.style.display='block'; }
              else {
                  if(feedbackIncorrect) {
                      const correctOptionElement = qDiv.querySelector('.quiz-option.correct');
                      feedbackIncorrect.textContent = `🤔 Not quite! The correct answer was: "${correctOptionElement ? correctOptionElement.textContent : 'N/A'}". Keep trying!`;
                      feedbackIncorrect.style.display='block';
                  }
              }
         });
         // 4. Show Final Result & Mark Complete
         const submitBtn = document.querySelector('#project-view #submitQuizBtn');
         if(submitBtn) submitBtn.disabled = true; // Disable after grading
         const quizTabContent = document.querySelector('#project-view #quiz');
         let resultDiv = quizTabContent?.querySelector('.final-quiz-result');
         if (!resultDiv && quizTabContent) { resultDiv = document.createElement('div'); quizTabContent.appendChild(resultDiv); }
          if (resultDiv) {
              const scorePercent = totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0;
              const passThreshold = 70; const passed = scorePercent >= passThreshold;
              let resultMessage = passed ? `🌟 Awesome! You passed! ` : `👍 Good effort! `;
              resultDiv.textContent = `${resultMessage} Score: ${score} / ${totalQuestions} (${scorePercent}%).`;
              resultDiv.className = 'final-quiz-result ' + (passed ? 'success' : 'fail');
              resultDiv.style.display = 'block';
              resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
              if (passed && currentProjectId) markProjectAsCompleted(currentProjectId);
          }
    }
    function markProjectAsCompleted(projectId) { /* ... remains the same ... */
         const project = courseData.projects.find(p => p.id === projectId);
         if (project && !project.isCompleted) { console.log(`Marking project ${projectId} completed.`); project.isCompleted = true; /* Add persistence if needed */ }
     }
     function checkProjectCompletionStatus() { /* ... remains the same (if used) ... */ }


    // --- MODAL & EDITING LOGIC (Should work with new CSS classes) ---
    function closeModal(modalId) { /* ... remains the same ... */
        const modal = document.getElementById(modalId); if(modal) modal.style.display = 'none'; currentProjectDataCache = null;
    }
    // Course Editor Open/Render/Add/Remove/Save...
    function openCourseEditModal() { /* ... Use updated defaults/text ... */
         const modal = document.getElementById('courseEditModal'); if (!modal) return;
         modal.querySelector('#editCourseTitle').value = courseData.title || '';
         modal.querySelector('#editCourseImage').value = courseData.imageUrl || '';
         modal.querySelector('#editCourseDescription').value = courseData.description || '';
         renderProjectTabsEditor();
         loadCourseColorSelections(); // Uses K12 defaults
         modal.style.display = 'block';
    }
    function renderProjectTabsEditor() { /* ... use new add button class */
         const listContainer = document.getElementById('projectTabsList'); if (!listContainer) return; listContainer.innerHTML = '';
         (courseData.projects || []).forEach((project, index) => {
             if (!project || !project.id) return;
             const itemDiv = document.createElement('div'); itemDiv.className = 'project-tab-edit-item'; itemDiv.setAttribute('data-project-id', project.id);
             itemDiv.innerHTML = `
                 <span class="index">${index + 1}</span>
                 <div class="inputs">
                     <label for="tab-name-${project.id}">Card Name:</label>
                     <input type="text" id="tab-name-${project.id}" class="edit-tab-name" value="${project.tabName || ''}" required>
                     <label for="tab-image-${project.id}">Card Image URL:</label>
                     <input type="url" id="tab-image-${project.id}" class="edit-tab-image" value="${project.tabImage || ''}" placeholder="https://...">
                 </div>
                 <button type="button" class="btn remove-item-btn" onclick="removeProjectTab('${project.id}', this)" title="Remove this adventure" aria-label="Remove Adventure ${project.tabName || index + 1}"></button> <!-- btn class added -->
             `; // SVG set via class
             listContainer.appendChild(itemDiv);
         });
         if (!courseData.projects || courseData.projects.length === 0) { listContainer.innerHTML = '<p style="font-style: italic; color: #666; text-align: center; padding: 10px 0;">No adventures added yet.</p>'; }
     }
    function addProjectTabEditField() { /* ... update text/defaults, limit check ... */
          if ((courseData.projects || []).length >= MAX_PROJECTS) { alert(`Wow! Maximum ${MAX_PROJECTS} adventures reached.`); return; }
          const newIndex = (courseData.projects?.length || 0) + 1;
          const newId = `proj_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`;
          const newProject = {
                id: newId, tabName: `New Adventure ${newIndex}`, tabImage: "", projectTitle: `Adventure ${newIndex}`, projectSubtitle: "", projectHeaderImage: "",
                overviewText: "What's the mission?", videoIntroText: "", videoTitle: "", videoUrl: "", videoKeyPoints: [],
                learnData: [], slidesData: [], challengesData: [], quizData: [],
                style: { fontFamily: null, baseSize: null, primaryColor: null, secondaryColor: null, accentColor: null }, // Inherits course style
                isCompleted: false
            };
          if (!courseData.projects) courseData.projects = []; courseData.projects.push(newProject); renderProjectTabsEditor();
          const listContainer = document.getElementById('projectTabsList');
          const newItemElement = listContainer?.querySelector(`[data-project-id="${newId}"]`);
          newItemElement?.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); newItemElement?.querySelector('input')?.focus();
     }
     function removeProjectTab(projectId, buttonElement) { /* ... Update confirm message ... */
          const projIndex = courseData.projects.findIndex(p=>p.id===projectId); if (projIndex === -1) return;
          const projName = courseData.projects[projIndex]?.tabName || projectId;
          if (!confirm(`🛑 Wait! Are you sure you want to REMOVE the adventure "${projName}"?\n\nThis deletes EVERYTHING inside it forever (steps, video, quiz...). It cannot be undone!`)) return;
          courseData.projects.splice(projIndex, 1); renderProjectTabsEditor(); renderCoursePage();
          if (currentProjectId === projectId) showCourseView();
     }
     // Course Color Logic
     function selectCourseColor(type, color) { /* ... Use K12 defaults, rest same ... */
        if (!courseData.style) courseData.style = {}; courseData.style[type + 'Color'] = color;
        applyCourseTheme(); // Apply live preview
        const pickerInputId = `course${type.charAt(0).toUpperCase() + type.slice(1)}ColorPicker`;
        const pickerInput = document.getElementById(pickerInputId);
         const pickerContainer = pickerInput?.closest('.color-picker');
         if (pickerInput) pickerInput.value = color || (type === 'primary' ? '#00A9B5' : type === 'secondary' ? '#FFC800' : '#FF6F61'); // Set input value, use K12 fallback
         if (pickerContainer) pickerContainer.querySelectorAll('.color-option').forEach(option => option.classList.toggle('selected', areColorsEqual(option.style.backgroundColor, color)));
     }
     function customCourseColorSelected(type, color) { selectCourseColor(type, color); /* ... same ... */ const pickerInputId = `course${type.charAt(0).toUpperCase() + type.slice(1)}ColorPicker`; const pickerContainer = document.getElementById(pickerInputId)?.closest('.color-picker'); pickerContainer?.querySelectorAll('.color-option').forEach(option => option.classList.remove('selected'));}
     function loadCourseColorSelections() { /* ... Use K12 defaults, rest same ... */
         selectCourseColor('primary', courseData.style?.primaryColor || '#00A9B5');
         selectCourseColor('secondary', courseData.style?.secondaryColor || '#FFC800');
         selectCourseColor('accent', courseData.style?.accentColor || '#FF6F61');
     }
    function saveCourseChanges() { /* ... No functional change needed ... */
         courseData.title = document.getElementById('editCourseTitle')?.value.trim() || courseData.title;
         courseData.imageUrl = document.getElementById('editCourseImage')?.value.trim() || courseData.imageUrl;
         courseData.description = document.getElementById('editCourseDescription')?.value.trim() || courseData.description;
         document.querySelectorAll('#projectTabsList .project-tab-edit-item').forEach(item => {
             const projectId = item.getAttribute('data-project-id'); const project = courseData.projects.find(p => p.id === projectId);
             if (project) { project.tabName = item.querySelector('.edit-tab-name')?.value.trim() || project.tabName || 'Unnamed Adventure'; project.tabImage = item.querySelector('.edit-tab-image')?.value.trim() || project.tabImage; }
         });
         applyCourseTheme(); renderCoursePage(); closeModal('courseEditModal');
         alert("✅ Course changes saved!"); // Friendlier alert
    }


    // --- Project Editor Open/Render Fields/Styles/Add/Remove/Save ... ---
    function openProjectEditModal() { /* ... same logic, checks for project ID ... */
         if (!currentProjectId) { alert("Select an adventure first to edit it!"); return; }
         const projectIndex = courseData.projects.findIndex(p => p.id === currentProjectId);
         if (projectIndex === -1) { alert("Error: Can't find data for this adventure."); return; }
         currentProjectDataCache = JSON.parse(JSON.stringify(courseData.projects[projectIndex])); // Deep clone
         const project = currentProjectDataCache; const modal = document.getElementById('projectEditModal'); if (!modal) return;
         modal.querySelector('#editingProjectId').value = project.id;
         modal.querySelector('#editingProjectNameLabel').textContent = project.projectTitle || project.tabName || 'Unnamed Adventure';
         // Load simple fields from CLONE
         modal.querySelector('#editProject_Title').value = project.projectTitle || '';
         modal.querySelector('#editProject_Subtitle').value = project.projectSubtitle || '';
         modal.querySelector('#editProject_HeaderImage').value = project.projectHeaderImage || '';
         modal.querySelector('#editProject_TabName').value = project.tabName || '';
         modal.querySelector('#editProject_TabImage').value = project.tabImage || '';
         modal.querySelector('#editProject_OverviewText').value = project.overviewText || '';
         modal.querySelector('#editProject_VideoIntroText').value = project.videoIntroText || '';
         modal.querySelector('#editProject_VideoTitle').value = project.videoTitle || '';
         modal.querySelector('#editProject_VideoUrl').value = project.videoUrl || '';
         modal.querySelector('#editProject_VideoKeyPoints').value = (project.videoKeyPoints || []).join('\n');
         // Load dynamic lists from CLONE
         loadLearnEditFieldsForProject(project.learnData || [], modal.querySelector('#learnEditContainer'));
         loadSlidesEditFieldsForProject(project.slidesData || [], modal.querySelector('#slidesEditContainer'));
         loadChallengesEditFieldsForProject(project.challengesData || [], modal.querySelector('#challengesEditContainer'));
         loadQuizEditFieldsForProject(project.quizData || [], modal.querySelector('#quizEditContainer'));
         // Load styles from CLONE
         loadProjectStyleSelections(project.style || {}); loadProjectColorSelections(project.style || {});
         modal.style.display = 'block'; document.getElementById('editSectionProject').value = 'projMeta'; showProjectEditSection();
    }
     // Editor Field Loaders (Learn, Slides, Challenges, Quiz)
     function createEditItemGroup(index, typePrefix, contentGenerator, removeHandler) { /* Updated button class */
          const itemGroup = document.createElement('div'); itemGroup.className = 'edit-item-group'; itemGroup.innerHTML = contentGenerator(index);
          const removeBtn = document.createElement('button'); removeBtn.type = 'button'; removeBtn.className = 'btn remove-item-btn'; /* Add btn class */ removeBtn.title = `Remove this ${typePrefix}`; removeBtn.setAttribute('aria-label', `Remove Item ${index + 1}`); removeBtn.onclick = () => removeHandler(itemGroup);
          itemGroup.appendChild(removeBtn);
          const mediaTypeSelect = itemGroup.querySelector('.media-type-select'); if (mediaTypeSelect) handleMediaTypeChange(mediaTypeSelect); return itemGroup;
     }
     function handleMediaTypeChange(selectElement) { /* ... same ... */ const urlContainer = selectElement.closest('.edit-item-group')?.querySelector('.media-url-input-container'); if (urlContainer) urlContainer.style.display = (selectElement.value === 'none' || !selectElement.value) ? 'none' : 'block'; }
     function loadLearnEditFieldsForProject(data, container) { /* Update labels/placeholders */
          if (!container) return; container.innerHTML = ''; const items = data || [];
          items.forEach((item, index) => { const pfx = 'learn'; const cnt = i => `<label for="${pfx}-title-${i}"><b>Skill ${i + 1} Title:</b></label><input type="text" id="${pfx}-title-${i}" class="${pfx}-title" value="${item.title||''}" required placeholder="e.g., Making Loops"><label for="${pfx}-desc-${i}">How it works:</label><textarea id="${pfx}-desc-${i}" class="${pfx}-desc" rows="2" placeholder="Explain the cool skill...">${item.description||''}</textarea><div class="media-controls"><label for="${pfx}-media-type-${i}">Show a picture/video?</label><select id="${pfx}-media-type-${i}" class="media-type-select" onchange="handleMediaTypeChange(this)"><option value="none" ${!item.mediaType||item.mediaType==='none'?'selected':''}>No Media</option><option value="image" ${item.mediaType==='image'?'selected':''}>Image URL</option><option value="video" ${item.mediaType==='video'?'selected':''}>Video Embed URL</option></select><div class="media-url-input-container" style="display:none;"><label for="${pfx}-media-url-${i}" class="sr-only">Media URL:</label><input type="url" id="${pfx}-media-url-${i}" class="media-url-input" placeholder="Paste URL here..." value="${item.mediaUrl||''}"></div></div>`; container.appendChild(createEditItemGroup(index, pfx, cnt, handleRemoveLearnItem)); });
          if (items.length === 0) container.innerHTML = '<p style="font-style: italic; color: #666; text-align: center;">No skills added yet.</p>';
     }
     function loadSlidesEditFieldsForProject(data, container) { /* Update labels/placeholders */
        if (!container) return; container.innerHTML = ''; const items = data || [];
        items.forEach((slide, index) => { const pfx = 'slide'; const cnt = i => `<label for="${pfx}-url-${i}"><b>Slide ${i+1} Content (Image or Embed Link):</b></label><input type="url" id="${pfx}-url-${i}" class="${pfx}-url" value="${slide.url||''}" required placeholder="Paste image link or embed code URL..."><label for="${pfx}-desc-${i}">Caption (optional):</label><input type="text" id="${pfx}-desc-${i}" class="${pfx}-desc" value="${slide.description||''}" placeholder="What's happening in this step?"><label for="${pfx}-type-${i}">What kind of content is this?</label><select id="${pfx}-type-${i}" class="${pfx}-type"><option value="iframe" ${!slide.type||slide.type==='iframe'?'selected':''}>Video/Embed</option><option value="image" ${slide.type==='image'?'selected':''}>Image</option></select>`; container.appendChild(createEditItemGroup(index, pfx, cnt, handleRemoveSlideItem)); });
        if (items.length === 0) container.innerHTML = '<p style="font-style: italic; color: #666; text-align: center;">No steps added yet.</p>';
     }
      function loadChallengesEditFieldsForProject(data, container) { /* Update labels/placeholders */
        if (!container) return; container.innerHTML = ''; const items = data || [];
        items.forEach((ch, index) => { const pfx='challenge'; const cnt=i=>`<label for="${pfx}-title-${i}"><b>Challenge ${i+1} Name:</b></label><input type="text" id="${pfx}-title-${i}" class="${pfx}-title" value="${ch.title||''}" required placeholder="e.g., Level Up!"><label for="${pfx}-desc-${i}">Describe the challenge:</label><textarea id="${pfx}-desc-${i}" class="${pfx}-desc" rows="2" placeholder="What should the student try next?">${ch.description||''}</textarea><div class="media-controls"><label for="${pfx}-media-type-${i}">Show a picture/video?</label><select id="${pfx}-media-type-${i}" class="media-type-select" onchange="handleMediaTypeChange(this)"><option value="none" ${!ch.mediaType||ch.mediaType==='none'?'selected':''}>No Media</option><option value="image" ${ch.mediaType==='image'?'selected':''}>Image URL</option><option value="video" ${ch.mediaType==='video'?'selected':''}>Video Embed URL</option></select><div class="media-url-input-container" style="display:none;"><label for="${pfx}-media-url-${i}" class="sr-only">Media URL:</label><input type="url" id="${pfx}-media-url-${i}" class="media-url-input" placeholder="Paste URL here..." value="${ch.mediaUrl||''}"></div></div>`; container.appendChild(createEditItemGroup(index,pfx,cnt,handleRemoveChallengeItem)); });
        if (items.length === 0) container.innerHTML = '<p style="font-style: italic; color: #666; text-align: center;">No bonus challenges added.</p>';
     }
      function loadQuizEditFieldsForProject(data, container) { /* Update labels/placeholders */
        if (!container) return; container.innerHTML = ''; const items = data || [];
        items.forEach((q, index) => { const pfx='quiz'; let incHTML=''; for(let k=0;k<MAX_INCORRECT_ANSWERS;k++){const v=(q.incorrectAnswers&&q.incorrectAnswers[k])?q.incorrectAnswers[k]:'';incHTML+=`<label for="${pfx}-incorrect-${index}-${k}" class="incorrect-answer-label">Wrong Option ${k+1} (Optional):</label><input type="text" id="${pfx}-incorrect-${index}-${k}" class="${pfx}-incorrect" value="${v}" placeholder="A tricky wrong answer...">`;} const cnt=i=>`<label for="${pfx}-question-${i}"><b>Question ${i+1}:</b></label><textarea id="${pfx}-question-${i}" class="${pfx}-question" rows="2" required placeholder="Ask something fun!">${q.questionText||''}</textarea><label for="${pfx}-correct-${i}" style="color:var(--success);font-weight:bold;">✅ Correct Answer:</label><input type="text" id="${pfx}-correct-${i}" class="${pfx}-correct" value="${q.correctAnswer||''}" required placeholder="The right choice">${incHTML}`; container.appendChild(createEditItemGroup(index,pfx,cnt,handleRemoveQuizItem)); });
        if (items.length === 0) container.innerHTML = '<p style="font-style: italic; color: #666; text-align: center;">No quiz questions added.</p>';
      }
     // Project Style & Color Logic (operate on CACHE)
     function loadProjectStyleSelections(projectStyleData) { /* Uses new font options */
         const modal = document.getElementById('projectEditModal'); if (!modal) return; const styleData = projectStyleData || {};
         const currentFont = styleData.fontFamily || null;
         const fontSelector = modal.querySelector('#projectFontSelector');
         if (fontSelector) fontSelector.querySelectorAll('.font-option').forEach(option => { const onclickAttr=option.getAttribute('onclick'); const match=onclickAttr?.match(/selectProjectStyle\('fontFamily',\s*(null|(['"`])(.*?)\2)\)/); let optionValue = undefined; if (match) optionValue = match[1] === 'null' ? null : match[3]; option.classList.toggle('selected', optionValue === currentFont); });
         const currentSize = styleData.baseSize || null;
         const sizeSelector = modal.querySelector('#projectSizeSelector');
         if (sizeSelector) sizeSelector.querySelectorAll('.size-option').forEach(option => { const onclickAttr=option.getAttribute('onclick'); const match=onclickAttr?.match(/selectProjectStyle\('baseSize',\s*(null|'small'|'medium'|'large')\)/); const optionValue=match?(match[1]==='null'?null:match[1]):undefined; option.classList.toggle('selected', optionValue === currentSize); });
     }
     function loadProjectColorSelections(projectStyleData) { /* ... remains same ... */ const styleData = projectStyleData || {}; selectProjectColor('primary', styleData.primaryColor || null, false); selectProjectColor('secondary', styleData.secondaryColor || null, false); selectProjectColor('accent', styleData.accentColor || null, false); }
     function selectProjectStyle(styleProperty, value) { /* ... remains same ... */ if (!currentProjectDataCache) return; if (!currentProjectDataCache.style) currentProjectDataCache.style = {}; currentProjectDataCache.style[styleProperty] = value; loadProjectStyleSelections(currentProjectDataCache.style); if (document.getElementById('project-view').style.display !== 'none') { applyProjectSpecificStyles(currentProjectDataCache); } }
     function selectProjectColor(type, color, applyLive = true) { /* ... use K12 course color defaults for display when null ... */
         if (!currentProjectDataCache) return; if (!currentProjectDataCache.style) currentProjectDataCache.style = {}; currentProjectDataCache.style[type + 'Color'] = color; // color can be null
         const pickerInputId = `project${type.charAt(0).toUpperCase() + type.slice(1)}ColorPicker`; const pickerInput = document.getElementById(pickerInputId); const pickerContainer = document.getElementById(`${pickerInputId}Container`);
         if (pickerInput) {
            const courseDefaultColor = courseData.style?.[type+'Color'] || (type==='primary'?'#00A9B5':type==='secondary'?'#FFC800':'#FF6F61');
            pickerInput.value = color || courseDefaultColor; pickerInput.classList.toggle('inherited-style', color === null); }
         if (pickerContainer) pickerContainer.querySelectorAll('.color-option').forEach(option => option.classList.toggle('selected', color !== null && areColorsEqual(option.style.backgroundColor, color)));
         if (applyLive && document.getElementById('project-view').style.display !== 'none') { applyProjectSpecificStyles(currentProjectDataCache); }
     }
     function customProjectColorSelected(type, color) { /* ... remains same ... */ selectProjectColor(type, color, true); const pickerContainer=document.getElementById(`project${type.charAt(0).toUpperCase()+type.slice(1)}ColorPickerContainer`); pickerContainer?.querySelectorAll('.color-option').forEach(option => option.classList.remove('selected')); }
     function clearProjectColorOverrides() { /* Update confirm text */ if (!confirm("Reset this adventure's colors to match the main course look?")) return; selectProjectColor('primary', null, false); selectProjectColor('secondary', null, false); selectProjectColor('accent', null, false); if (document.getElementById('project-view').style.display !== 'none') { applyProjectSpecificStyles(currentProjectDataCache); } alert("Adventure colors reset. Remember to save!"); }
     // Add/Remove handlers for dynamic lists (operate on CACHE)
     function findIndexAndRemove(element, dataArrayName, reloadFunctionName) { /* Update confirm text */
        if (!currentProjectDataCache || !currentProjectDataCache[dataArrayName]) return; const container = element.parentNode; const items = Array.from(container.children).filter(child => child.classList.contains('edit-item-group')); const index = items.indexOf(element);
        if (index > -1) {
             const itemType = dataArrayName.replace('Data', '').replace('learn', 'skill'); let confirmMsg = `Delete this ${itemType}?`;
             if (itemType === 'quiz' || itemType === 'slide' || itemType === 'challenge') confirmMsg = `🛑 Really delete this ${itemType} forever?`;
             if (confirm(confirmMsg)) { currentProjectDataCache[dataArrayName].splice(index, 1); window[reloadFunctionName](currentProjectDataCache[dataArrayName], container); }
        } else { element.remove(); } // Fallback remove visually
     }
     function handleRemoveLearnItem(e) { findIndexAndRemove(e, 'learnData', 'loadLearnEditFieldsForProject'); } function handleRemoveSlideItem(e) { findIndexAndRemove(e, 'slidesData', 'loadSlidesEditFieldsForProject'); } function handleRemoveChallengeItem(e) { findIndexAndRemove(e, 'challengesData', 'loadChallengesEditFieldsForProject'); } function handleRemoveQuizItem(e) { findIndexAndRemove(e, 'quizData', 'loadQuizEditFieldsForProject'); }
     function addItemToProjectData(dataArrayName, maxItems, newItemObject, reloadFunctionName, containerSelector, focusSelector = null) { /* Update limit text */ if (!currentProjectDataCache) return; if (!currentProjectDataCache[dataArrayName]) currentProjectDataCache[dataArrayName] = []; if (currentProjectDataCache[dataArrayName].length >= maxItems) { alert(`Hold on! Maximum ${maxItems} items allowed here.`); return; } currentProjectDataCache[dataArrayName].push(newItemObject); const container = document.querySelector(containerSelector); if (container && typeof window[reloadFunctionName] === 'function') { window[reloadFunctionName](currentProjectDataCache[dataArrayName], container); const lastItem = container.lastElementChild; if (lastItem?.classList.contains('edit-item-group')) { lastItem.scrollIntoView({behavior:'smooth',block:'nearest'}); if(focusSelector) lastItem.querySelector(focusSelector)?.focus(); } } else { console.error(`Reload func ${reloadFunctionName} / container ${containerSelector} issue.`); } }
     function addLearnEditField() { addItemToProjectData('learnData', MAX_LEARN_ITEMS, { title: "", description: "", mediaType:'none', mediaUrl:'' }, 'loadLearnEditFieldsForProject', '#projectEditModal #learnEditContainer', '.learn-title'); }
     function addSlideEditField() { addItemToProjectData('slidesData', MAX_SLIDES, { url: "", description: "", type:"iframe" }, 'loadSlidesEditFieldsForProject', '#projectEditModal #slidesEditContainer', '.slide-url'); }
     function addChallengeEditField() { addItemToProjectData('challengesData', MAX_CHALLENGES, { title: "", description: "", mediaType:'none', mediaUrl:'' }, 'loadChallengesEditFieldsForProject', '#projectEditModal #challengesEditContainer', '.challenge-title'); }
     function addQuizEditField() { addItemToProjectData('quizData', MAX_QUIZ_QUESTIONS, { questionText:"", correctAnswer:"", incorrectAnswers: Array(MAX_INCORRECT_ANSWERS).fill("") }, 'loadQuizEditFieldsForProject', '#projectEditModal #quizEditContainer', '.quiz-question'); }
     function showProjectEditSection() { /* ... remains same ... */
         const modal=document.getElementById('projectEditModal'); const select=document.getElementById('editSectionProject'); if(!modal||!select)return; modal.querySelectorAll('.edit-section').forEach(s=>s.style.display='none'); const sectionId='#'+select.value+'Edit'; const targetSection=modal.querySelector(sectionId); if(targetSection)targetSection.style.display='block';
     }
    // Save Project Changes
    function saveProjectChanges() { /* Update validation/success text, no major logic change */
         const projectId = document.getElementById('editingProjectId')?.value;
         const projectIndex = courseData.projects.findIndex(p => p.id === projectId);
         if (projectIndex === -1 || !currentProjectDataCache) { alert("Oops! Can't find the adventure data to save."); return; }
         const modal = document.getElementById('projectEditModal'); if (!modal) { alert("Error: Project edit modal broken."); return; }
         let updatedData = { id: projectId, isCompleted: currentProjectDataCache.isCompleted, style: currentProjectDataCache.style ? JSON.parse(JSON.stringify(currentProjectDataCache.style)) : {}, /* Read simple fields: */ projectTitle: modal.querySelector('#editProject_Title')?.value.trim() || 'Adventure', projectSubtitle: modal.querySelector('#editProject_Subtitle')?.value.trim() || '', projectHeaderImage: modal.querySelector('#editProject_HeaderImage')?.value.trim() || '', tabName: modal.querySelector('#editProject_TabName')?.value.trim() || 'Adventure Card', tabImage: modal.querySelector('#editProject_TabImage')?.value.trim() || '', overviewText: modal.querySelector('#editProject_OverviewText')?.value.trim() || '', videoIntroText: modal.querySelector('#editProject_VideoIntroText')?.value.trim() || '', videoTitle: modal.querySelector('#editProject_VideoTitle')?.value.trim() || '', videoUrl: modal.querySelector('#editProject_VideoUrl')?.value.trim() || '', videoKeyPoints: modal.querySelector('#editProject_VideoKeyPoints')?.value.split('\n').map(s=>s.trim()).filter(s=>s), /* Init lists */ learnData:[], slidesData:[], challengesData:[], quizData:[] };
         let isValid = true;
         try { /* Process Learn Items */ modal.querySelectorAll('#learnEditContainer .edit-item-group').forEach(item => { const titleInput=item.querySelector('.learn-title'); const title=titleInput?.value.trim(); if (title){const mt=item.querySelector('.media-type-select')?.value||'none';const muInput=item.querySelector('.media-url-input');const mu=(mt!=='none'&&muInput)?muInput.value.trim():'';if(mt!=='none'&&!mu){alert(`Don't forget the URL for the media in Skill: "${title}"!`);muInput?.focus();isValid=false;throw new Error("VFail");} updatedData.learnData.push({title:title,description:item.querySelector('.learn-desc')?.value.trim()||"",mediaType:mt,mediaUrl:mu}); titleInput.style.borderColor='';} else if(titleInput?.required){alert("Need a title for all Skills!");titleInput.style.borderColor='red';titleInput.focus();isValid=false;throw new Error("VFail");} }); if(!isValid) return;
             /* Process Slides */ modal.querySelectorAll('#slidesEditContainer .edit-item-group').forEach(item=>{ const urlInput=item.querySelector('.slide-url'); const url=urlInput?.value.trim(); if(url){updatedData.slidesData.push({url:url,description:item.querySelector('.slide-desc')?.value.trim()||"",type:item.querySelector('.slide-type')?.value||"iframe"});urlInput.style.borderColor='';}else if(urlInput?.required){alert("All Slides need a URL (link)!");urlInput.style.borderColor='red';urlInput.focus();isValid=false;throw new Error("VFail");} }); if(!isValid) return;
             /* Process Challenges */ modal.querySelectorAll('#challengesEditContainer .edit-item-group').forEach(item=>{ const titleInput=item.querySelector('.challenge-title');const title=titleInput?.value.trim(); if(title){const mt=item.querySelector('.media-type-select')?.value||'none'; const muInput=item.querySelector('.media-url-input');const mu=(mt!=='none'&&muInput)?muInput.value.trim():'';if(mt!=='none'&&!mu){alert(`Missing the URL for media in Challenge: "${title}"`);muInput?.focus();isValid=false;throw new Error("VFail");} updatedData.challengesData.push({title:title,description:item.querySelector('.challenge-desc')?.value.trim()||"",mediaType:mt,mediaUrl:mu});titleInput.style.borderColor='';}else if(titleInput?.required){alert("All Challenges need a Title!");titleInput.style.borderColor='red';titleInput.focus();isValid=false;throw new Error("VFail");} }); if(!isValid) return;
             /* Process Quiz */ modal.querySelectorAll('#quizEditContainer .edit-item-group').forEach(item=>{ const qInput=item.querySelector('.quiz-question'); const cInput=item.querySelector('.quiz-correct');const qText=qInput?.value.trim();const cAns=cInput?.value.trim(); if(qText&&cAns){let inc=[];item.querySelectorAll('.quiz-incorrect').forEach(inp=>{if(inp.value.trim())inc.push(inp.value.trim());});updatedData.quizData.push({questionText:qText,correctAnswer:cAns,incorrectAnswers:inc});qInput.style.borderColor='';cInput.style.borderColor='';}else{if(qInput?.required&&!qText){alert("Quiz Questions can't be empty!");qInput.style.borderColor='red';qInput.focus();isValid=false;throw new Error("VFail");} if(cInput?.required&&!cAns){alert("Need a Correct Answer for all quiz questions!");cInput.style.borderColor='red';cInput.focus();isValid=false;throw new Error("VFail");}} }); if(!isValid) return;
             // COMMIT Changes
             courseData.projects[projectIndex] = updatedData;
             // Update UI & Close
             applyProjectSpecificStyles(updatedData); renderProjectPage(updatedData); renderCoursePage(); closeModal('projectEditModal');
             alert(`✅ Adventure "${updatedData.projectTitle||updatedData.tabName}" saved!`); currentProjectDataCache=null;
         } catch (error) { if(error.message!=="VFail"){console.error("Save Error:",error); alert("Uh oh! Something went wrong saving. Maybe check the console?");} }
    }

    // --- Utility Functions ---
    function shuffleArray(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}}
    function areColorsEqual(c1, c2){ /* ... remains the same ... */ if (!c1 || !c2) return c1 === c2; if (c1.toLowerCase() === c2.toLowerCase()) return true; const convertToRgba = (color) => { const ctx = document.createElement('canvas').getContext('2d'); if (!ctx) return null; ctx.fillStyle = color; const computedColor = ctx.fillStyle; if (computedColor.startsWith('rgba')) return computedColor; if (computedColor.startsWith('#')) { const rgb = hexToRgb(computedColor); return rgb ? `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 1)` : null; } if (computedColor.startsWith('rgb(')) return computedColor.replace('rgb(', 'rgba(').replace(')', ', 1)'); return computedColor; }; try { const rgba1=convertToRgba(c1); const rgba2=convertToRgba(c2); return rgba1 && rgba2 && rgba1 === rgba2; } catch(e){ console.warn("Color compare fallback",e); return String(c1).trim().toLowerCase() === String(c2).trim().toLowerCase(); } }


    // --- EXPORT COURSE (Adjusted for new Icons/Classes) ---
    function exportCourseHTML() {
        console.log("Starting K12 COURSE export...");
        try {
            applyCourseTheme(); // Ensure base theme active
            const exportDoc = document.documentElement.cloneNode(true);

            // Remove Editor UI & controls
            exportDoc.querySelector('#courseEditModal')?.remove();
            exportDoc.querySelector('#projectEditModal')?.remove();
            exportDoc.querySelectorAll('.icon-button.edit-btn').forEach(btn => btn.remove());
            exportDoc.querySelectorAll('.icon-button.export-btn').forEach(btn => btn.remove());
            // KEEP .icon-button.back-btn for navigation within the export!

            // Set default viewer state
            exportDoc.querySelector('#course-view').style.display = 'block';
            exportDoc.querySelector('#project-view').style.display = 'none';
             const exportProjectView = exportDoc.querySelector('#project-view');
             if(exportProjectView) { exportProjectView.style.fontFamily = ''; exportProjectView.style.fontSize = ''; }

            // Reset Quiz State in export template
             exportDoc.querySelectorAll('.quiz-question').forEach(q => { q.classList.remove('answered', 'unanswered-highlight'); q.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected', 'correct', 'incorrect')); q.querySelectorAll('.quiz-feedback').forEach(f => f.style.display = 'none'); });
            exportDoc.querySelector('.final-quiz-result')?.remove();
            const exportSubmitBtn = exportDoc.querySelector('#project-view #submitQuizBtn');
            if(exportSubmitBtn) exportSubmitBtn.disabled = false;

            // Remove ALL scripts from template
            exportDoc.querySelectorAll('script').forEach(script => script.remove());

            // Create Viewer Script (MINIFIED - ensure it matches function names and data structure)
             // NOTE: This minified script is based on the logic above. If you make significant JS changes, regenerate/test this.
             const courseDataString = JSON.stringify(courseData).replace(/</g, '\\u003c').replace(/>/g, '\\u003e');
             const viewerScript = document.createElement('script');
             viewerScript.textContent = `
 const courseDataForView=${courseDataString};let currentSlideIndex=0,currentProjectIdForView=null;function shuffleArray(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}}function hexToRgb(h){let r=/^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(h);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null}function areColorsEqual(c1,c2){if(!c1||!c2)return c1===c2;if(c1.toLowerCase()===c2.toLowerCase())return!0;const cvt=c=>{const x=document.createElement('canvas').getContext('2d');if(!x)return null;x.fillStyle=c;const cc=x.fillStyle;if(cc.startsWith('rgba'))return cc;if(cc.startsWith('#')){const r=hexToRgb(cc);return r?\`rgba(\${r.r},\${r.g},\${r.b},1)\`:null}if(cc.startsWith('rgb('))return cc.replace('rgb(','rgba(').replace(')',',1)');return cc};try{const r1=cvt(c1),r2=cvt(c2);return r1&&r2&&r1===r2}catch(e){return String(c1).trim().toLowerCase()===String(c2).trim().toLowerCase()}}function applyThemeClrs(p,s,a){const r=document.documentElement;const pp=p||'#00A9B5';const ss=s||'#FFC800';const aa=a||'#FF6F61';r.style.setProperty('--primary',pp);r.style.setProperty('--secondary',ss);r.style.setProperty('--accent',aa);const pr=hexToRgb(pp);if(pr)r.style.setProperty('--primary-rgb',\`\${pr.r},\${pr.g},\${pr.b}\`);const sr=hexToRgb(ss);if(sr)r.style.setProperty('--secondary-rgb',\`\${sr.r},\${sr.g},\${sr.b}\`)}function applyCourseThemeForView(){const cs=courseDataForView.style||{};applyThemeClrs(cs.primaryColor,cs.secondaryColor,cs.accentColor);const r=document.documentElement;r.style.setProperty('--base-font-family',"var(--font-body, 'Poppins', sans-serif)");r.style.setProperty('--base-font-size',"var(--base-font-size, 16px)");const pv=document.getElementById('project-view');if(pv){pv.style.fontFamily='';pv.style.fontSize=''}}function applyProjectStylesForView(p){if(!p)return;const ps=p.style||{};const cs=courseDataForView.style||{};applyThemeClrs(ps.primaryColor||cs.primaryColor,ps.secondaryColor||cs.secondaryColor,ps.accentColor||cs.accentColor);const pv=document.getElementById('project-view');if(pv){pv.style.fontFamily=ps.fontFamily||'var(--base-font-family)';let ef='var(--base-font-size)';if(ps.baseSize==='small')ef='14px';else if(ps.baseSize==='large')ef='18px';else if(ps.baseSize==='medium')ef='16px';pv.style.fontSize=ef}}function showCourseView(){document.getElementById('course-view').style.display='block';document.getElementById('project-view').style.display='none';currentProjectIdForView=null;document.title=courseDataForView.title||"Fun Learning Adventures!";applyCourseThemeForView();renderCoursePageForView();window.scrollTo(0,0)}function showProjectView(pid){const p=courseDataForView.projects.find(pr=>pr.id===pid);if(!p){showCourseView();return}currentProjectIdForView=pid;renderProjectPageForView(p);document.getElementById('course-view').style.display='none';document.getElementById('project-view').style.display='block';document.title=p.projectTitle||"Adventure Time!";applyCourseThemeForView();applyProjectStylesForView(p);window.scrollTo(0,0);try{history.pushState({projectId:pid},p.projectTitle||'',\`#project-\${pid}\`)}catch(e){}}window.onpopstate=function(e){if(e.state&&e.state.projectId){showProjectView(e.state.projectId)}else{showCourseView()}};function renderCoursePageForView(){const c=courseDataForView;document.getElementById('courseTitle').textContent=c.title;const i=document.getElementById('courseImage');if(i){i.src=c.imageUrl||'';i.alt=c.title+" Image"}document.getElementById('courseDescription').textContent=c.description;const g=document.getElementById('projectGrid');g.innerHTML='';if(!c.projects||c.projects.length===0){g.innerHTML='<p style="text-align:center;color:#666;font-style:italic;">No adventures added yet.</p>';return}c.projects.forEach(p=>{if(!p||!p.id)return;const t=document.createElement('a');t.className='project-tab';t.href=\`#project-\${p.id}\`;t.onclick=e=>{e.preventDefault();showProjectView(p.id)};t.innerHTML=\`<img src="\${p.tabImage||'https://via.placeholder.com/300x180/00A9B5/fff?text=Adventure!'}" alt="\${p.tabName||'Adventure Card'}" loading="lazy"><div class="project-tab-info"><span>\${p.tabName||'Unnamed Adventure'}</span></div>\`;if(p.isCompleted){const b=document.createElement('span');b.className='completion-badge';b.setAttribute('aria-label','Completed');b.title='Adventure Completed!';t.appendChild(b)}g.appendChild(t)})}
 function renderProjectPageForView(p){if(!p)return;const pv=document.getElementById('project-view');if(!pv)return;const h=pv.querySelector('#project-header');if(h){h.querySelector('#projectImage').src=p.projectHeaderImage||p.tabImage||'https://via.placeholder.com/110x110/00A9B5/fff?text=🚀';h.querySelector('#projectImage').alt=p.projectTitle+" Header";h.querySelector('#projectTitle').textContent=p.projectTitle||'Adventure Title';h.querySelector('#projectSubtitle').textContent=p.projectSubtitle||''}const ct=pv.querySelector('#projectTabContentContainer');if(!ct)return;const ov=ct.querySelector('#overview');if(ov){ov.querySelector('#overviewText').textContent=p.overviewText||'No mission details yet!';renderLearnItemsForProjectView(p.learnData||[],ov.querySelector('#learnContainer'))}const vd=ct.querySelector('#video');if(vd){vd.querySelector('#videoIntroText').textContent=p.videoIntroText||'';vd.querySelector('#videoTitle').textContent=p.videoTitle||'';vd.querySelector('#mainVideo').src=p.videoUrl||'';const ul=vd.querySelector('#videoKeyPoints');ul.innerHTML='';(p.videoKeyPoints||[]).forEach(pt=>{if(pt&&pt.trim())ul.innerHTML+=\`<li>\${pt.trim()}</li>\`});if(!ul.innerHTML)ul.innerHTML='<li style="color:#888;font-style:italic;list-style-type:none;">No discoveries listed.</li>'}const sl=ct.querySelector('#slides');if(sl)renderSlideshowForProjectView(p.slidesData||[],sl.querySelector('#slideshowContainer'));const ch=ct.querySelector('#challenges');if(ch)renderChallengesForProjectView(p.challengesData||[],ch.querySelector('#challengesContainer'));const qz=ct.querySelector('#quiz');if(qz)renderQuizForProjectView(p.quizData||[],qz.querySelector('#quizContainer'),qz.querySelector('#submitQuizBtn'));const tb=pv.querySelector('#projectTabs');const ftb=tb?.querySelector('.tab');if(ftb){const tId=ftb.getAttribute('data-tab-id')||'overview';openProjectTab(tId,ftb)}else{updateProjectProgressBar('')}}function renderMedia(typ,url,tit){if(!url||!typ||typ==='none')return'';if(typ==='image')return\`<img src="\${url}" loading="lazy" alt="\${tit||'Image'}">\`;if(typ==='video')return\`<iframe src="\${url}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="\${tit||'Video'}"></iframe>\`;return''}
 function renderLearnItemsForProjectView(d,c){if(!c)return;c.innerHTML='';const v=(d||[]).filter(i=>i.title&&i.title.trim());if(v.length===0){c.innerHTML='<p style="color:#888;font-style:italic;">No skills listed!</p>';return}v.forEach((i,x)=>{const el=document.createElement('div');el.className='step';el.innerHTML=\`<div class="step-number">\${x+1}</div><div class="step-content"><strong>\${i.title}</strong>\${i.description?\`<p class="description">\${i.description}</p>\`:''}<div class="step-media" style="display:none;"></div></div>\`;const md=el.querySelector('.step-media');const mu=renderMedia(i.mediaType,i.mediaUrl,i.title);if(mu){md.style.display='block';md.innerHTML=mu}c.appendChild(el)})}function renderChallengesForProjectView(d,c){if(!c)return;c.innerHTML='';const v=(d||[]).filter(i=>i.title&&i.title.trim());if(v.length===0){c.innerHTML='<p style="color:#888;font-style:italic;">No bonus challenges!</p>';return}v.forEach(i=>{const el=document.createElement('div');el.className='step';el.innerHTML=\`<div class="step-number">★</div><div class="step-content"><strong>\${i.title}</strong>\${i.description?\`<p class="description">\${i.description}</p>\`:''}<div class="step-media" style="display:none;"></div></div>\`;const md=el.querySelector('.step-media');const mu=renderMedia(i.mediaType,i.mediaUrl,i.title);if(mu){md.style.display='block';md.innerHTML=mu}c.appendChild(el)})}function renderSlideshowForProjectView(d,c){const n=c?.closest('.tab-content#slides')?.querySelector('.slide-nav');if(!c||!n){return}c.innerHTML='';const v=(d||[]).filter(s=>s.url&&s.url.trim());if(v.length===0){c.innerHTML='<p style="color:#888;font-style:italic;">No step-by-step guide!</p>';n.style.display='none';return}n.style.display='flex';v.forEach((s,x)=>{const sd=document.createElement('div');sd.className='slide';const ct=s.type==='image'?'image':'iframe';const u=s.url.trim();const ti=s.description||'Slide '+(x+1);sd.innerHTML=\`<div class="slide-content-wrapper"></div>\${s.description?\`<p class="slide-caption">\${s.description}</p>\`:''}\`;const w=sd.querySelector('.slide-content-wrapper');w.innerHTML=renderMedia(ct,u,ti);c.appendChild(sd)});currentSlideIndex=0;showSlide(0)}
 function renderQuizForProjectView(d,c,b){if(!c||!b)return;c.innerHTML='';c.closest('.tab-content#quiz')?.querySelector('.final-quiz-result')?.remove();b.disabled=!1;b.style.display='none';const v=(d||[]).filter(q=>q.questionText&&q.questionText.trim()&&q.correctAnswer&&q.correctAnswer.trim());if(v.length===0){c.innerHTML='<p style="color:#888;font-style:italic;">No quiz questions!</p>';return}b.style.display='block';v.forEach((q,x)=>{const dv=document.createElement('div');dv.className='quiz-question';dv.innerHTML=\`<p class="question-text">\${x+1}. \${q.questionText}</p><div class="quiz-options"></div><div class="quiz-feedback correct" style="display:none;">🎉 Correct! Good job!</div><div class="quiz-feedback incorrect" style="display:none;"></div>\`;const od=dv.querySelector('.quiz-options');let os=[q.correctAnswer.trim()];(q.incorrectAnswers||[]).forEach(a=>{if(a&&a.trim())os.push(a.trim())});shuffleArray(os);os.forEach(ot=>{const cr=ot===q.correctAnswer.trim();const oe=document.createElement('div');oe.className='quiz-option';oe.textContent=ot;oe.setAttribute('role','radio');oe.setAttribute('tabindex','0');oe.setAttribute('aria-checked','false');oe.onclick=()=>selectQuizOption(oe);oe.onkeydown=e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();selectQuizOption(oe)}};oe.setAttribute('data-is-correct',cr.toString());od.appendChild(oe)});c.appendChild(dv)})}
 function openProjectTab(tn,el){const c=document.getElementById('projectTabContentContainer');if(!c)return;c.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));const bs=document.getElementById('projectTabs');if(bs)bs.querySelectorAll('.tab').forEach(b=>{b.classList.remove('active');b.setAttribute('aria-selected','false');b.setAttribute('tabindex','-1');});const t=c.querySelector('#'+tn);if(t){t.classList.add('active');t.setAttribute('tabindex','0');}if(el){el.classList.add('active');el.setAttribute('aria-selected','true');el.setAttribute('tabindex','0');}updateProjectProgressBar(tn)}function updateProjectProgressBar(tn){const p=document.getElementById('progressBar');if(!p)return;let r=0;const o=['overview','video','slides','challenges','quiz'];const i=o.indexOf(tn);if(i>=0)r=((i+1)/o.length)*100;p.style.width=r+'%';p.setAttribute('aria-valuenow',Math.round(r))}function showSlide(n){const s=document.querySelectorAll('#project-view #slideshowContainer .slide');const c=s.length;if(c===0)return;s.forEach(sl=>sl.classList.remove('active'));currentSlideIndex=(n%c+c)%c;if(s[currentSlideIndex])s[currentSlideIndex].classList.add('active')}function nextSlide(){showSlide(currentSlideIndex+1)}function prevSlide(){showSlide(currentSlideIndex-1)}function selectQuizOption(oe){const qd=oe.closest('.quiz-question');if(!qd||qd.classList.contains('answered'))return;qd.querySelectorAll('.quiz-option').forEach(o=>{o.classList.remove('selected');o.setAttribute('aria-checked','false');});oe.classList.add('selected');oe.setAttribute('aria-checked','true')}function markProjectAsCompletedInView(pid){const p=courseDataForView.projects.find(pr=>pr.id===pid);if(p&&!p.isCompleted)p.isCompleted=!0}
 function submitQuiz(){const qs=document.querySelectorAll('#project-view #quizContainer .quiz-question');let an=0,sc=0;const tt=qs.length;if(tt===0)return;let fu=null;qs.forEach(q=>{const s=q.querySelector('.quiz-option.selected');q.classList.remove('answered','unanswered-highlight');q.querySelectorAll('.quiz-feedback').forEach(f=>f.style.display='none');q.querySelectorAll('.quiz-option').forEach(o=>{o.classList.remove('correct','incorrect');o.style.opacity='1';o.style.cursor='pointer';o.setAttribute('aria-checked','false');o.onclick=()=>selectQuizOption(o);o.onkeydown=e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();selectQuizOption(o)}}});if(s)an++;else if(!fu)fu=q});if(an<tt){alert('Oops! Please answer all '+tt+' questions first! 😉');if(fu){fu.scrollIntoView({behavior:'smooth',block:'center'});fu.classList.add('unanswered-highlight');setTimeout(()=>{fu?.classList.remove('unanswered-highlight')},2500)}return}qs.forEach(q=>{const s=q.querySelector('.quiz-option.selected');const fc=q.querySelector('.quiz-feedback.correct');const fi=q.querySelector('.quiz-feedback.incorrect');const ao=q.querySelectorAll('.quiz-option');q.classList.add('answered');const isc=s.getAttribute('data-is-correct')==='true';ao.forEach(o=>{const oc=o.getAttribute('data-is-correct')==='true';if(oc)o.classList.add('correct');if(o===s&&!isc)o.classList.add('incorrect');o.setAttribute('tabindex','-1');o.style.cursor="default";o.onclick=null;o.onkeydown=null});if(isc){sc++;if(fc)fc.style.display='block'}else{if(fi){const co=q.querySelector('.quiz-option.correct');fi.textContent=\`🤔 Not quite! The correct answer was: "\${co?co.textContent:'N/A'}". Keep trying!\`;fi.style.display='block'}}});const b=document.querySelector('#project-view #submitQuizBtn');if(b)b.disabled=!0;const qc=document.querySelector('#project-view #quiz');let rd=qc?.querySelector('.final-quiz-result');if(!rd&&qc){rd=document.createElement('div');qc.appendChild(rd)}if(rd){const pc=tt>0?Math.round((sc/tt)*100):0;const ps=pc>=70;let rm=ps?'🌟 Awesome! You passed! ':'👍 Good effort! ';rd.textContent=\`\${rm} Score: \${sc}/\${tt} (\${pc}%).\`;rd.className='final-quiz-result '+(ps?'success':'fail');rd.style.display='block';rd.scrollIntoView({behavior:'smooth',block:'center'});if(ps&&currentProjectIdForView)markProjectAsCompletedInView(currentProjectIdForView)}}
 document.addEventListener('DOMContentLoaded',()=>{applyCourseThemeForView();renderCoursePageForView();let dsp=!1;if(window.location.hash&&window.location.hash.startsWith('#project-')){const pid=window.location.hash.substring(9);if(courseDataForView.projects.some(p=>p.id===pid)){showProjectView(pid);dsp=!0}}if(!dsp)showCourseView();console.log("Exported Viewer Ready!");});
            `;
             exportDoc.querySelector('body').appendChild(viewerScript);

             // Generate and Download
             const htmlContent = '<!DOCTYPE html>\n' + exportDoc.outerHTML;
             const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
             const downloadUrl = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = downloadUrl;
             const filename = (courseData.title || "course_export").replace(/[^\w\s.-]/gi,'').replace(/\s+/g,'_').toLowerCase() + '.html';
             a.download = filename;
             document.body.appendChild(a); a.click(); document.body.removeChild(a);
             URL.revokeObjectURL(downloadUrl);
             console.log("K12 Course export done.");

        } catch (error) {
            console.error("Error during K12 export:", error);
            alert("Oh no! Export failed. Check the console?");
        }
    }

    // --- INITIAL PAGE LOAD (Editor Mode) ---
    document.addEventListener('DOMContentLoaded', function() {
        console.log("K12 Course Editor/Viewer Loading...");
        applyCourseTheme();
        renderCoursePage(); // Use K12 renderer

        // Hash check for deep linking (remains same)
        let displayedProject = false;
        if (window.location.hash && window.location.hash.startsWith('#project-')) {
            const pid = window.location.hash.substring(9);
            if (courseData.projects.some(p => p.id === pid)) {
                showProjectView(pid);
                displayedProject = true;
            }
        }
        if (!displayedProject) showCourseView();
        console.log("Ready to learn and create!");
    });

</script>

</body>
</html>
